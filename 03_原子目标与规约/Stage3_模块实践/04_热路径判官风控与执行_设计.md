# L3 · Stage3-04 热路径（判官+风控+执行）设计

> [!NOTE] **[TRACEBACK] 原子规约锚点**
> - **09_ 可部署单元**: [热路径 D+E+F 同进程同镜像](../_共享规约/09_核心模块架构规约.md#热路径同进程def)
> - **05_ 对应项**: PyPortfolioOpt、Vn.py（见 01_顶层概念/05_谛听优先借鉴的十大开源选型）
> - **原子规约**: [09_核心模块架构规约](../_共享规约/09_核心模块架构规约.md)、[01_核心公式与MoE架构规约](../_共享规约/01_核心公式与MoE架构规约.md)、[05_接口抽象层规约](../_共享规约/05_接口抽象层规约.md)
> - **DNA**: 04_dna_热路径判官风控与执行.yaml、core_modules/dna_module_d/e/f.yaml
> - **L4 实践**: 04_热路径判官风控与执行_实践.md
> - **L5 锚点**: l5-stage-stage3_04、l5-mod-D/E/F

<a id="design-stage3-04-goal"></a>
## 本步目标

在一个实践步骤内完成**热路径**可部署单元：Module D 判官 + Module E 风控盾 + Module F 执行网关，同进程、同镜像交付；满足 09_ 规定的「热路径同进程」与延迟约束；D/E/F 三项 100% 验证及全链路 A→F 在本步准出时完成。

<a id="design-stage3-04-points"></a>
## 设计要点（D+E+F 一体）

- **判官（D）**：投票机制（Quant+Expert）、动态凯利、现金拖累监控、防御性复利；Alpha 与 01_ 核心公式一致；双轨分流见 09_。
- **风控（E）**：硬止损 2%、盈亏比≥1.5、组合相关性/Domain 上限；与 D 输出、F 输入衔接。
- **执行（F）**：Broker 抽象、Redis Streams、OMS Lite、Human-in-the-Loop；占位/仿真可验证。
- **同进程**：D→E→F 顺序、同步、同镜像构建与部署；见 global_const.deployable_units.hot_path_def。

<a id="design-stage3-04-dna-keys"></a>
## 本步落实的 _System_DNA 键

- core_modules/dna_module_d.yaml、dna_module_e.yaml、dna_module_f.yaml；core_formula、constraints；abstraction_layer.broker_driver。

<a id="design-stage3-04-integration-pfo"></a>
### 逻辑填充期开源接入点：PyPortfolioOpt（判官层）

- **实践重点**：「买多少」闭环由判官层完成；MoE 候选标的后用 PyPortfolioOpt 做组合优化，再与动态凯利或现金拖累结合。
- **依赖与构建**：requirements/Dockerfile 显式声明并安装 pyportfolioopt；判官相关单测在镜像内可运行。
- **验收**：判官输出权重与 PyPortfolioOpt 参考结果一致或误差在约定范围。

<a id="design-stage3-04-integration-vnpy"></a>
### 逻辑填充期开源接入点：Vn.py（执行层）

- **实践重点**：Gateway 式抽象；占位/仿真 Broker 必须实现，便于 E→F 与全链路验证。
- **依赖与构建**：requirements 显式声明 Vn.py 或 Gateway 相关包；place_order 占位/仿真单测在镜像内可运行。
- **验收**：place_order 经 BrokerDriver 可验证；单测覆盖「下单→状态回调」；实盘对接见 Stage4-02 ModuleF 执行网关接入设计。

<a id="design-stage3-04-exit"></a>
## 准出

热路径 D+E+F 四项 100%；判官+风控+执行与 09_、01_、05_ 一致；全链路 A→F 验证通过；L5 l5-stage-stage3_04、l5-mod-D/E/F 可更新。
