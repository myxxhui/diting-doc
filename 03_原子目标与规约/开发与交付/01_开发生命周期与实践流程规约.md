# L3 · 开发生命周期与实践流程规约

> [!NOTE] **[TRACEBACK] 原子规约锚点**
> - **顶层概念**: [一句话定义与核心价值](../../01_顶层概念/01_一句话定义与核心价值.md)
> - **战略维度**: [01_开发与交付流程维度](../../02_战略维度/开发与交付/01_开发与交付流程维度.md)
> - **对应 DNA**: `_System_DNA` 下 `dev_lifecycle`（待补充时可先不写入 global_const.yaml）
> - **本文档**: L3 层级，定义开发生命周期与实践流程规约

## 一、与三级流水线的边界

- **本规约**定义 **开发生命周期**：从零到「可首次提交并进入流水线」的环境阶段顺序与过渡时机。
- **[03_架构设计共识与协作元规则](../03_架构设计共识与协作元规则.md)** 中的「三级流水线」（B. 金融级 GitFlow）定义 **提交/发布** 后的验证与部署：
  - **Level 1**：`git commit` 触发，运行单元测试（Table-Driven Tests）；
  - **Level 2**：Merge to `develop`，部署到 Staging（Spot ECS），仿真回放；
  - **Level 3**：Tag Release + 人工审批，部署到 Prod（K3s）。
- **衔接点**：生命周期中「K3s 测试开发期」准出且满足本规约定义的验收后，代码/镜像可进入三级流水线的 Level 2/3；在此之前，开发在本地/Docker/K3s 测试环境中迭代，不直接触发 Level 2/3。

---

## 二、环境阶段定义

| 阶段 | 名称 | 目标 |
|------|------|------|
| **阶段 0** | 本地骨架期 | 可运行的代码骨架（目录、接口、占位实现），本地单测可绿 |
| **阶段 1** | 逻辑填充期 | 在骨架上按 L3 规约与 5D 填充业务逻辑，本地单测 + 必要集成测试可绿 |
| **阶段 2** | Docker 统一环境期 | 用 Docker（含 docker-compose 或等价）统一基础环境与服务依赖，在容器内跑开发与测试，与「本机裸跑」脱钩 |
| **阶段 3** | K3s 测试开发期 | 在 K3s 上跑测试/开发用部署（非生产），验证编排、Secret、网络策略等，与最终 K3s 生产环境一致 |
| **阶段 4** | 与发布流水线衔接 | 产出满足三级流水线入口要求（见 03 文档），进入 Level 1/2/3 |

---

## 三、第一步与顺序决策

**执行顺序**：**执行时第一步为 Stage1-01 三位一体仓库初始化**；执行顺序的权威来源为 [04_阶段规划与实践/README](../../04_阶段规划与实践/README.md) 与 [dna_dev_workflow.yaml](../../_System_DNA/dna_dev_workflow.yaml) 的 workflow_stages。

**决策**：在「仓库与 L3 就绪」之后，第一步为「代码骨架 + 本地验证」，而非「先自动化创建 ECS」。

**理由**：
- 先骨架可快速验证架构与接口是否可行，避免云资源就绪后大规模返工。
- IaC/ECS 在「Docker 统一环境期」或「K3s 测试开发期」前/中引入即可，具体由 L4 步骤定。

**例外与审批**：若项目确需先有 ECS 才能联调（如依赖特定云服务），须在 ADR 中说明理由并标注「开发生命周期例外」，经架构师或负责人审批后执行；本规约默认顺序仍为推荐路径。

---

## 四、各阶段准入/准出条件与建议测试类型

| 阶段 | 准入条件 | 准出条件 | 建议测试类型 |
|------|----------|----------|--------------|
| **阶段 0：本地骨架期** | 项目已具备 L3 规约与仓库结构（见 [02_三位一体仓库规约](../_共享规约/02_三位一体仓库规约.md)） | 核心接口存在且本地单测通过；目录与占位实现可运行 | 单元测试（Table-Driven Tests，与 [03_架构设计共识](../03_架构设计共识与协作元规则.md) 一致） |
| **阶段 1：逻辑填充期** | 阶段 0 准出 | 业务逻辑按 L3 规约与 5D 填充完毕；本地单测 + 必要集成测试通过 | 单元测试 + 集成测试（边界与关键路径） |
| **阶段 1b：Mock 数据验证准出** | 阶段 1 核心链路已实现、可被 Mock 驱动 | 在 MockBroker/MockBrain 下跑通核心路径；Table-Driven Tests 及约定集成测试通过；无真实券商/LLM 调用 | 单元测试 + 集成测试（Mock 驱动） |
| **阶段 2：Docker 统一环境期** | 阶段 1 或 1b 准出，或当「多人/CI 需要统一环境」时 | 所有开发与测试可在容器内完成；Dockerfile/docker-compose 可复现环境；`make build`、`make test-docker` 通过 | 单测 + 集成测试均在容器内执行 |
| **阶段 3：K3s 测试开发期** | 阶段 2 准出，或当「需要验证 K3s 编排/网络/存储」时 | 在 K3s 上可部署并跑通测试/开发用 workload；编排、Secret、网络策略与生产一致（非生产命名空间） | 集成测试 + E2E/仿真（可选） |
| **阶段 4：与流水线衔接** | 阶段 3 准出 | 代码/镜像满足三级流水线 Level 1 入口要求（Table-Driven Tests、边界条件覆盖）；可进入 merge develop / tag 流程 | 与 03 文档中 Level 1/2/3 的验收一致 |

---

## 五、过渡时机（何时 Docker、何时 K3s）

- **引入 Docker**：逻辑填充期准出后、或当「多人协作/CI 需要统一环境」时。以规约为准，不写具体日期；L4 步骤可标注「本步骤完成即达到引入 Docker 条件」。
- **引入 K3s 测试开发**：Docker 期准出后、或当「需要验证 K3s 编排、网络、存储或与生产一致的行为」时。建议至少在与「Phase0-Infra」或等价基础设施准备相关的 L4 步骤完成后再上 K3s，具体由 L4 与 ADR 约定。

---

## 六、与业务阶段（Phase0/1/2）的对应关系

| 业务阶段（L4） | 对应开发生命周期环境阶段 | 说明 |
|----------------|--------------------------|------|
| **Phase0-Infra** | 阶段 0（骨架）+ 部分阶段 2（Docker/IaC 准备）或阶段 3 准备 | 基础设施与仓库骨架、可选 IaC；可与「本地骨架期」并行或在其后 |
| **Phase1-xxx** | 阶段 1（逻辑填充）+ 阶段 1b（Mock 验证，可选）+ 阶段 2（Docker 统一环境） | 核心业务逻辑填充；Mock 验证通过后再构建镜像；在 Docker 内完成开发与测试 |
| **Phase2-xxx** | 阶段 3（K3s 测试开发）+ 阶段 4（与流水线衔接） | 在 K3s 上验证部署与行为，满足三级流水线入口后进入 Level 2/3 |

新建或拆分 L4 Phase 时，须标明该 Phase 对应本规约的哪一环境阶段，避免「只写业务功能、不写环境阶段」的断层。

### 按功能模块分阶段开发

代码开发**不是单一阶段**，须按功能模块拆成多子阶段，每子阶段对应明确模块与测试/部署形态。下表供 L4 与 DNA 的 workflow_stages 对齐使用。

| 功能模块（[09_核心模块架构规约](../_共享规约/09_核心模块架构规约.md) Module A–F） | 建议实现阶段 | 验证方式 | 何时引入镜像 | 何时首次上 K3s |
|--------------------|-------------|---------|-------------|----------------|
| Module A/B 骨架 | 阶段 0～1 | 本地单测、Mock 集成 | 阶段 1b 或 2 准出后 | 阶段 3 |
| Module D 判官、Module E 风控占位 | 阶段 1 | 本地单测 + 集成测试 | 阶段 1b 准出后 | 阶段 3 |
| Module C 议会、Module F 执行网关 | 阶段 1 后期～2 | 集成测试、Docker 内测试 | 阶段 2 准出后 | 阶段 3 |
| 全链路 Mock 验证 | 阶段 1b | MockBroker/MockBrain 跑通、无真实券商/LLM | — | — |

具体模块与 stage 的映射以 DNA 的 `module_to_stages` 或 L4 Phase README 为准。

---

## 七、测试-开发循环

- **本地（阶段 0/1）**：以单元测试为主，须符合 [03_架构设计共识](../03_架构设计共识与协作元规则.md) 中的 Table-Driven Tests 与 100% 边界条件覆盖要求；逻辑密集处须遵循 5D（Design-Drive-Decompose-Defense）。
- **Mock 验证（阶段 1b）**：在 MockBroker/MockBrain 下跑通核心路径，无真实券商/LLM 调用；通过后再进入镜像构建与 Docker/K3s 阶段。
- **Docker（阶段 2）**：单测 + 集成测试均在容器内执行（`make test-docker`），确保环境一致、可复现。
- **K3s（阶段 3）**：集成测试 + 可选 E2E/仿真，验证编排与生产一致行为。
- 本规约未覆盖的测试细节（如具体用例、覆盖率阈值）以 03_架构设计共识与各 L3 能力规约为准。

### 回滚边界

- **K3s 测试开发期（阶段 3）内**：回滚由开发者本地决定（如重新部署上一镜像、或重新执行 deploy-engine）；不要求自动回滚或 2FA。
- **Level 2/3（提交后流水线）**：按 [03_架构设计共识](../03_架构设计共识与协作元规则.md) 的自动回滚/人工审批执行，与本阶段区分。

---

## 八、引用与合规

- **引用**：[02_三位一体仓库规约](../_共享规约/02_三位一体仓库规约.md)（Repo 结构、Dockerfile 与 Makefile 约定）、[03_架构设计共识与协作元规则](../03_架构设计共识与协作元规则.md)（三级流水线、ADR、5D）、[01_需求与产品范围](../产品设计/01_需求与产品范围.md)（Phase 功能范围与阶段目标）。
- **Makefile 契约**：diting-core 的 Makefile target 名称（如 `test`、`build`、`test-docker`）为**稳定契约**（见 02_三位一体仓库规约）；日后接入 CI 时 CI 只调用这些 target，不重复实现逻辑。可选 target：`lint`、`format`、`generate`（如 protoc/sql 生成），便于 L4 与未来 CI 一致。
- **合规**：本规约未覆盖的内容（如 ADR 触发场景、SemVer、部署 2FA）以 03 等为准；L4 实施步骤须符合本规约并可在步骤文档中引用本节或对应阶段表。Phase 的**功能范围与阶段目标**见 [01_需求与产品范围](../产品设计/01_需求与产品范围.md)，本规约只定义环境阶段与流程顺序。

---

## 下一步

→ 参见 [04_阶段规划与实践/](../../04_阶段规划与实践/) 目录下的阶段实践文档；新建或拆分 Phase 时须标明对应开发生命周期的环境阶段（骨架/逻辑填充/Docker/K3s）。
