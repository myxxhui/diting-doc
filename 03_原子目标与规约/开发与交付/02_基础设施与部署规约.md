# L3 · 基础设施与部署规约

> [!NOTE] **[TRACEBACK] 原子规约锚点**
> - **顶层概念**: [一句话定义与核心价值](../../01_顶层概念/01_一句话定义与核心价值.md)
> - **战略维度**: [01_开发与交付流程维度](../../02_战略维度/开发与交付/01_开发与交付流程维度.md)、[03_数据架构与分层存储维度](../../02_战略维度/产品设计/03_数据架构与分层存储维度.md)
> - **原子能力**: [02_三位一体仓库规约](../_共享规约/02_三位一体仓库规约.md)（diting-infra 职责）
> - **对应 DNA**: `_System_DNA/global_const.yaml` 中 `trinity_repos.repo_a`、部署相关键

## 一、部署方式

- **当前阶段**：不依赖云端 CI；在 **diting-infra** 目录下通过调用 **deploy-engine**（CLI 或 Makefile 封装）完成 dev/prod 的 Up/Down。
- **diting-infra 职责**：仅提供 diting 项目 Chart（应用 + 依赖中间件）+ 基础设施与环境配置；**不在此仓实现** Terraform/Helm 执行逻辑，由 deploy-engine 执行。
- **未来**：接入 CI 时可由 commit/merge/tag 触发 deploy-engine，规约目标不变。

---

## 二、deploy-engine 依赖方式

约定采用以下方式之一（在 diting-infra README 或 DNA 中写明）：

| 方式 | 约定 |
|------|------|
| **Git Submodule** | deploy-engine 以 submodule 形式置于 diting-infra，如 `diting-infra/deploy-engine/`；执行时使用该路径下的二进制或 Makefile。 |
| **PATH + 版本** | deploy-engine 在 PATH 中可用，版本 ≥ 约定值（如 `x.y.z`）；在 README 或 `_System_DNA` 中写 `deploy_engine_version`。 |

diting-doc 仅描述上述语义与可选范围；**配置真相源**为 diting-infra 仓库中的配置文件；配置结构或关键字段变更时需同步更新本规约或 diting-doc 的「部署配置说明」章节。

### diting-infra 调用 deploy-engine 的约定

- **工作目录**：从 diting-infra 根目录执行封装命令（如 `make deploy-dev`），或进入 deploy-engine 子目录（如 `diting-infra/deploy-engine/`）后执行 deploy-engine 的 Makefile；具体以 diting-infra README 或 Makefile 为准。
- **配置路径**：config 真相源在 diting-infra，调用时通过参数传入 deploy-engine，例如 `-config=../config/environments/dev/deploy.yaml`（当在 deploy-engine 子目录执行时）或由 diting-infra 的 Make 目标将绝对路径/相对路径传给 deploy-engine。
- **示例**：子项目以 Git submodule 引用 deploy-engine 时，可在 diting-infra 根目录提供 `make deploy-dev`，内部 `cd deploy-engine && ./bin/deploy-engine -cmd=deploy -config=../config/environments/dev/deploy.yaml -state=... -env=dev -project=diting -root=$$(pwd)`；或使用 deploy-engine 的 Makefile 并传入 CONFIG_FILE 指向 diting-infra 的 YAML。

---

## 三、diting-infra 配置结构

- **必须符合** deploy-engine 的 **DeploymentConfig**（参见 deploy-engine 仓库 `pkg/config/spec.go`）：
  - **DeploymentConfig**：`deployment_id`、`provider_name`、`default` / `env` / `user_override` 三层合并。
  - **LayerConfig**：`resource`（BaseResourceSpec）、`env`（BaseEnvSpec）、`deployment`（DeploymentSpec）。
  - **DeploymentSpec**：`chart_path`、`values`、`values_files`、`release_name`、`namespace` 等。
- **配置真相源（方案 A）**：diting-infra 仅维护**一个**部署配置文件，格式 **YAML**，路径示例 `config/environments/dev/deploy.yaml`（或 `config/environments/prod/deploy.yaml`），该文件内包含完整的 default/env/user_override 结构；不再要求单独的 `config/default.json` 为必选（若保留则仅作文档或模板用途）。
- **目录建议**：
  - `charts/` 或 `helm/`：diting 应用及依赖中间件 Chart。
  - `config/environments/{dev,prod}/deploy.yaml`：环境部署配置（单一 YAML，符合 DeploymentConfig）。
- 仅定义 Chart、基础资源、环境（dev/prod）配置；不在此仓实现编排执行逻辑。

---

## 四、镜像标签策略

| 环境 | 标签策略 | 说明 |
|------|----------|------|
| **dev** | `latest` 或 `git-sha` | 便于快速迭代；由 config/values 注入，不写死在 Chart。 |
| **prod** | SemVer（如 `1.2.3`） | 与 [03_架构设计共识](../03_架构设计共识与协作元规则.md) 的 SemVer 铁律一致。 |

diting-infra 的 values 中 `image.tag` 由 config/values 注入，不在 Chart 模板中写死。

### Release bundle 约定（多服务部署）

一次发布须使用**同一 release** 的全体镜像，避免版本漂移。

| 约定 | 说明 |
|------|------|
| **Release bundle** | 一次发布 = 一组镜像 tag（如同一 git SHA 或 SemVer）；DNA 或 diting-infra 中维护「本次发布包含 image_ingestion、image_module_a、…、image_hot_path」的清单。 |
| **兼容性** | 各可部署单元 API/Proto 版本须在兼容范围内；DNA 或 L3 可维护模块间兼容表（如 module_a v1 与 module_b v1 兼容）。 |
| **部署** | deploy-engine 或 Helm 部署时，使用同一 release 的全体镜像 tag；禁止混用不同 build 的镜像。 |

详见 `_System_DNA` 中 `release_bundle` 或 `deployable_units` 定义。

---

## 五、可观测性

- **dev 环境**：约定可观测范围（如仅日志 + 基础指标）；或与 prod 同 Chart、不同 values（如关闭部分采样、降低保留周期）。
- **prod**：按 L3 可观测性规约与战略维度执行；具体由 Chart 与 values 实现。

---

## 六、密钥与机密（Sealed-Secrets 先行）

- **当前阶段**：使用 **Sealed-Secrets** 实现关键参数加密；diting-infra 的 `secrets/` 描述为 Sealed-Secrets 的加密 YAML 或 Helm 引用，**不以 ESO 为必选**。
- **公钥存放（方案 A：进 Git）**：加密用公钥（证书）唯一来源为 diting-infra 的 `secrets/certs/sealed-secrets-public.pem`（或按环境 `sealed-secrets-public-dev.pem`、`sealed-secrets-public-prod.pem`）；仅公钥入仓，私钥禁止入 Git。详见 [Stage1-04 密钥与配置模板设计](../Stage1_仓库与骨架/04_密钥与配置模板设计.md#design-stage1-04-public-key)。
- **Sealed-Secrets sealing key 管理**：
  - 由集群管理员在**安全环境**中生成并备份；
  - **不进入 Git**；
  - 恢复集群时需用备份 key 恢复 Sealed-Secrets 控制器。
- **后期**：可引入 Vault 或 KMS/ESO；迁移时机与方案由 ADR 约定（见 [06_追溯与审计/ADR/](../../06_追溯与审计/ADR/)）。

---

## 七、应用层运行时与借鉴组件依赖（diting-core）

本节约定 diting-core 及采集/模块镜像的运行时与依赖，与 [01_顶层概念/05_谛听优先借鉴的十大开源选型](../../01_顶层概念/05_谛听优先借鉴的十大开源选型.md) 及 L3 各阶段设计「依赖与构建」、DNA `integration_packages` 一致。

### 7.1 Python 版本与 base 镜像

| 约定 | 说明 |
|------|------|
| **Python 版本** | 统一约定运行时 Python 版本（如 3.11）；各借鉴组件须在此版本下可安装、可运行。 |
| **base 镜像** | Dockerfile 中 base 镜像须显式指定（建议含 digest），避免漂移；示例：`python:3.11-slim@sha256:...`。 |

### 7.2 可部署单元与依赖归属

**约定**：依赖归属仅引用**步骤级 DNA**（dna_stage*、core_modules/dna_module_*），不引用规约级 dna_0X。

| 可部署单元 | 对应 DNA / 设计 | integration_packages 归属 |
|------------|-----------------|----------------------------|
| **采集镜像**（ingest） | Stage2-02、dna_stage2_02 | akshare、openbb-platform（见 dna_stage2_02.integration_packages） |
| **核心镜像**（diting-core，含 Module A～F） | Stage3 各 Module、dna_module_b/d/f 等 | TA-Lib、Qlib、VectorBT、Alphalens、pyportfolioopt、vnpy（见各 core_modules 与 stage DNA） |

当前阶段可采用**单一 diting-core 镜像**包含全部模块；若拆分为多镜像（如 scanner 独立），则各镜像的 Dockerfile/requirements 须与上述归属一致，且 L3 设计、DNA 中注明对应关系。

### 7.3 Dockerfile 分层与构建

| 约定 | 说明 |
|------|------|
| **依赖层优先** | 依赖安装（COPY requirements*.txt、RUN pip install）须在 **COPY 应用代码** 之前，以利用层缓存、减少代码变更导致的依赖层重建。 |
| **版本约束** | 借鉴组件的包名与版本约束须在 requirements 或 requirements.txt 中显式列出（如 `akshare>=x.y`）；具体版本以代码仓 requirements 或 requirements.lock 为单一真相源，DNA 可引用或与之一致。 |
| **镜像内验证** | 至少一次 CI（如 main/release 流水线）须在**完整构建的镜像内**执行 `make ingest-test`（采集）、`make test`（核心），保证依赖安装正确。 |

### 7.4 构建目标架构

| 约定 | 说明 |
|------|------|
| **默认架构** | 生产与 CI 默认构建目标为 **amd64**。 |
| **ARM 支持** | 开发环境若为 ARM（如 M1/M2），可在本地使用多阶段或多 arch 构建；TA-Lib 等 C 库在 ARM 上需对应系统包，Dockerfile 中可注明或提供 arm64 分支。 |

### 7.5 密钥与敏感信息（不入镜）

- **约定**：AkShare、OpenBB 等数据源若需 API Key/Token，**仅通过环境变量或 Sealed-Secrets 注入**，**不得写入镜像或代码仓**；Dockerfile 与应用启动时从环境读取，密钥管理见本规约「六、密钥与机密」。
- **可选**：发布镜像可产出 SBOM；CI 对关键依赖做 CVE 扫描并阻断高危，具体由项目或 diting-infra 约定。

### 7.6 离线部署（预留）

- 若部署环境为**内网/离线**，须使用私有 PyPI 或预打包 wheel（如 `--find-links` 指向内网目录）；依赖列表以 requirements 或 DNA `integration_packages` 为准，预打包与安装方式由运维与 diting-infra 约定。

---

## 八、引用与合规

- **引用**：[02_三位一体仓库规约](../_共享规约/02_三位一体仓库规约.md)（repo_a）、[01_开发生命周期与实践流程规约](01_开发生命周期与实践流程规约.md)（阶段 3 部署验收）、[05_安全与机密治理维度](../../02_战略维度/产品设计/05_安全与机密治理维度.md)、[05_谛听优先借鉴的十大开源选型](../../01_顶层概念/05_谛听优先借鉴的十大开源选型.md)。
- **合规**：L4 部署步骤（如 [Stage2_数据采集与存储](../../04_阶段规划与实践/Stage2_数据采集与存储/README.md)、[Stage3_模块实践](../../04_阶段规划与实践/Stage3_模块实践/README.md) 中的 K3s/部署相关步骤）须在本规约约束下执行；验收为 deploy-engine Up 成功、KubeConfig 可用 / Helm release 存在；借鉴组件依赖与构建验收见 L5 [02_验收标准](../../05_成功标识与验证/02_验收标准.md) 对应行。
