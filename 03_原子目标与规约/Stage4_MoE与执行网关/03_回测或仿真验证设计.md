# L3 · Stage4-03 回测或仿真验证设计

> [!NOTE] **[TRACEBACK] 原子规约锚点**
> - **战略维度**: [研产同构维度](../../02_战略维度/产品设计/06_研产同构维度.md)
> - **原子规约**: [开发与交付/01_开发生命周期与实践流程规约](../开发与交付/01_开发生命周期与实践流程规约.md)
> - **DNA**: [_System_DNA/Stage4_MoE与执行网关/dna_stage4_03.yaml](../_System_DNA/Stage4_MoE与执行网关/dna_stage4_03.yaml)
> - **L4 实践**: [04_阶段规划与实践/Stage4_MoE与执行网关/03_回测或仿真验证](../../04_阶段规划与实践/Stage4_MoE与执行网关/03_回测或仿真验证.md#l4-stage4-03-exit)
> - **L5 锚点**: [02_验收标准#l5-stage-stage4_03](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage4_03)

<a id="design-stage4-03-goal"></a>
## 本步目标

Docker/K3s 下回测或仿真路径跑通；回测/仿真任务成功；Stage4 准出。

<a id="design-stage4-03-points"></a>
## 设计要点

- **运行形态**：回测（单进程+历史数据）或仿真（占位 Broker）
- **环境**：Docker 或 K3s 下可运行
- **验证**：回测/仿真任务成功

<a id="design-stage4-03-integration-lean"></a>
### 逻辑填充期架构参照：Lean（QuantConnect）四层解耦与仿真度

不要求「接入 Lean 代码库」，而是将 [Lean/QuantConnect](https://github.com/QuantConnect/Lean) 的 **Universe Selection → Alpha Model → Portfolio Construction → Execution Model** 四层解耦与谛听现有模块（A/B/C/D/E/F）做映射，并在回测/仿真实现中遵守同一职责边界；同时明确回测的**仿真度**（时间粒度、滑点、手续费、分红拆股等），以控制回测与实盘偏差。与 [01_顶层概念/05_谛听优先借鉴的十大开源选型](../../01_顶层概念/05_谛听优先借鉴的十大开源选型.md) 一致。

- **实践重点**：四层与 Module A～F 的职责映射；回测/仿真路径的「阶段划分」与「仿真度选项」在设计中标明，便于后续与 Lean 级标准对齐。
- **详细需求**：
  - **四层与模块映射**：Universe Selection 对应 Module A + B 的标的池与过滤；Alpha Model 对应 Module B 信号 + Module C 专家输出；Portfolio Construction 对应 Module D 判官（PyPortfolioOpt + Kelly）；Execution Model 对应 Module E 风控通过后的执行逻辑与 Module F。文档中给出映射表与数据流。
  - **仿真度要求**：列出本阶段回测/仿真必须支持的选项：时间粒度（日/Tick）、滑点模型、手续费率、公司行动（分红、拆股）是否调整价格/仓位；与 09_、研产同构规约的对应关系。
  - **当前级别与可升级项**：设计中标明「当前实现满足的仿真度级别」与「后续可升级的仿真度项（如 Tick、更多公司行动）」。
  - **回测确定性**：回测须**设随机种子**（如 NumPy/Python random seed、Qlib/VectorBT 等组件的 seed 参数），保证同一配置多次运行结果可复现；验收时须验证「相同输入 + 相同 seed → 相同输出」。
- **验收要点**：回测或仿真任务在 Docker/K3s 下可运行；回测结果可复现；设计文档中明确当前仿真度级别与可升级项。若需统一入口，见 [09_核心模块架构规约](../_共享规约/09_核心模块架构规约.md) 中「回测/仿真引擎职责与仿真度」小节（可选）。

<a id="design-stage4-03-dna-keys"></a>
## 本步落实的 _System_DNA 键

- `dna_stage4_03.yaml`

<a id="design-stage4-03-exit"></a>
## 准出

回测或仿真验证通过；Stage4 准出；L5 [l5-stage-stage4_03](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage4_03) 可更新。
