# Stage2-02 采集逻辑与 Dockerfile
stage_id: "stage2_02"
name: "采集逻辑与Dockerfile"
design_doc: "03_原子目标与规约/Stage2_数据采集与存储/02_采集逻辑与Dockerfile设计.md"
l4_practice_doc: "04_阶段规划与实践/Stage2_数据采集与存储/02_采集逻辑与Dockerfile.md"
work_dir:
  type: "repo_i"
  repo_ref: "repo_i"
  description: "diting-core"
# 交付范围：逻辑填充期接入点实现细节见 logic_fill_design_refs 所列设计文档小节（实践重点、详细需求、验收要点）
delivery_scope: "OHLCV/新闻/行业 全结构；Dockerfile；前期可少存数据；逻辑填充期接入点 AkShare、OpenBB 按 design_doc 对应小节实现"
exit_criteria: "采集逻辑实现；make ingest-test 可运行；依赖已写入 Dockerfile/requirements；镜像内 make ingest-test 通过；前置 make verify-db-connection 已通过"
# AI 可读：实现「该怎么做」须读取下列完整路径#锚点对应小节（实践重点、详细需求、验收要点）
logic_fill_design_refs:
  - "03_原子目标与规约/Stage2_数据采集与存储/02_采集逻辑与Dockerfile设计.md#design-stage2-02-integration-akshare"
  - "03_原子目标与规约/Stage2_数据采集与存储/02_采集逻辑与Dockerfile设计.md#design-stage2-02-integration-openbb"
design_integration_anchors:
  - design-stage2-02-integration-akshare
  - design-stage2-02-integration-openbb
# 设计层补充：前置依赖与验证、验收维度
design_consumes_anchor: "design-stage2-02-consumes"
design_verification_anchor: "design-stage2-02-verification"
l5_stage_anchor: "l5-stage-stage2_02"
consumes: ["Stage2-01 准出"]
# 本步执行前必须就绪的关键配置（来源：.env 或 Sealed-Secrets；占位见 diting-core .env.template）
required_config:
  - TIMESCALE_DSN   # L1 TimescaleDB 连接串
  - PG_L2_DSN      # L2 知识库 PostgreSQL 连接串
  - REDIS_URL      # 可选，Redis 连接串
artifacts: ["采集任务", "Dockerfile", "Makefile ingest-test target"]
# 部署配套：逻辑填充期借鉴组件，须在 Dockerfile/requirements 中显式安装
integration_packages:
  - akshare
  - openbb-platform  # 或项目采用的 openbb 包名

# 准出验证命令：与 L4 实践文档「验证与准出」表一致
verification_commands:
  - cmd: "make verify-db-connection"
    cwd_ref: "repo_i"
    expected_exit: 0
    expected_outcome: "本步前置：依赖检查与关键参数就绪；连接 DB 并对 init 所建表查询成功"
    phase: "pre"
  - cmd: "make ingest-test"
    cwd_ref: "repo_i"
    expected_exit: 0
    expected_outcome: "采集逻辑运行；写入 L1/L2 符合表结构与规约"
    phase: "local"
  - cmd: "在采集镜像内执行 make ingest-test"
    cwd_ref: "repo_i"
    expected_exit: 0
    expected_outcome: "Dockerfile/requirements 依赖正确；镜像按预期运行并采集数据"
    phase: "image"

# L4 实践文档锚点：依赖检查、采集逻辑细节、示例与验证（便于工具链跳转）
l4_anchors:
  deps_check: "l4-stage2-02-deps-check"
  ingest_detail: "l4-stage2-02-ingest-detail"
  examples_verify: "l4-stage2-02-examples-verify"
  exit: "l4-stage2-02-exit"
  # 功能与验证清单：执行时勾选，便于区分已实践/未实践、通过/失败
  feature_checklist: "l4-stage2-02-feature-checklist"
  verify_checklist: "l4-stage2-02-verify-checklist"
  summary: "l4-stage2-02-summary"

# 功能实践项（与 L4 功能实践项清单表一致；执行者填状态）
feature_items:
  - id: "F1"
    description: "ingest_ohlcv：AkShare A 股日线 → L1 ohlcv"
  - id: "F2"
    description: "ingest_industry_revenue：AkShare 行业/财报/营收 → L2 或约定存储"
  - id: "F3"
    description: "ingest_news：AkShare 国内 + OpenBB 国际 → L2 data_versions"
  - id: "F4"
    description: "AkShare 接口边界与错误/限流（重试、退避）"
  - id: "F5"
    description: "OpenBB 至少一条到 L2 的写入路径"
  - id: "F6"
    description: "Makefile 新增 ingest-test target"
  - id: "F7"
    description: "Dockerfile/requirements 显式 akshare、openbb-platform"
  - id: "F8"
    description: "ingest-test 目标数据约定（哪些股票、哪些 data_type）"

# 验证与测试项（与 L4 验证与测试结果清单表一致；执行者填测试结果）
verification_items:
  - id: "V-DB"
    description: "数据库可连接、表可读写"
    cmd: "make verify-db-connection"
  - id: "V-INGEST"
    description: "采集任务可运行且写入 L1/L2"
    cmd: "make ingest-test"
  - id: "V-DATA"
    description: "确认目标数据（哪些股票、哪些数据）"
    cmd: "psql 验证查询，与 ingest-test-target 约定一致"
  - id: "V-IMAGE"
    description: "镜像内可运行采集"
    cmd: "在采集镜像内执行 make ingest-test"
