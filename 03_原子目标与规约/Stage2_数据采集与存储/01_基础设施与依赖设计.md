# L3 · Stage2-01 基础设施与依赖设计

> [!NOTE] **[TRACEBACK] 原子规约锚点**
> - **战略维度**: [数据架构与分层存储维度](../../02_战略维度/产品设计/03_数据架构与分层存储维度.md)、[开发与交付流程维度](../../02_战略维度/开发与交付/01_开发与交付流程维度.md)
> - **原子规约**: [_共享规约/11_数据采集与输入层规约](../_共享规约/11_数据采集与输入层规约.md)、[_共享规约/07_数据版本控制规约](../_共享规约/07_数据版本控制规约.md)、[开发与交付/02_基础设施与部署规约](../开发与交付/02_基础设施与部署规约.md)
> - **DNA**: [_System_DNA/Stage2_数据采集与存储/dna_stage2_01.yaml](../_System_DNA/Stage2_数据采集与存储/dna_stage2_01.yaml)
> - **L4 实践**: [04_阶段规划与实践/Stage2_数据采集与存储/01_基础设施与依赖部署](../../04_阶段规划与实践/Stage2_数据采集与存储/01_基础设施与依赖部署.md#l4-stage2-01-exit)
> - **L5 锚点**: [02_验收标准#l5-stage-stage2_01](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage2_01)

<a id="design-stage2-01-goal"></a>
## 本步目标

TimescaleDB、Redis、PostgreSQL 部署；Schema init Job 执行建表；Sealed-Secrets 就绪；环境 Minimal/Full 标明；初期本地连 K3s（NodePort），后期 K3s Job。

<a id="design-stage2-01-points"></a>
## 设计要点

- **Schema 归属**：基础组件 Chart 的 init Job 执行建表；严禁在应用代码中执行 DDL
- **存储**：L1 TimescaleDB（OHLCV）、Redis、L2 pgvector（知识库）
- **Sealed-Secrets**：密钥注入由 Sealed-Secrets 完成；Stage1 末已就绪
- **环境**：Minimal（本地或轻量）vs Full（K3s 全栈）；每步标明

<a id="design-stage2-01-versions"></a>
## 版本固定与缓存（必守）

Chart、中间件镜像等部署用制品**必须版本固定并缓存在部署仓**，禁止部署时从远程动态拉取未固定版本。

| 类别 | 约定 | 权威来源 |
|------|------|----------|
| **Helm Chart** | 所有 Chart 须下载到本地 `charts/dependencies/<chart-name>/`；`Chart.yaml` 中 version 固定 | [dna_stage2_01.yaml](../_System_DNA/Stage2_数据采集与存储/dna_stage2_01.yaml) 的 `pinned_versions.charts` |
| **中间件镜像** | values 中镜像 tag 固定，禁止 `latest` | DNA `pinned_versions.middleware_images` |
| **Schema/init 脚本** | 建表 SQL 与 init Job 脚本存于 diting-infra 约定路径（如 `schemas/sql/`），由 Git 管理 | 本步 artifacts |

<a id="design-stage2-01-exit"></a>
## 准出

1. **组件可用**：TimescaleDB/Redis/PostgreSQL 可用；Schema init Job 成功；Sealed-Secrets 可用。
2. **验证结构**：准出须满足 L4 步骤文档中「验证与准出」全部项——① 验证项列表 ② 验证方式与预期目标 ③ 评判验证结果是否符合预期；**全部符合**方可准出。
3. **下游关键验证**：其它服务（以采集服务为例）能按文档/示例添加数据库连接配置并成功调用本步所建表数据（如 diting-core 内 `make verify-db-connection` 通过）；该验证为本步**核心验证指标**，未通过不得准出。
