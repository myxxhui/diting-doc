# L2 · 研产同构维度

> [!NOTE] **[TRACEBACK] 战略维度锚点**
> - **顶层概念**: [一句话定义与核心价值](../../01_顶层概念/01_一句话定义与核心价值.md)
> - **顶层概念**: [战略目标与ROI](../../01_顶层概念/02_战略目标与ROI.md)
> - **本文档**: L2 层级，定义研产同构维度

## 维度定义

**研产同构维度**：量化交易最大的痛点是“回测过拟合”和“实盘逻辑不一致”。通过共享内核策略与仿真沙箱，确保回测代码与实盘代码使用同一套逻辑。**主要保障 A 轨**回测与实盘一致、**45%** 复利目标（A 轨）可复现；**B 轨**使用同一套 Strategy/信号逻辑，但 KPI 与风控按轨不同（B 轨用逻辑证伪/大周期反转，不适用不可能三角），验收指标为 B 轨指标（持仓周期、逻辑证伪触发等），不用 A 轨 WinRate/CAGR/MaxDD 评估 B 轨，见 [03_双轨制与VC-Agent](../../01_顶层概念/03_双轨制与VC-Agent.md)。

## 关键目标

1. **逻辑一致性**：回测与实盘使用同一套 Strategy 类和 Signal 函数，严禁两套逻辑
2. **仿真验证**：上线前必须在模拟盘运行至少 2 周，验证事件驱动逻辑
3. **可追溯性**：回测结果与实盘结果可对比，定位差异原因

## 覆盖范围

### 研产同构逻辑

```mermaid
flowchart LR
  回测[Backtrader 回测] --> CORE[diting-core<br/>共享 Strategy]
  实盘[实盘执行] --> CORE
  仿真[模拟盘 2 周] --> CORE
  CORE --> 一致[逻辑一致·可追溯]
  style CORE fill:#4CAF50,color:#fff
  style 一致 fill:#2196F3,color:#fff
```

### 5.1 共享内核策略

| 组件 | 用途 | 机制 |
|------|------|------|
| **Shared Library Strategy** | 回测与实盘共享代码 | Repo-I (diting-core) 设计为可安装的 Python 包 |

**战略要求**：
- Repo-I (diting-core) 必须被设计为一个可安装的 Python 包
- 无论是 Backtrader 回测脚本，还是实盘执行脚本，必须调用同一个 `diting-core` 中的 Strategy 类和 Signal 函数
- **严禁**在 Jupyter 里写一套逻辑，然后手动翻译成实盘代码

**实现方式**：
```python
# 回测脚本（Jupyter）
from diting_core.strategies import TrendStrategy
from backtrader import Cerebro

cerebro = Cerebro()
cerebro.addstrategy(TrendStrategy)  # 使用 diting-core 的 Strategy
cerebro.run()

# 实盘脚本（Python Class）
from diting_core.strategies import TrendStrategy
from diting_core.execution import ExecutionEngine

strategy = TrendStrategy()  # 同一个 Strategy 类
engine = ExecutionEngine(strategy)
engine.run()
```

### 5.2 仿真沙箱

| 组件 | 用途 | 机制 |
|------|------|------|
| **The Matrix (模拟交易所)** | 模拟盘验证 | Redis Streams 回放历史 Tick 数据 |

**战略要求**：
- 在上线实盘前，策略必须在 "Paper Trading Mode"（模拟盘）运行至少 2 周
- 利用 Redis Streams 回放历史 Tick 数据，模拟真实的市场推送频率
- 验证系统的事件驱动（Event-Driven）逻辑是否健壮

**验证内容**：
- 信号生成逻辑：模拟盘与回测结果一致
- 事件驱动逻辑：Redis Streams 事件处理无遗漏、无重复
- 风控逻辑：模拟盘的风控拦截与回测一致
- 性能表现：模拟盘的延迟与吞吐满足实盘要求

### 5.3 三种运行形态

本维度明确三种运行形态，**同一套 Strategy 与 Proto** 在三种形态下保持一致，仅部署形态与数据源不同。

| 形态 | 部署/运行方式 | 数据与节奏 | 与共享代码的关系 |
|------|----------------|------------|------------------|
| **回测** | 单进程（或单镜像），本地/单机 | 历史数据，离线；不连交易所 | Backtrader/VectorBT + diting-core 同一套 Strategy、Signal；验证策略逻辑与收益曲线 |
| **实盘** | 多服务：数据采集与存储、Module A/B/C、热路径 D+E+F（5 个可部署单元）部署于 K3s | 线上实时数据 | 各服务均使用 diting-core 生成的 Proto 与同一套策略逻辑；BrokerDriver/MarketDataFeed 抽象保证接口一致 |
| **开发期连调** | 部分服务本地编译运行，其余服务与基础组件（DB/Redis 等）在远程 K3s | 可用线上/类生产数据，贴近生产节奏 | 本地进程与远程 K3s 上的服务共用同一 diting-core 代码与 Proto；用于接口与数据流验证，不脱离生产节奏 |

**约定**：
- **回测**：特指用历史行情数据跑策略、评估收益与回撤，不涉及真实下单；必须单进程以保证与 06_ 共享内核一致。
- **开发期连调**：允许「本地运行一个或多个服务 + 连接远程 K3s 的 TimescaleDB/Redis/其它已部署服务」进行联调；数据可来自线上或类生产环境，便于在开发阶段验证与生产一致的路径。

## 约束条件

1. **代码一致性**：回测与实盘必须使用同一套代码，严禁手动翻译
2. **仿真时长**：模拟盘必须运行至少 2 周，验证事件驱动逻辑
3. **可追溯性**：回测结果与模拟盘结果可对比，定位差异原因

## 与不可能三角的关系

- **认知边界 (Certainty)**：研产同构确保回测的高胜率能延续到实盘，避免逻辑不一致导致的胜率下降
- **复利增长 (Growth)**：回测的 45% 复利目标（与 L1 不可能三角一致）必须能在实盘复现，研产同构是前提
- **生存底线 (Survival)**：模拟盘验证风控逻辑，确保实盘回撤 < 12% 的目标可达成

## 下一步

→ 主责 L3 规约：[05_接口抽象层规约](../../03_原子目标与规约/_共享规约/05_接口抽象层规约.md)；辅规约：02_三位一体、03_架构设计共识、07_数据版本控制、09_核心模块。完整对应见 [L2-L3-DNA 映射表](../../06_追溯与审计/00_L2_L3_DNA_映射.md)。
