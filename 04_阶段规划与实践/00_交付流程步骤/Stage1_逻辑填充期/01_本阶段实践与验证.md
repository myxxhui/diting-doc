# Stage1 逻辑填充期 · 本阶段实践与验证

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **战略维度**: [01_开发与交付流程维度](../../../02_战略维度/开发与交付/01_开发与交付流程维度.md)
> - **原子规约**: [01_开发生命周期与实践流程规约](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md) **阶段 1**
> - **本步骤对应 01 规约**: 阶段 1（逻辑填充期）
> - **DNA stage_id**: `s1`（[dna_dev_workflow.yaml](../../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml)）
> - **与 Phase 步骤关系**: 可与 Phase1 功能步骤交错进行；逻辑填充内容由各 Phase 步骤细化，本步骤只约定环境与准出条件。

---

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[s1]` | delivery_scope、exit_criteria、test_focus、work_dir、verification_commands、l5_stage_anchor |
| `dna_dev_workflow.workflow_stages[s1].delivery_scope` | 交付范围：Module A/B 骨架 + D 判官最小闭环 + E 占位 |
| `dna_dev_workflow.workflow_stages[s1].exit_criteria` | 准出条件：业务逻辑按 L3 与 5D 填充完毕；本地单测 + 必要集成测试通过 |
| `dna_dev_workflow.workflow_stages[s1].work_dir` | 工作目录权威：type=repo_i，diting-core 代码仓 |
| `dna_dev_workflow.workflow_stages[s1].verification_commands` | 可执行验证命令：make test，expected_exit 0；expected_outcome/failure_hint 见 DNA |
| `dna_dev_workflow.workflow_stages[s1].l5_stage_anchor` | 准出时更新 L5 的行锚：l5-stage-s1 |
| `dna_dev_workflow.workflow_stages[s1].test_focus` | 验证重点：unit, integration |
| `global_const.trinity_repos.repo_i.make_targets` | 验收命令来源（test 等） |

实施内容与验证按以上键展开；具体任务拆分见 [Phase1_核心链路](../../Phase1_核心链路/) 的 01_～04_ 步骤。

## 本步骤产出物与下一阶段消耗

- **本步骤产出物**（DNA artifacts）：Module A/B 骨架与 D/E 占位、单测与集成测试通过。
- **下一阶段消耗**（s1b 准入）：Stage s1 准出。

### 执行者（逻辑密集阶段）

| 项目 | 说明 |
|------|------|
| **执行者** | AI 起草业务逻辑与测试；Human 做 Defense（Code Review、单测/集成全绿确认、勾选准出、更新 L5）。 |

### 本步骤推荐 Context 清单 <a id="context-清单"></a>

<a id="context-必读-yaml"></a>必读 YAML 与 L3 路径（DNA 为权威）：[dna_dev_workflow.yaml](../../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml) 中 `workflow_stages[s1]`、[global_const.yaml](../../../03_原子目标与规约/_System_DNA/global_const.yaml) 中 `core_modules`/`product_scope`（若涉及）。

| 类型 | 路径或文档 |
|------|-------------|
| 必读 YAML | `dna_dev_workflow.workflow_stages[s1]`、`global_const.core_modules`（若涉及模块）、`product_scope` |
| 必读 L3 | [01_开发生命周期与实践流程规约](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md)、[01_需求与产品范围](../../../03_原子目标与规约/产品设计/01_需求与产品范围.md)、[03_项目全功能开发测试实践工作流详细规划](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md) |
| 可选 | 09_核心模块、Phase1 步骤 |
| 建议量级 | 单步 Context 建议不超过约 50k 字符（见协议 §8.5） |

### 本步骤精密 Prompt 要素

- **Context**：上述必读 YAML 与 L3；涉及资源选型时引用 cost_governance；禁止明文密钥。
- **Task**：按 delivery_scope 与 exit_criteria 填充 Module A/B/D/E 等业务逻辑，单测+集成通过。
- **Constraint**：工作目录 diting-core；逻辑密集处须 5D（Decompose、Drive、Defense）；验收以单测+集成为准。
- **Output Format**：业务逻辑按 L3 与 5D 填充完毕，单测与必要集成全绿；产出物见上。

## 核心指令（The Prompt）

```
你是在 diting-core 代码仓中执行 Stage1（逻辑填充期）的开发者。请先阅读以下内容再动手：
- 必读：dna_dev_workflow.workflow_stages[s1]、global_const.core_modules（若涉及）、product_scope（见 03_原子目标与规约/_System_DNA/）；
- 必读：01_开发生命周期与实践流程规约、01_需求与产品范围、03_项目全功能开发测试实践工作流详细规划；
- 可选：09_核心模块、Phase1 步骤 01_～04_。
- 禁止在 Prompt 或 01_ 中写明文密钥。

你的任务：
1. 按 delivery_scope 与 exit_criteria 在对应模块内实现业务逻辑：Module A/B 骨架、D 判官最小闭环、E 占位（具体「做哪些」见 Phase1 的 01_～04_ 或下方「若暂无 Phase 步骤时的最小任务」）。
2. 遵循 5D（Design-Drive-Decompose-Defense），逻辑密集处使用 Table-Driven Tests 与边界覆盖。
3. 完成本地单测 + 必要集成测试（关键路径与边界），全部通过；与 03_架构设计共识 中的测试要求一致。

约束：工作目录 diting-core；验收以单测+集成为准。
请输出：变更/新增文件列表、关键逻辑摘录、make test 执行结果（退出码 0、全绿）。
```

## Prompt 使用说明

将上述整段复制到 AI 或本地执行上下文；工作目录替换为你的 diting-core 实际路径。当采用 Phase 步骤时，可优先按 [Phase1_核心链路](../../Phase1_核心链路/) 的 01_～04_ 中「核心指令」逐步执行。执行后用下方「验证与准出」中的命令自检，满足准出检查清单再准出。

---

## 交付范围（直引 DNA）

**最小交付范围**（来自 `dna_dev_workflow.workflow_stages[s1].delivery_scope`）：**Module A/B 骨架 + D 判官最小闭环 + E 占位**。具体任务拆分见 [Phase1_核心链路](../../Phase1_核心链路/) 的 01_～04_ 步骤或等价。

**若暂无 Phase 步骤时的最小任务**：见 `dna_dev_workflow.s1.delivery_scope` 与 [01_开发生命周期与实践流程规约 阶段 1](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md)；按 delivery_scope 实现 Module A/B 占位、D 判官最小闭环、E 占位，并使 make test 全绿。

**当采用 Phase 步骤时**：本 Stage（s1）对应的 Phase 步骤为 [Phase1_核心链路](../../Phase1_核心链路/) 的 [01_ModuleA_B骨架与接口](../../Phase1_核心链路/01_ModuleA_B骨架与接口.md)、[02_ModuleD判官最小闭环](../../Phase1_核心链路/02_ModuleD判官最小闭环.md)、[03_ModuleE风控占位](../../Phase1_核心链路/03_ModuleE风控占位.md)、[04_A到E集成与Mock准备](../../Phase1_核心链路/04_A到E集成与Mock准备.md)。准出检查清单与「本步骤失败时」须与上述 Phase1 各步的 **本步骤准出** 及 **本步骤失败时** 对齐；可执行验证清单中的命令与对应 Phase 步骤文档「验收与测试」中的可复制测试命令一致（或为其并集）。

---

## 验证与准出 <a id="验证与准出"></a>

工作目录：**diting-core** 根目录。与 DNA `workflow_stages[s1].verification_commands` 及代码仓 Makefile/CI 一致（代码仓变更须同步本文档）。

| 命令/检查 | 工作目录 | 期望结果 | 失败时 |
|-----------|----------|----------|--------|
| Module A/B/D/E 与单测/集成覆盖 | diting-core | 按 delivery_scope 与 5D 完成；边界与关键路径有覆盖 | 对照 Phase1 01_～04_ 或最小任务补全 |
| `make test` | diting-core 根目录 | 退出码 0；单测+必要集成全绿 | 运行单测或集成定位失败用例，见「本步骤失败时」 |

闭环点：A→B→D 一条最小路径、业务逻辑按 L3 与 5D 填充（[03_工作流详细规划](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md) 第六节）。

**准出检查清单**（与 01 规约阶段 1 准出条件逐条对应；全部勾选后准出）：

- [ ] 业务逻辑按 L3 规约与 5D 填充完毕
- [ ] 本地单测 + 必要集成测试通过
- [ ] 满足 01 规约「阶段 1：逻辑填充期」准出条件
- [ ] **已更新 L5 [02_验收标准](../../../05_成功标识与验证/02_验收标准.md) 中本 stage（s1）对应行（状态+验证方式）**

验收完成后再进入 Stage1b 或 Stage2。

---

## 验证结果与 L5 同步

准出时须更新 **L5 [02_验收标准](../../../05_成功标识与验证/02_验收标准.md) 中 workflow_stages 映射表 s1 行**（将对应行状态更新为已通过并注明验证方式）。本目录不保留可填写的验证结果表，直接更新 L5。

---

## 本步骤失败时

- **回退**：回退到本阶段第一步或 Stage0 最后一步。
- **重试上限**：建议 3 次；不通过则回退或暂停待人工排查。
- **临时跳过某验证项**：须经架构师或项目负责人审批并更新 L3/DNA 与本文档。
- **验证失败时**：除回退/重试外，须输出**失败项**（未通过的命令/检查点）及**建议修正动作**（如 make test 失败 → 运行单测或集成测试定位失败用例）；若由 CI 执行，须将失败与 01_ 对应步骤链接。自动反馈修正分级见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
- 具体回退操作与检查点定义见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
