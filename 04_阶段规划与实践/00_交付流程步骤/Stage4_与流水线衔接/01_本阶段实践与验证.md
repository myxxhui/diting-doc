# Stage4 与流水线衔接 · 本阶段实践与验证

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **战略维度**: [01_开发与交付流程维度](../../../02_战略维度/开发与交付/01_开发与交付流程维度.md)
> - **原子规约**: [01_开发生命周期与实践流程规约](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md) **阶段 4**、[03_架构设计共识与协作元规则](../../../03_原子目标与规约/03_架构设计共识与协作元规则.md)
> - **本步骤对应 01 规约**: 阶段 4（与发布流水线衔接）
> - **DNA stage_id**: `s4`（[dna_dev_workflow.yaml](../../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml)）

---

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[s4]` | delivery_scope、exit_criteria、test_focus、work_dir、verification_commands、l5_stage_anchor |
| `dna_dev_workflow.workflow_stages[s4].delivery_scope` | 交付范围：满足三级流水线 Level 1 入口要求 |
| `dna_dev_workflow.workflow_stages[s4].exit_criteria` | 准出条件：代码/镜像满足 Level 1 入口；可进入 merge develop / tag 流程 |
| `dna_dev_workflow.workflow_stages[s4].work_dir` | 工作目录权威：type=repo_i，diting-core、diting-infra |
| `dna_dev_workflow.workflow_stages[s4].verification_commands` | 可执行验证：Level 1 验收表逐条确认；expected_outcome/failure_hint 见 DNA |
| `dna_dev_workflow.workflow_stages[s4].l5_stage_anchor` | 准出时更新 L5 的行锚：l5-stage-s4 |
| `dna_dev_workflow.workflow_stages[s4].test_focus` | 验证重点：k3s_e2e（与 Level 1 验收一致） |
| `global_const.architecture_consensus.gitflow.level_1_unit_test` | Level 1 要求：Table-Driven Tests、边界覆盖 |

## 本步骤产出物与下一阶段消耗

- **本步骤产出物**（DNA artifacts）：Level 1 入口满足、可进入 merge develop / tag。
- **下一阶段消耗**：Level 2/3 流水线（merge develop、tag release 等）；准出后进入 Level 2/3 及运营观测见 03_架构设计共识、10_运营治理与灾备规约。

### 本步骤推荐 Context 清单 <a id="context-清单"></a>

<a id="context-必读-yaml"></a>必读 YAML 与 L3 路径（DNA 为权威）：[dna_dev_workflow.yaml](../../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml) 中 `workflow_stages[s4]`、[global_const.yaml](../../../03_原子目标与规约/_System_DNA/global_const.yaml) 中 `architecture_consensus.gitflow`（Level 1 验收）。

| 类型 | 路径或文档 |
|------|-------------|
| 必读 YAML | `dna_dev_workflow.workflow_stages[s4]`、`architecture_consensus.gitflow`（Level 1 验收） |
| 必读 L3 | [01_开发生命周期与实践流程规约](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md)、[03_架构设计共识与协作元规则](../../../03_原子目标与规约/03_架构设计共识与协作元规则.md)、[10_运营治理与灾备规约](../../../03_原子目标与规约/10_运营治理与灾备规约.md) |
| 可选 | 02_基础设施与部署、Level 2/3 入口文档 |
| 建议量级 | 单步 Context 建议不超过约 50k 字符（见协议 §8.5） |

### 本步骤精密 Prompt 要素

- **Context**：上述必读 YAML 与 L3；禁止明文密钥。
- **Task**：按 delivery_scope 与 exit_criteria 确认 Level 1 入口满足（Table-Driven Tests、边界覆盖），可进入 merge develop / tag。
- **Constraint**：工作目录 diting-core、diting-infra；Defense 由 Human 执行（准出前 Code Review、L5 更新）。
- **Output Format**：Level 1 验收表逐条满足；准出后移交运维制品与 Level 2/3 入口见下「准出后移交运维」；产出物见上。

## 核心指令（The Prompt）

```
你是在 diting-core、diting-infra 中执行 Stage4（与流水线衔接）的实践者。请先阅读以下内容再动手：
- 必读：dna_dev_workflow.workflow_stages[s4]、architecture_consensus.gitflow（Level 1 验收）（见 03_原子目标与规约/_System_DNA/）；
- 必读：01_开发生命周期与实践流程规约、03_架构设计共识与协作元规则、10_运营治理与灾备规约；
- 禁止在 Prompt 或 01_ 中写明文密钥。

你的任务：
1. 确认所有 Table-Driven Tests 与 03 文档中 Level 1 要求一致，CI 可重复执行并通过。
2. 确认边界条件覆盖满足 03 文档要求，无遗漏。
3. 配置或文档化：commit 触发 Level 1、merge develop 触发 Level 2、tag 触发 Level 3 的入口条件与流程。
4. 人工或自动化检查：代码/镜像可进入 merge develop 或 tag 流程而无阻塞项。

约束：工作目录 diting-core、diting-infra；Defense 由 Human 执行（准出前 Code Review、L5 更新）。
请输出：Level 1 验收表逐条满足情况、make test 执行结果（退出码 0）。
```

## Prompt 使用说明

将上述整段复制到 AI 或本地执行上下文；工作目录替换为你的 diting-core 实际路径。执行后用下方「验证与准出」中的命令自检，满足准出检查清单再准出。

---

## 交付范围（直引 DNA）

**最小交付范围**（来自 `dna_dev_workflow.workflow_stages[s4].delivery_scope`）：**满足三级流水线 Level 1 入口要求**。具体验收见 03_架构设计共识 中 Level 1/2/3。

**当采用 Phase 步骤时**：本 Stage（s4）对应的 Phase 步骤为 [Phase3_优化与扩展](../../Phase3_优化与扩展/) 的 [04_Level1与L5验收对齐](../../Phase3_优化与扩展/04_Level1与L5验收对齐.md)（与 Level 2/3 承接的步骤见 03_架构设计共识）。准出检查清单与「本步骤失败时」须与各 Phase 步骤的 **本步骤准出** 及 **本步骤失败时** 对齐（见各 Phase README 及步骤文档内 Phase–Stage 接口）。可执行验证清单中的命令与对应 Phase 步骤文档「验收与测试」中的可复制测试命令一致（或为其并集）。

---

## 验证与准出 <a id="验证与准出"></a>

工作目录：**diting-core** 根目录。与 DNA `workflow_stages[s4].verification_commands` 及 03_架构设计共识 Level 1、代码仓 Makefile/CI 一致（变更须同步本文档）。

| 命令/检查 | 工作目录 | 期望结果 | 失败时 |
|-----------|----------|----------|--------|
| `make test`（Level 1 验收） | diting-core 根目录 | 退出码 0；Table-Driven Tests、边界覆盖满足 03 文档 | 补齐 Table-Driven Tests 或边界覆盖，见「本步骤失败时」 |
| 可进入 merge develop / tag | — | 无阻塞项；与 03_ 中 Level 1/2/3 验收一致 | 对照 03_架构设计共识 逐条排查 |

闭环点：Level 1 验收表逐条满足（[03_工作流详细规划](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md) 第六节）。

**准出检查清单**（与 01 规约阶段 4 准出条件逐条对应；全部勾选后准出）：

- [ ] 代码/镜像满足三级流水线 Level 1 入口要求（Table-Driven Tests、边界覆盖）
- [ ] 可进入 merge develop / tag 流程
- [ ] 满足 01 规约「阶段 4：与流水线衔接」准出条件；与 03_架构设计共识 中 Level 1/2/3 的验收一致
- [ ] **已更新 L5 [02_验收标准](../../../05_成功标识与验证/02_验收标准.md) 中本 stage（s4）对应行（状态+验证方式）**

验收完成后可进入三级流水线 Level 2/3。

### 准出后移交运维与 Level 2/3 入口

- **准出后进入**：Level 2/3 流水线及运营观测；入口条件见 [03_架构设计共识与协作元规则](../../../03_原子目标与规约/03_架构设计共识与协作元规则.md) Level 2/3 与 [10_运营治理与灾备规约](../../../03_原子目标与规约/10_运营治理与灾备规约.md)。
- **准出后移交运维的制品清单**（供运维与 Level 2/3 消费）：
  - diting-infra 下可观测性配置（如 `observability/`、Grafana/Prometheus 等）
  - 回滚 runbook 或路径（见 02_基础设施与部署规约、03_工作流 八、失败与回退策略）
  - Level 2/3 流水线入口文档链接（03_架构设计共识、diting-infra README 或 CI 配置说明）
- **本阶段针对环境**：仅 dev/Level 1 准出；staging/prod 准入与部署见 02_基础设施与部署规约与 Level 2/3。

---

## 验证结果与 L5 同步

准出时须更新 **L5 [02_验收标准](../../../05_成功标识与验证/02_验收标准.md) 中 workflow_stages 映射表 s4 行**（将对应行状态更新为已通过并注明验证方式）。本目录不保留可填写的验证结果表，直接更新 L5。

---

## 本步骤失败时

- **回退**：回退到本阶段第一步或 Stage3 最后一步。
- **重试上限**：建议 3 次；不通过则回退或暂停待人工排查。
- **临时跳过某验证项**：须经架构师或项目负责人审批并更新 L3/DNA 与本文档。
- **验证失败时**：除回退/重试外，须输出**失败项**（未通过的命令/检查点）及**建议修正动作**（如 Level 1 验收未过 → 补齐 Table-Driven Tests 或边界覆盖）；若由 CI 执行，须将失败与 01_ 对应步骤链接。自动反馈修正分级见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
- 具体回退操作与检查点定义见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
