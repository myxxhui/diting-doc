# Stage3 K3s 测试开发期 · 本阶段实践与验证

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **战略维度**: [01_开发与交付流程维度](../../../02_战略维度/开发与交付/01_开发与交付流程维度.md)
> - **原子规约**: [01_开发生命周期与实践流程规约](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md) **阶段 3**、[02_基础设施与部署规约](../../../03_原子目标与规约/开发与交付/02_基础设施与部署规约.md)
> - **本步骤对应 01 规约**: 阶段 3（K3s 测试开发期）
> - **DNA stage_id**: `s3`（[dna_dev_workflow.yaml](../../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml)）

---

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[s3]` | delivery_scope、exit_criteria、test_focus、deploy_action、work_dir、verification_commands、l5_stage_anchor |
| `dna_dev_workflow.workflow_stages[s3].delivery_scope` | 交付范围：编排、Secret、网络与生产一致（非生产命名空间） |
| `dna_dev_workflow.workflow_stages[s3].exit_criteria` | 准出条件：deploy-engine Up 成功；KubeConfig 可用 / Helm release 存在 |
| `dna_dev_workflow.workflow_stages[s3].work_dir` | 工作目录权威：type=repo_a，diting-infra、deploy-engine |
| `dna_dev_workflow.workflow_stages[s3].verification_commands` | 可执行验证：deploy-engine Up 或等价调用；expected_outcome/failure_hint 见 DNA |
| `dna_dev_workflow.workflow_stages[s3].l5_stage_anchor` | 准出时更新 L5 的行锚：l5-stage-s3 |
| `dna_dev_workflow.workflow_stages[s3].test_focus` | 验证重点：k3s_e2e |
| `global_const.trinity_repos.repo_a` | diting-infra、deploy-engine、config 路径 |

## 本步骤产出物与下一阶段消耗

- **本步骤产出物**（DNA artifacts）：deploy-engine Up、Helm release 存在。
- **下一阶段消耗**（s4 准入）：Stage s3 准出。

### 本步骤推荐 Context 清单 <a id="context-清单"></a>

<a id="context-必读-yaml"></a>必读 YAML 与 L3 路径（DNA 为权威）：[dna_dev_workflow.yaml](../../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml) 中 `workflow_stages[s3]`、[global_const.yaml](../../../03_原子目标与规约/_System_DNA/global_const.yaml) 中 `trinity_repos.repo_a`、`production_requirements.observability`、`production_requirements.deployment`。

| 类型 | 路径或文档 |
|------|-------------|
| 必读 YAML | `dna_dev_workflow.workflow_stages[s3]`、`global_const.trinity_repos.repo_a`、`production_requirements.observability`、`production_requirements.deployment` |
| 必读 L3 | [01_开发生命周期与实践流程规约](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md)、[02_基础设施与部署规约](../../../03_原子目标与规约/开发与交付/02_基础设施与部署规约.md)、[08_心跳协议与健康检查规约](../../../03_原子目标与规约/08_心跳协议与健康检查规约.md) |
| 可选 | 09_核心模块、10_运营治理与灾备；密钥见 L3 与 diting-infra README，禁止在 01_ 或 Prompt 中写明文密钥 |
| 建议量级 | 单步 Context 建议不超过约 50k 字符（见协议 §8.5） |

### 本步骤精密 Prompt 要素

- **Context**：上述必读 YAML 与 L3；**禁止在 01_ 或 Prompt 中写明文密钥**；密钥来源见 L3 与 diting-infra README。涉及资源选型时引用 cost_governance。
- **Task**：按 delivery_scope 与 exit_criteria 在 diting-infra 下调用 deploy-engine Up，KubeConfig 可用、Helm release 存在。
- **Constraint**：工作目录 diting-infra（及 diting-core 镜像构建）；本阶段仅 k3s_dev（dev）；staging/prod 见 02_ 与 Level 2/3。
- **Output Format**：deploy-engine Up 成功，Helm release 存在；产出物见上。**版本/可复现信息**（s3 必填）：如 Helm release 版本、镜像 tag、部署时间戳。

## 核心指令（The Prompt）

```
你是在 diting-infra（及 diting-core 镜像构建）中执行 Stage3（K3s 测试开发期）的开发者。请先阅读以下内容再动手：
- 必读：dna_dev_workflow.workflow_stages[s3]、global_const.trinity_repos.repo_a、production_requirements.observability、production_requirements.deployment（见 03_原子目标与规约/_System_DNA/）；
- 必读：01_开发生命周期与实践流程规约、02_基础设施与部署规约、08_心跳协议与健康检查规约；
- 禁止在 01_ 或 Prompt 中写明文密钥；密钥来源见 L3 与 diting-infra README。

你的任务：
1. 在 diting-infra 目录下调用 deploy-engine（CLI 或 Makefile 封装）完成 dev 环境 Up；配置符合 deploy-engine 的 DeploymentConfig。
2. 在 K3s 集群（测试/开发用命名空间）中部署 workload，使用与生产一致的编排与配置模式；机密使用 Sealed-Secrets（见 02_基础设施与部署规约）。
3. 在 K3s 上跑通集成测试或可选 E2E/仿真，验证行为与预期一致。
4. 不部署生产数据或生产密钥；命名空间与权限与生产隔离。

约束：工作目录 diting-infra（及 diting-core 镜像构建）；本阶段仅 k3s_dev（dev）。
请输出：deploy-engine Up 执行结果（退出码 0）、KubeConfig 可用、Helm release 存在、版本/可复现信息。
```

## Prompt 使用说明

将上述整段复制到 AI 或本地执行上下文；工作目录替换为你的 diting-infra 实际路径；切勿在 Prompt 中写明文密钥。执行后用下方「验证与准出」中的命令自检，满足准出检查清单再准出。

---

## 交付范围（直引 DNA）

**最小交付范围**（来自 `dna_dev_workflow.workflow_stages[s3].delivery_scope`）：**编排、Secret、网络与生产一致（非生产命名空间）**。具体任务见 02_基础设施与部署规约与 diting-infra 调用 deploy-engine 约定。

**当采用 Phase 步骤时**：本 Stage（s3）对应的 Phase 步骤为 [Phase2_MoE与执行网关](../../Phase2_MoE与执行网关/) 的 [03_回测或仿真验证](../../Phase2_MoE与执行网关/03_回测或仿真验证.md)、[Phase3_优化与扩展](../../Phase3_优化与扩展/) 的 [01_可观测性与日志指标](../../Phase3_优化与扩展/01_可观测性与日志指标.md)、[02_成本治理与Token熔断](../../Phase3_优化与扩展/02_成本治理与Token熔断.md)。准出检查清单与「本步骤失败时」须与上述步骤的 **本步骤准出** 及 **本步骤失败时** 对齐。可执行验证清单中的命令与对应 Phase 步骤文档「验收与测试」中的可复制测试命令一致（或为其并集）。

---

## 验证与准出 <a id="验证与准出"></a>

工作目录：**diting-infra** 根目录（及 diting-core 镜像构建）。与 DNA `workflow_stages[s3].verification_commands` 及 diting-infra/deploy-engine 约定一致（变更须同步本文档）。

| 命令/检查 | 工作目录 | 期望结果 | 失败时 |
|-----------|----------|----------|--------|
| deploy-engine Up（或 Makefile 封装） | diting-infra 根目录 | 退出码 0；KubeConfig 可用；Helm release 存在 | 检查 KubeConfig、Helm release 与 diting-infra 配置，见「本步骤失败时」 |
| 部署后日志/指标/健康检查 | — | 满足 L3 要求（如指标端点 200 或 Grafana 可见） | 见 08_心跳协议与 production_requirements.observability |

闭环点：单次 deploy-engine Up 成功、Helm release 存在（[03_工作流详细规划](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md) 第六节）。

**准出检查清单**（与 01 规约阶段 3 准出条件逐条对应；全部勾选后准出）：

- [ ] deploy-engine Up 成功；KubeConfig 可用 / Helm release 存在
- [ ] 在 K3s 上可部署并跑通测试/开发用 workload；编排、Secret、网络策略与生产一致（非生产命名空间）
- [ ] **可观测性验收**：部署后日志/指标/健康检查满足 L3 要求（如指标端点返回 200 或 Grafana dashboard 可见）
- [ ] 满足 01 规约「阶段 3：K3s 测试开发期」准出条件
- [ ] **已更新 L5 [02_验收标准](../../../05_成功标识与验证/02_验收标准.md) 中本 stage（s3）对应行（状态+验证方式）**

验收完成后再进入 Stage4。

---

## 验证结果与 L5 同步

准出时须更新 **L5 [02_验收标准](../../../05_成功标识与验证/02_验收标准.md) 中 workflow_stages 映射表 s3 行**（将对应行状态更新为已通过并注明验证方式）。本目录不保留可填写的验证结果表，直接更新 L5。

---

## 本步骤失败时

- **回退**：回退到本阶段第一步或 Stage2 最后一步。
- **重试上限**：建议 3 次；不通过则回退或暂停待人工排查。
- **临时跳过某验证项**：须经架构师或项目负责人审批并更新 L3/DNA 与本文档。
- **验证失败时**：除回退/重试外，须输出**失败项**（未通过的命令/检查点）及**建议修正动作**（如 deploy-engine Up 失败 → 检查 KubeConfig、Helm release 与 diting-infra 配置）；若由 CI 执行，须将失败与 01_ 对应步骤链接。自动反馈修正分级见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
- 具体回退操作与检查点定义见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
