# Stage0_pre 仓库与 L3 就绪 · 本阶段实践与验证

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **战略维度**: [01_开发与交付流程维度](../../../02_战略维度/开发与交付/01_开发与交付流程维度.md)
> - **原子规约**: [01_开发生命周期与实践流程规约](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md) 第一步（仓库与 L3 就绪）
> - **本步骤对应**: 执行顺序第 0 步（仓库与 L3 就绪）
> - **DNA stage_id**: `s0_pre`（[dna_dev_workflow.yaml](../../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml)）

---

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[s0_pre]` | delivery_scope、exit_criteria、test_focus、work_dir、verification_commands、l5_stage_anchor |
| `dna_dev_workflow.workflow_stages[s0_pre].delivery_scope` | 交付范围：三仓目录符合 02_三位一体；diting-core 含最小 Makefile（test 可为占位） |
| `dna_dev_workflow.workflow_stages[s0_pre].exit_criteria` | 准出条件：三仓存在且目录与 global_const.trinity_repos 一致；diting-core 可执行 make test（占位通过） |
| `dna_dev_workflow.workflow_stages[s0_pre].work_dir` | 工作目录权威：type=parent_path，新建仓库的父路径（与 global_const.trinity_repos.parent_path_default 一致） |
| `dna_dev_workflow.workflow_stages[s0_pre].verification_commands` | 可执行验证命令：make -C diting-core test，expected_exit 0；expected_outcome/failure_hint 见 DNA |
| `dna_dev_workflow.workflow_stages[s0_pre].l5_stage_anchor` | 准出时更新 L5 的行锚：l5-stage-s0_pre |
| `global_const.trinity_repos.repo_i.directories` | diting-core 须建立的目录列表 |
| `global_const.trinity_repos.repo_i.make_targets` | diting-core Makefile 须提供 test（及后续 build、test-docker） |
| `global_const.trinity_repos.repo_a.directories` | diting-infra 须建立的目录：charts/、config/、observability/、secrets/ |
| `global_const.trinity_repos.design_and_adr.design_location` | 设计产物位置（diting-core/design/） |
| `global_const.trinity_repos.parent_path_default` | 工作目录：新建仓库的父路径（默认与 diting-doc 同级） |

实施内容与验证按以上键展开。本阶段为「创建或初始化仓库」，工作目录为**新建仓库的父路径或约定路径**；可执行验证可为目录/文件存在性检查或占位脚本（见协议 §8.4a 建仓阶段例外）。**禁止在 01_ 或 Prompt 中写明文密钥**；密钥来源见 [02_三位一体仓库规约](../../../03_原子目标与规约/02_三位一体仓库规约.md) 与 diting-infra README。

## 本步骤产出物与下一阶段消耗

- **本步骤产出物**（DNA artifacts）：diting-core 目录与 Makefile、diting-infra 目录。
- **下一阶段消耗**（s0 准入）：Stage0_pre 准出（即本阶段准出后，Stage0 骨架期方可开始）。

### 本步骤推荐 Context 清单 <a id="context-清单"></a>

<a id="context-必读-yaml"></a>必读 YAML 与 L3 路径（DNA 为权威）：[dna_dev_workflow.yaml](../../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml) 中 `workflow_stages[s0_pre]`、[global_const.yaml](../../../03_原子目标与规约/_System_DNA/global_const.yaml) 中 `trinity_repos`。

| 类型 | 路径或文档 |
|------|-------------|
| 必读 YAML | `dna_dev_workflow.workflow_stages[s0_pre]`、`global_const.trinity_repos` |
| 必读 L3 | [01_开发生命周期与实践流程规约](../../../03_原子目标与规约/开发与交付/01_开发生命周期与实践流程规约.md)、[02_三位一体仓库规约](../../../03_原子目标与规约/02_三位一体仓库规约.md) |
| 可选 | global_const.parent_path_default、repo_i/repo_a.directories |
| 建议量级 | 单步 Context 建议不超过约 50k 字符（见协议 §8.5） |

### 本步骤精密 Prompt 要素

- **Context**：上述必读 YAML 与 L3；禁止在 Prompt 中写明文密钥。
- **Task**：按 delivery_scope 与 exit_criteria 创建 diting-core、diting-infra 目录与 Makefile 占位。
- **Constraint**：工作目录为新建仓库的父路径（global_const.parent_path_default）；遵守 02_三位一体目录与 No Secrets。
- **Output Format**：目录存在、Makefile 存在且 make test 可运行（占位通过）；产出物见上「本步骤产出物」。

## 核心指令（The Prompt）

```
你是在文档仓同级的父路径下执行 Stage0_pre（仓库与 L3 就绪）的实践者。请先阅读以下内容再动手：
- 必读：dna_dev_workflow.workflow_stages[s0_pre] 与 global_const.trinity_repos（见 03_原子目标与规约/_System_DNA/）；
- 必读：01_开发生命周期与实践流程规约、02_三位一体仓库规约。
- 禁止在 Prompt 或 01_ 中写明文密钥；密钥来源见 02_三位一体仓库规约与 diting-infra README。

你的任务：
1. 在约定路径（global_const.trinity_repos.parent_path_default，默认与 diting-doc 同级）下创建 diting-core 仓库/目录，按 repo_i.directories 建立 diting/abstraction/、diting/drivers/、diting/moe/、diting/risk/、diting/strategy/、tests/、design/；根目录添加 Makefile，提供 test target（可为占位，退出码 0）。
2. 创建 diting-infra 仓库/目录，按 repo_a 建立 charts/、config/、observability/、secrets/；在 config/environments/dev/ 下创建 deploy.json 占位。
3. 确认目录与 02_三位一体及 global_const 一致；无业务代码，仅占位与结构。

约束：工作目录为新建仓库的父路径；遵守 No Secrets。
请输出：目录列表、Makefile 内容摘要、make test 执行结果（退出码 0）。
```

## Prompt 使用说明

将上述整段复制到 AI 或本地执行上下文；工作目录替换为你的实际父路径（如与 diting-doc 同级的目录）。执行后用下方「验证与准出」中的命令自检，满足准出检查清单再准出。

---

**本 Stage（s0_pre）对应的 Phase 步骤**：[Phase0_Infra](../../Phase0_Infra/) 的 [01_三位一体仓库初始化](../../Phase0_Infra/01_三位一体仓库初始化.md)；执行以本目录 01_ 为准。

## 交付范围（直引 DNA）

**最小交付范围**（来自 `dna_dev_workflow.workflow_stages[s0_pre].delivery_scope`）：**三仓目录符合 02_三位一体；diting-core 含最小 Makefile（test 可为占位）**。diting-infra 初始化（charts/、config/、observability/、secrets/ 及 config/environments/dev/deploy.json 占位）为本阶段交付物，确保 Stage3 准入「diting-infra 已存在」有背书。

---

## 验证与准出 <a id="验证与准出"></a>

工作目录：**新建仓库的父路径或约定路径**（见协议 §8.4a 建仓阶段例外）。与 DNA `workflow_stages[s0_pre].verification_commands` 一致。

| 命令/检查 | 工作目录 | 期望结果 | 失败时 |
|-----------|----------|----------|--------|
| `test -d diting-core/diting` 或等价 | 父路径 | 退出码 0；目录存在 | 检查 parent_path_default 与是否已创建 diting-core |
| `test -d diting-infra/charts` 且 `test -d diting-infra/config` | 父路径 | 退出码 0；两目录均存在 | 按 repo_a.directories 补建 |
| `make -C diting-core test` | 父路径 | 退出码 0（占位通过） | 检查 Makefile 是否含 test target，见「本步骤失败时」 |

闭环点：三仓目录与 trinity_repos 一致；diting-core make test 可运行（占位通过）。

**准出检查清单**：

- [ ] 三仓存在且目录与 global_const.trinity_repos 一致
- [ ] diting-core 含 Makefile，`make test` 可运行（占位通过）
- [ ] diting-infra 含 charts/、config/、observability/、secrets/ 及 config/environments/dev/deploy.json（可为占位）
- [ ] **已更新 L5 [02_验收标准](../../../05_成功标识与验证/02_验收标准.md) 中本 stage（s0_pre）对应行（状态+验证方式）**

准出后再进入 [Stage0_骨架期](../Stage0_骨架期/README.md)。

---

## 验证结果与 L5 同步

准出时须更新 **L5 [02_验收标准](../../../05_成功标识与验证/02_验收标准.md) 中 workflow_stages 映射表 s0_pre 行**（将对应行状态更新为已通过并注明验证方式）。本目录不保留可填写的验证结果表，直接更新 L5。

---

## 本步骤失败时

- **回退**：本阶段为第一步，无上一阶段；可删除新建的 diting-core/diting-infra 目录后重做。
- **重试上限**：建议 3 次；不通过则检查路径与 L3/ DNA 是否一致后人工排查。
- **临时跳过某验证项**：须经架构师或项目负责人审批并更新 L3/DNA 与本文档。
- **验证失败时**：除回退/重试外，须输出**失败项**（未通过的命令/检查点）及**建议修正动作**（如目录检查失败 → 核对 global_const.trinity_repos 与实际路径）；若由 CI 执行，须将失败与 01_ 对应步骤链接。自动反馈修正分级见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
- 具体回退操作与检查点定义见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
