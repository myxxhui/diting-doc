# Phase2 · 03 · 回测或仿真验证

> [!NOTE] **[TRACEBACK] 战略追溯锚点**
> - **顶层概念**: [一句话定义与核心价值](../../01_顶层概念/01_一句话定义与核心价值.md)
> - **战略维度**: [01_产品设计维度](../../02_战略维度/产品设计/01_产品设计维度.md)、[06_研产同构维度](../../02_战略维度/产品设计/06_研产同构维度.md)
> - **原子能力**: [01_需求与产品范围](../../03_原子目标与规约/产品设计/01_需求与产品范围.md)、[09_核心模块架构规约](../../03_原子目标与规约/09_核心模块架构规约.md)
> - **阶段**: [Phase2_MoE与执行网关](README.md)
> - **本步骤**: Docker/K3s 下回测或仿真路径跑通，研产同构可验证

## 步骤目标

- **L3 阶段目标**：MoE 议会与执行网关接入后，回测或仿真环境可验证完整链路；满足「研产同构」：回测与实盘使用相同策略与执行抽象。
- **本步目标**：在 Docker 或 K3s（见 00_ Stage2/Stage3）下跑通回测或仿真路径；验收与 s2/s3 test_focus 对齐。

## 关键产出物

1. Docker 或 K3s 下回测/仿真任务可执行并成功结束
2. 完整链路 A→B→C→D→E→F 在回测/仿真中可验证；F 为占位或 BacktestBroker
3. 与 Stage2/Stage3 的 exit_criteria 与 test_focus 一致；结果可判定（日志或报告）
4. 环境配置或 make 目标与 Stage2/Stage3 01_ 一致

## 本步骤可开始条件（Definition of Ready）

1. Phase2 [01_](01_ModuleC_MoE议会接入.md)、[02_](02_ModuleF执行网关接入.md) 已完成。
2. [Stage2](../00_交付流程步骤/Stage2_Docker统一环境期/README.md) 或 [Stage3](../00_交付流程步骤/Stage3_K3s测试开发期/README.md) 进行中；工作目录 **diting-core** / **diting-infra** 就绪。
3. dna_dev_workflow s2/s3 的 test_focus、exit_criteria 可引用。

## 推荐模型（可选）

由执行方自选；可引用 [Phase2 README](README.md)。

## 核心指令（The Prompt）

请先阅读本步骤「实施内容」、[Stage2 01_](../00_交付流程步骤/Stage2_Docker统一环境期/01_本阶段实践与验证.md) 或 [Stage3 01_](../00_交付流程步骤/Stage3_K3s测试开发期/01_本阶段实践与验证.md)。任务：1. 在 Docker/K3s 下运行完整回测或仿真 A→F；2. 验证研产同构（同一套策略与 Broker 抽象）；3. 产出可判定结果（PnL 摘要、订单流日志）。工作目录 diting-core / diting-infra。请输出：执行命令、环境说明、结果摘要。

## Prompt 使用说明

将核心指令与 Stage2/Stage3 01_ 一起喂给 AI；执行后用「验收与测试」中的可复制命令自检。

## 技术约束（DO / DON'T / 边界）

| 类型 | 内容 |
|------|------|
| **DO** | 回测/仿真使用同一套 Broker 抽象；验收与 s2/s3 exit_criteria 对齐；工作目录 diting-core、diting-infra 按步骤标注 |
| **DON'T** | 不要依赖真实资金或实盘下单 |
| **边界** | F 可为 BacktestBroker 或 Mock；与实盘一致的数据源替换见 [Phase2 README 占位与真实实现衔接](README.md#占位与真实实现衔接) |

## 必读顺序

1. [Stage2 01_](../00_交付流程步骤/Stage2_Docker统一环境期/01_本阶段实践与验证.md) 或 [Stage3 01_](../00_交付流程步骤/Stage3_K3s测试开发期/01_本阶段实践与验证.md)
2. 本步骤「实施内容」「验收与测试」

## 依赖的 Stage

- 依赖 [Stage2_Docker统一环境期](../00_交付流程步骤/Stage2_Docker统一环境期/README.md)（s2）或 [Stage3_K3s测试开发期](../00_交付流程步骤/Stage3_K3s测试开发期/README.md)（s3）进行中；或 Phase2 前两步（01_、02_）已完成。
- **前置 Phase 步骤**：[01_ModuleC_MoE议会接入](01_ModuleC_MoE议会接入.md)、[02_ModuleF执行网关接入](02_ModuleF执行网关接入.md) 已完成。

## 前置条件

- Phase2 步骤 01_、02_ 已完成：C 与 F 已接入。
- 工作目录：**diting-core**（回测/仿真逻辑）、**diting-infra**（Docker/K3s 编排，若本步涉及环境验收）。

## 实施内容

**工作目录**：`diting-core`（主）、`diting-infra`（环境与编排）

1. **回测或仿真路径**
   - 在 Docker 或 K3s 环境中运行一次完整回测或仿真：A→B→C→D→E→F（F 为 BacktestBroker 或 MockBroker）；使用历史数据或 Mock 数据，无真实下单。
   - 环境以 00_ Stage2/Stage3 的 01_ 为准（如 `make backtest`、`docker-compose up` 或 K3s  job）。

2. **研产同构验证**
   - 同一套策略与执行抽象在回测与仿真中复用；若存在「回测用 BacktestBroker、实盘用 XtQuantBroker」的切换，本步至少验证 BacktestBroker 路径与策略输出可复现。

3. **验收与 s2/s3 对齐**
   - 满足 Stage2/Stage3 的 test_focus 与 exit_criteria：如集成/端到端测试通过、回测或仿真任务成功跑完并产出可判定的结果（如 PnL 摘要、订单流日志）。

## 验收与测试

本节即本步骤验收标准。

**验收检查项**

- [ ] Docker 或 K3s 下回测/仿真任务可执行并成功结束。
- [ ] 完整链路 A→B→C→D→E→F 在回测/仿真中可验证；F 为占位或 BacktestBroker。
- [ ] 与 Stage2/Stage3 的 exit_criteria 与 test_focus 一致；结果可判定（见下方可复制命令）。

**可复制测试命令**（工作目录：`diting-core` 或 `diting-infra`）

```bash
cd diting-core
make backtest
# 或：docker-compose up；与 Stage2/Stage3 01_ 一致
```

**成功标准**：任务成功结束、结果可判定。**失败时**：见「本步骤失败时」。**与 DoD 分工**：上列为功能/产物验收；DoD 负责提交、环境验证、Review、L5 更新。

## 本步骤准出（DoD）

- [ ] 代码/配置已提交至约定分支（工作目录 diting-core / diting-infra）
- [ ] Docker 或 K3s 下回测/仿真任务可执行并成功结束，与 s2/s3 exit_criteria 一致
- [ ] Code Review 通过（或标注豁免）
- [ ] 已更新 L5 [02_验收标准](../../05_成功标识与验证/02_验收标准.md) 中**功能验收表**本 Phase/Stage2-3 对应行（状态与验证方式）

## 输出格式 / 期望交付形态

1. 回测/仿真执行命令与环境说明；2. 可判定结果（PnL 摘要、订单流日志或报告）；3. 与 s2/s3 对齐的验证说明

## 下一步

完成本步且通过验收、DoD 全勾后，Phase2 准出；可进入 [Phase3_优化与扩展](../Phase3_优化与扩展/README.md) 或 [Stage4_与流水线衔接](../00_交付流程步骤/Stage4_与流水线衔接/README.md)。**重要**：与 Stage2/Stage3 准出条件对齐后再进入后续阶段。

## 产出物

| 产出 | 说明 |
|------|------|
| 回测/仿真可执行路径 | A→B→C→D→E→F 在 Docker/K3s 下跑通，F 为 BacktestBroker 或 Mock |
| 可判定结果 | PnL 摘要、订单流日志或报告，满足 test_focus |
| 环境配置或 make 目标 | 与 Stage2/Stage3 01_ 一致（如 make backtest、docker-compose） |

## 本步骤失败时

- **环境无法跑通**：检查 Stage2/Stage3 的 01_ 环境要求与 diting-infra 编排是否一致。
- **链路中断**：逐模块检查 A→F 接口与数据流，确认 Phase2 01_、02_ 均已准出。
- **结果不可判定**：补充日志或报告输出，满足 exit_criteria 中的可验证项。

回退与失败分级见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md)。

## Phase–Stage 接口

- **本步准出即 Stage s2 或 s3 准出条件之一**；本步验收命令纳入 [Stage2 01_](../00_交付流程步骤/Stage2_Docker统一环境期/01_本阶段实践与验证.md)、[Stage3 01_](../00_交付流程步骤/Stage3_K3s测试开发期/01_本阶段实践与验证.md) 可执行验证清单。
- **本步产出**：供 Stage2/Stage3 01_ 可执行验证清单使用；回测/仿真成功跑完为 s2/s3 准出依据之一。
- **本步依赖**：依赖 [Stage2](../00_交付流程步骤/Stage2_Docker统一环境期/README.md)（s2）或 [Stage3](../00_交付流程步骤/Stage3_K3s测试开发期/README.md)（s3）进行中；依赖 Phase2 [01_](01_ModuleC_MoE议会接入.md)、[02_](02_ModuleF执行网关接入.md) 准出。

## 本步骤涉及的 DNA 键

| DNA 键 | 用途 |
|--------|------|
| `product_scope.phases` Phase2-xxx | 本 Phase 范围 |
| `dna_dev_workflow.workflow_stages[s2]` / `[s3]` | test_focus、exit_criteria |
| `global_const.trinity_repos` | 仓库与 make 目标 |

## 逻辑密集说明

本步骤以集成与环境验证为主，**不强制全 5D**；若回测引擎含复杂规则可对关键路径做 Table-Driven 或快照测试。代码注释可标注 `[Ref: 03_回测或仿真验证]`。
