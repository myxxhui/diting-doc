# Phase1 · 03 · Module E 风控占位

> [!NOTE] **[TRACEBACK] 战略追溯锚点**
> - **顶层概念**: [一句话定义与核心价值](../../01_顶层概念/01_一句话定义与核心价值.md)
> - **战略维度**: [01_产品设计维度](../../02_战略维度/产品设计/01_产品设计维度.md)
> - **原子能力**: [09_核心模块架构规约](../../03_原子目标与规约/09_核心模块架构规约.md)（Module E）、[01_需求与产品范围](../../03_原子目标与规约/产品设计/01_需求与产品范围.md) P0 风控
> - **阶段**: [Phase1_核心链路](README.md)
> - **本步骤**: Module E 接口与占位实现（硬编码规则或白名单）

## 步骤目标

- **L3 阶段目标**：核心链路最小可跑通 — Module E 绝对风控盾以接口与占位形式接入，满足 P0 优先风控能力（硬编码规则、无 AI 参与）。
- **本步目标**：实现 Module E 的对外接口（接收 Alpha/仓位建议，输出通过/拒绝及原因）；占位实现为硬编码规则或白名单（如硬止损阈值 2%、盈亏比 ≥1.5 拒绝开仓）；若涉及规则判定则标 5D 与测试锚定。

## 关键产出物

1. Module E 风控盾接口（输入 Alpha/仓位建议，输出 Allow/Reject + reasoning）
2. 占位实现：硬止损规则（2% 或 ATR 下轨）、盈亏比 < 1.5 拒绝开仓
3. 至少 1 条边界用例（payoff_ratio=1.5、loss_ratio=0.02、零除防护）
4. 单测或占位通过，L5 功能验收表「09_ Module E」一行已更新

## 本步骤可开始条件（Definition of Ready）

1. [02_ModuleD判官最小闭环](02_ModuleD判官最小闭环.md) 已完成（Alpha/Verdict 可产出）。
2. [Stage0_骨架期](../00_交付流程步骤/Stage0_骨架期/README.md)（s0）准出，工作目录 **diting-core** 可编译/可测。
3. [09_核心模块架构规约](../../03_原子目标与规约/09_核心模块架构规约.md) Module E 接口与规则阈值已定稿。

## 推荐模型（可选）

由执行方自选；建议具备规约与边界用例理解能力。可引用 [Phase1 README 项目级推荐](README.md)。

## 核心指令（The Prompt）

请先阅读 [09_核心模块架构规约](../../03_原子目标与规约/09_核心模块架构规约.md) Module E、本步骤「实施内容」与「占位边界」。任务：1. 在 diting-core 下建立 Module E 风控接口（输入 Alpha/仓位，输出 Allow/Reject+reasoning）；2. 占位实现硬止损 2%、盈亏比 <1.5 拒绝；3. Table-Driven 边界用例（payoff=1.5、loss=0.02、零除）；4. 单测通过。工作目录 diting-core。约束：接口与 09_ 一致；占位不要求真实下单。请输出：变更文件列表、关键类型摘录、单测命令与结果摘要。

## Prompt 使用说明

将上述指令与 09_ Module E 小节一起喂给 AI；执行后用「验收与测试」中的可复制命令自检。

## 技术约束（DO / DON'T / 边界）

| 类型 | 内容 |
|------|------|
| **DO** | 接口与 09_ Module E 一致；硬止损 2%、盈亏比 1.5 可硬编码；规则判定处建议 Table-Driven；工作目录 diting-core |
| **DON'T** | 不要实现真实下单或实盘风控执行；不要与 09_ 阈值不一致 |
| **边界** | 本步为占位；占位替换为真实实现的步骤见 [Phase1 README 占位与真实实现衔接](README.md#占位与真实实现衔接) |

## 必读顺序

1. [09_核心模块架构规约](../../03_原子目标与规约/09_核心模块架构规约.md) Module E
2. 本步骤「实施内容」「占位边界」「验收与测试」

## 依赖的 Stage

- 依赖 [Stage0_骨架期](../00_交付流程步骤/Stage0_骨架期/README.md)（s0）准出、[Stage1_逻辑填充期](../00_交付流程步骤/Stage1_逻辑填充期/README.md)（s1）进行中。
- **前置 Phase 步骤**：[01_ModuleA_B骨架与接口](01_ModuleA_B骨架与接口.md)、[02_ModuleD判官最小闭环](02_ModuleD判官最小闭环.md) 已完成。

## 前置条件

- Phase1 步骤 01_、02_ 已完成：Alpha 信号与仓位建议可产出。
- 工作目录 **diting-core**。

## 实施内容

**工作目录**：`diting-core`

1. **Module E 接口**
   - 定义风控盾接口：输入为判官输出的 Alpha/仓位建议（及可选持仓、当前价等），输出为通过（Allow）/拒绝（Reject）及原因（reasoning），与 09_ Module E 及下游执行层契约一致。

2. **占位实现（P0 优先）**
   - **硬止损占位**：单笔亏损 > 2% 或价格跌破 ATR 下轨 → 返回 Reject 或触发止损动作（可为占位日志/事件，不真实下单）。
   - **盈亏比检查占位**：预期收益/风险 < 1.5 → 拒绝开仓（返回 Reject，reasoning 含「盈亏比不足」）。
   - **白名单/硬编码**：规则阈值来自 09_（2%、1.5）；无配置中心时可硬编码，后续由 DNA 或配置注入。

3. **可选**：组合相关性、Domain 上限等可在占位中返回「通过」，Phase2/Phase3 再实现。

4. **5D（若涉及规则判定）**
   - 规则判定（如 payoff_ratio 边界、loss_ratio 边界）建议 Table-Driven 单测：输入（expected_profit、expected_loss、position、current_price），期望（Allow/Reject）；边界：payoff=1.5、loss=0.02、零除等。Design 锁规则 → Drive 锚测试 → Decompose 单职责函数 → Defense 人把关。

## 验收与测试

本节即本步骤验收标准。

**验收检查项**

- [ ] Module E 接口存在，输入/输出与 09_ 及下游契约一致。
- [ ] 占位实现：硬止损规则（2% 或 ATR 下轨）、盈亏比 < 1.5 拒绝可被单测或集成路径验证。
- [ ] 单测或占位通过（见下方可复制命令）；规则判定处有边界用例。

**可复制测试命令**（工作目录：`diting-core`）

```bash
cd diting-core
go test ./diting/risk/...
# 或：make test
```

**成功标准**：退出码 0。**失败时**：见「本步骤失败时」。**与 DoD 分工**：上列为功能/产物验收；DoD 负责提交、单测、Review、L5 更新。

## 占位替换说明

本步为 **占位实现**。替换为真实风控引擎的步骤与规约见 [Phase1 README · 占位与真实实现衔接](README.md#占位与真实实现衔接)（Module E 硬编码规则/白名单 → 后续 Phase 或 03_ 风控规约中的真实规则引擎/策略）。

## 占位边界

本步为 **占位实现**。满足条件：① 接口与 09_ Module E 一致（输入 Alpha/仓位建议，输出 Allow/Reject + reasoning）；② 硬止损 2%、盈亏比 ≥1.5 的规则可占位实现（硬编码或白名单）；③ 至少 1 条边界用例通过（如 payoff_ratio=1.5 边界、loss_ratio=0.02 边界）；④ 不要求真实下单或实盘风控执行。超出则视为需真实风控引擎接入。

## 本步骤最小上下文（规则判定）

- **规则**：单笔亏损 > 2% 或价格跌破 ATR 下轨 → Reject/止损；预期收益/风险 < 1.5 → 拒绝开仓（Reject，reasoning 含「盈亏比不足」）。
- **边界**：payoff_ratio=1.5 为通过/拒绝边界；loss_ratio=0.02 为硬止损边界；零除（如 expected_loss=0）需防护。

## 5D 执行顺序（规则判定时）

| 5D 步 | 输出物 |
|-------|--------|
| 5D-1 Design | 接口与规则阈值（2%、1.5）锁死；输入/输出结构体与 09_ 一致 |
| 5D-2 Drive | Table-Driven 用例：payoff=1.5、loss=0.02、零除等，期望 Allow/Reject |
| 5D-3 Decompose | 单职责函数（如 checkPayoff、checkHardStop），单测全绿 |
| 5D-4 Defense | `go test ./...` 全绿；Review 确认与 09_ 一致；L5 对应行更新 |

## 本步骤失败时

- **单测不通过**：回到 5D-2，核对边界用例与 09_ 规则是否一致，修正实现或阈值后再跑。
- **Review 发现与 L3 不符**：列出差异（如阈值、接口字段），先改设计再改实现。
- **依赖未就绪**：确认 02_ Module D 已产出 Alpha/Verdict 结构，接口可被本步消费；否则先完成 02_。

回退与失败分级见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md)。

## 本步骤准出（DoD）

- [ ] 代码已提交至约定分支/目录（工作目录 diting-core）
- [ ] `go test ./...` 或 `make test` 在 diting-core 下全绿（含 risk 包）
- [ ] Code Review 通过（或标注豁免）
- [ ] 已更新 L5 [02_验收标准](../../05_成功标识与验证/02_验收标准.md) 中**功能验收表**「09_ Module E」一行（状态与验证方式）

## 输出格式 / 期望交付形态

1. 变更/新增文件列表（如 risk/interface.go、guard.go、*_test.go）
2. 关键接口与规则阈值摘录
3. 单测命令及通过结果摘要

## 下一步

完成本步且通过验收、DoD 全勾后，进入 [04_A到E集成与Mock准备](04_A到E集成与Mock准备.md)。**重要**：04_ 依赖 A/B/D/E 四模块均已就绪，E 占位未就绪勿进入 04_。

## 产出物

| 产出 | 说明 |
|------|------|
| `risk/interface.go` 或等价 | Module E 风控盾接口定义 |
| `risk/guard.go` 或等价 | 占位实现（硬止损、盈亏比检查） |
| `risk/*_test.go` | 边界用例（payoff=1.5、loss=0.02 等） |

## 路径与命名

- **代码路径**：`diting-core/diting/risk/`（或项目约定等价路径）。
- **业务词 → 英文**：风控 → Risk；硬止损 → HardStop；盈亏比 → PayoffRatio；通过/拒绝 → Allow/Reject。

## Phase–Stage 接口

- **本步准出即 Stage s1 准出条件之一**；本步验收命令纳入 [Stage1_逻辑填充期 01_](../00_交付流程步骤/Stage1_逻辑填充期/01_本阶段实践与验证.md) 可执行验证清单。
- **本步产出**：供 Stage1 01_ 可执行验证清单使用。
- **本步依赖**：依赖 [Stage0_骨架期](../00_交付流程步骤/Stage0_骨架期/README.md)（s0）准出；依赖 Phase1 [02_ModuleD判官最小闭环](02_ModuleD判官最小闭环.md) 准出（Alpha 结构可消费）。

## 本步骤涉及的 DNA 键

| DNA 键 | 用途 |
|--------|------|
| `product_scope.phases` Phase1-xxx | 本 Phase 范围 |
| `core_modules.module_e`（若存在） | 风控阈值（如 hard_stop_pct、payoff_min） |
| `dna_dev_workflow.workflow_stages[s1].delivery_scope` | 交付范围含 E 占位 |

## 逻辑密集说明

规则判定（盈亏比、止损比例）为逻辑密集，**建议 5D**：锁规则与边界 → Table-Driven 测试 → 原子函数 → Defense。纯接口与透传占位可简化。代码注释须标注 `[Ref: 03_ModuleE风控占位]` 或 `[Ref: 03_09]`。
