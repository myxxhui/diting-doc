# Stage2-01 基础设施与依赖部署

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **原子规约**: [_共享规约/11_数据采集与输入层规约](../../03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md)
> - **DNA stage_id**: `stage2_01`
> - **本步设计文档**: [01_基础设施与依赖设计](../../03_原子目标与规约/Stage2_数据采集与存储/01_基础设施与依赖设计.md#design-stage2-01-exit)
> - **本步 DNA 文件**: [dna_stage2_01.yaml](../../03_原子目标与规约/_System_DNA/Stage2_数据采集与存储/dna_stage2_01.yaml)
> - **下游步骤**：[02_采集逻辑与Dockerfile](02_采集逻辑与Dockerfile.md#l4-stage2-02-goal)（依赖本步数据库与连接配置示例）

<a id="l4-step-nav"></a>
## 步骤导航
- **上一步**：[04_密钥与配置模板就绪](../Stage1_仓库与骨架/04_密钥与配置模板就绪.md#l4-stage1-04-goal)
- **下一步**：[02_采集逻辑与Dockerfile](02_采集逻辑与Dockerfile.md#l4-stage2-02-goal)

## 工作目录

**diting-infra**（Chart、Schema init Job、values 与部署配置）。Chart 与中间件部署文件须**缓存于本仓**，禁止部署时从远程仓库动态拉取。

<a id="l4-stage2-01-refs"></a>
## 本步逻辑引用（AI 可读）

| 类型 | 引用 |
|------|------|
| stage_id | stage2_01 |
| dna_file | 03_原子目标与规约/_System_DNA/Stage2_数据采集与存储/dna_stage2_01.yaml |
| design_doc | 03_原子目标与规约/Stage2_数据采集与存储/01_基础设施与依赖设计.md#design-stage2-01-exit |
| l3_docs | 03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md; 03_原子目标与规约/开发与交付/02_基础设施与部署规约.md |
| l5_anchor | 05_成功标识与验证/02_验收标准.md#l5-stage-stage2_01 |

<a id="l4-stage2-01-inputs"></a>
## 本步输入（执行前必须提供，禁止臆造）

| 变量/输入 | 说明 | 来源 |
|-----------|------|------|
| **REPO_A_ROOT**（或 diting-infra 根路径） | diting-infra 仓库路径；Chart、schemas 均在此仓 | 执行环境或用户提供；**缺则不得臆造，应报错中止** |
| **KUBECONFIG** | 指向已就绪的 K3s 集群（通常由 Stage1-03 或 Stage1-04 步骤 0 产出） | 执行环境；缺则需先执行集群部署 |
| **REPO_I_ROOT**（可选，用于下游验证） | diting-core 仓库路径；用于「下游服务添加数据库连接配置并调用表数据」验证 | 执行环境；做核心验证项时必填 |

**AI 执行约束**：所有路径、release 名、namespace、Chart 名、表名**仅使用本文档、[dna_stage2_01.yaml](../../03_原子目标与规约/_System_DNA/Stage2_数据采集与存储/dna_stage2_01.yaml) 或 [01_基础设施与依赖设计](../../03_原子目标与规约/Stage2_数据采集与存储/01_基础设施与依赖设计.md) 中已写明的值**；不得臆造；本步输入缺失时中止并明确报错。

---

<a id="l4-stage2-01-version-pinning"></a>
## 版本固定与缓存约定

Chart、中间件镜像等**部署用制品必须版本固定并缓存**，禁止在部署时从远程 Helm 仓库或镜像仓库动态拉取未固定版本。

| 类别 | 约定 | 权威来源 |
|------|------|----------|
| **Helm Chart** | 所有 Chart（TimescaleDB、Redis、PostgreSQL、Sealed-Secrets 等）须**下载到本地**，存放于 `charts/dependencies/<chart-name>/`；`Chart.yaml` 内 version 固定，禁止 `helm repo add` 后直接 `helm install <repo>/<chart>` | [dna_stage2_01.yaml](../../03_原子目标与规约/_System_DNA/Stage2_数据采集与存储/dna_stage2_01.yaml) 的 `pinned_versions.charts` |
| **中间件镜像** | values 或 values-*.yaml 中镜像 tag 须固定（如 `image.tag: "15.2.0"`），禁止 `latest` 或省略 tag | DNA `pinned_versions.middleware_images` 或设计文档 [01_基础设施与依赖设计#design-stage2-01-versions](../../03_原子目标与规约/Stage2_数据采集与存储/01_基础设施与依赖设计.md#design-stage2-01-versions) |
| **Schema/init 脚本** | 建表 SQL 与 init Job 脚本存放在 diting-infra 约定路径（如 `schemas/sql/`），版本由 Git 管理，部署时使用该路径脚本 | 本步 artifacts |

**校验**：执行部署前须确认 `charts/dependencies/` 下对应目录存在且 `Chart.yaml` 中 version 与 DNA 中 `pinned_versions.charts` 一致；否则不得继续，应报错并先完成 `helm pull` 或项目约定的缓存流程。

---

## 环境

- **Minimal**：本地或轻量部署（可选单机或 Docker Compose 模拟）
- **Full**：K3s 全栈（ECS + K3s，与 Stage1-03/04 一致）

<a id="l4-stage2-01-goal"></a>
## 本步目标

TimescaleDB、Redis、PostgreSQL 部署；Schema init Job 执行建表；Sealed-Secrets 就绪。初期本地连 K3s（NodePort），后期 K3s Job。**所有部署文件（Chart、init 脚本）须缓存、版本固定**。**准出前必须完成下游关键验证**：其它服务（以采集服务为例）如何添加数据库连接配置并成功调用数据库表数据。

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[stage2_01]` | delivery_scope、exit_criteria、verification_commands、l5_stage_anchor |
| `dna_stage2_01.pinned_versions` | Chart 与中间件镜像版本固定 |
| `dna_stage2_01.verification_commands` | 可执行验证命令与预期 |
| `global_const.data_architecture`、`global_const.data_ingestion` | L1/L2 存储与采集规约 |

## 核心指令

```
你是在 diting-infra 中执行 Stage2-01（基础设施与依赖部署）的实践者。必读：03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md、03_原子目标与规约/开发与交付/02_基础设施与部署规约.md、global_const.data_architecture。本步 DNA：03_原子目标与规约/_System_DNA/Stage2_数据采集与存储/dna_stage2_01.yaml。

任务：
1. 建立基础组件 Chart（TimescaleDB、Redis、PostgreSQL），版本按 dna_stage2_01.pinned_versions 固定；Chart 须下载到本地 charts/dependencies/ 下，禁止部署时从远程仓库拉取。
2. 实现 Schema init Job，执行建表（schemas/sql 定义）；严禁在应用代码中执行 DDL。
3. 确认 Sealed-Secrets 可用；密钥注入由 Sealed-Secrets 完成。
4. 完成「验证与准出」中全部验证项，包含下游关键验证：在 diting-core（或等价下游服务）中添加数据库连接配置并调用表数据，验证通过后方可准出。
```

---

<a id="l4-stage2-01-downstream"></a>
## 关键下游引用与验证要求

本步产出被 **Stage2-02（采集逻辑与 Dockerfile）** 及后续采集/模块服务依赖。**下游必须能**：① 通过配置获得数据库连接信息；② 连接至本步部署的数据库；③ 读写本步 init Job 创建的表。因此本步准出将**下游可连接并调用表数据**列为**核心验证指标**，仅当下列全部满足时视为本步验证通过：

1. **ECS + K3s 已拉起**（或使用已有集群），TimescaleDB/Redis/PostgreSQL 已部署并 Running。
2. **Schema init Job 成功**：建表脚本执行完毕，约定表存在且可查询。
3. **下游连接配置示例已就绪且验证通过**：在文档与/或 diting-core 中提供**关键下游引用示例**——其它服务如何添加数据库连接配置（如 .env 或 ConfigMap/Secret 键）、如何连接并查询本步创建的表；并**实际执行**该示例（如在 diting-core 内用最小脚本或 make target 连接 DB 并 SELECT 一条数据），**成功后才可准出**。

**下游引用示例（必须可执行、并作为本步验证项）**：

- **配置位置**：数据库连接信息由 Sealed-Secrets 或 .env 提供；diting-core 的 `.env.template` 或文档中须注明占位项（如 `TIMESCALE_DSN`、`REDIS_URL`、`PG_L2_DSN`），与 diting-infra 部署的 Service/NodePort 对应。
- **调用表数据**：在 diting-core 中提供最小验证方式（如 `make verify-db-connection` 或等价），内容为：使用上述配置连接 TimescaleDB，执行 `SELECT 1` 或对 init 脚本所建表的简单查询，退出码 0 表示本步「下游可调用表数据」验证通过。
- 该示例的**验证执行**归属本步准出检查清单，未通过则本步不得准出。

---

<a id="l4-stage2-01-exit"></a>
## 验证与准出

### 1. 验证项列表

| 序号 | 验证项 | 核心指标 |
|------|--------|----------|
| V1 | Chart 与中间件版本固定且已缓存 | 所有 Chart 在 charts/dependencies/ 下存在，version 与 DNA 一致；镜像 tag 固定 |
| V2 | TimescaleDB 部署并可用 | Pod Running；可 psql/客户端连接 |
| V3 | Redis 部署并可用 | Pod Running；可 redis-cli PING 或等价 |
| V4 | PostgreSQL（L2 知识库）部署并可用 | Pod Running；可连接 |
| V5 | Schema init Job 成功 | Job 完成；约定表存在且可查询 |
| V6 | Sealed-Secrets 可用 | 控制器 Running；示例 Secret 可解密 |
| V7 | **下游可添加连接配置并调用表数据** | 在 diting-core 中按示例配置连接并执行对 init 所建表的查询成功（如 make verify-db-connection 退出码 0） |

### 2. 验证方式与预期目标

| 验证项 | 验证方式（可复制执行） | 预期目标 | 评判标准 |
|--------|------------------------|----------|----------|
| V1 | 在 REPO_A_ROOT 执行：`test -d charts/dependencies/timescaledb && grep -E '^version:' charts/dependencies/timescaledb/Chart.yaml`；对 redis、postgresql 同理；检查 values 中 image.tag 非 latest | 目录存在；Chart.yaml 中 version 与 dna_stage2_01.pinned_versions.charts 一致；镜像 tag 已固定 | **符合**：全部存在且版本一致；**不符合**：缺目录或 version/tag 未固定 → 不得准出 |
| V2 | KUBECONFIG 已设置时：`kubectl get pods -n <namespace> -l app.kubernetes.io/name=timescaledb`；从集群内或 NodePort 执行 `psql $TIMESCALE_DSN -c 'SELECT 1'` | Pod 状态 Running；psql 退出码 0 | **符合**：Pod Running 且 SELECT 1 成功；**不符合**：Pod 非 Running 或连接失败 → 不得准出 |
| V3 | `kubectl get pods -n <namespace> -l app.kubernetes.io/name=redis`；`redis-cli -u $REDIS_URL PING` 或等价 | Pod Running；PING 返回 PONG | **符合**：Pod Running 且 PING 成功；**不符合**：否则 → 不得准出 |
| V4 | 同 V2，针对 PostgreSQL（L2）Service/Pod；`psql $PG_L2_DSN -c 'SELECT 1'` | Pod Running；连接成功 | **符合**：Pod Running 且 SELECT 1 成功；**不符合**：否则 → 不得准出 |
| V5 | `kubectl get jobs -n <namespace>` 查看 init Job 完成；`psql $TIMESCALE_DSN -c "\\dt"` 或对约定表名 SELECT 一行 | Job Completed；约定表存在且可查 | **符合**：Job 成功且表可查；**不符合**：Job 失败或表不存在 → 不得准出 |
| V6 | `kubectl get pods -n kube-system -l app.kubernetes.io/name=sealed-secrets`；部署示例 SealedSecret 并检查 Secret 已生成 | 控制器 Running；Secret 可解密 | **符合**：控制器 Running 且解密成功；**不符合**：否则 → 不得准出 |
| V7 | 在 diting-core（REPO_I_ROOT）按文档/示例配置 TIMESCALE_DSN 等；执行 `make verify-db-connection`（或等价：连接 DB 并对 init 所建表执行 SELECT） | 命令退出码 0；能读到表数据或 SELECT 1 成功 | **符合**：退出码 0 且能连接并查询；**不符合**：配置错误或连接/查询失败 → 不得准出 |

### 3. 评判验证结果是否符合预期

- **单项评判**：每项按上表「评判标准」判定为 **符合** 或 **不符合**。
- **准出条件**：**全部七项（V1～V7）均为「符合」** 时，本步验证通过，可执行准出检查清单并更新 L5。
- **任一项不符合**：须修复后重跑该验证项，直至全部符合；不得在未通过 V7（下游连接并调用表数据）的情况下准出。

### 准出检查清单（准出时勾选并填写）

- [ ] V1：Chart/中间件版本已固定并缓存，与 DNA 一致
- [ ] V2：TimescaleDB 部署并可用
- [ ] V3：Redis 部署并可用
- [ ] V4：PostgreSQL（L2）部署并可用
- [ ] V5：Schema init Job 成功，表存在且可查
- [ ] V6：Sealed-Secrets 可用
- [ ] V7：下游（diting-core）已按示例添加数据库连接配置并成功调用表数据（如 make verify-db-connection 通过）
- [ ] **已执行清除验证环境**（diting-infra 执行 `make stage2-01-down` 与 `make down`，或 `make stage2-01-full-down`），K3s 与 ECS 均无残留
- [ ] 已更新 L5 [02_验收标准](05_成功标识与验证/02_验收标准.md#l5-stage-stage2_01) 中本 stage 对应行（状态 + 验证方式）
- [ ] 已按项目约定更新 06_ 追溯矩阵中 Stage2_01 相关行（若适用）

**验证结果去向**：L5 对应行锚点 [02_验收标准#l5-stage-stage2_01](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage2_01)；准出时注明验证方式（如「V1～V7 全部通过，含 make verify-db-connection」）。

---

<a id="l4-stage2-01-summary"></a>
## 本步实践总结

执行本步时按下列表格逐项执行并填写「是否符合预期」；**无论验证是否完成，最后一步必须执行「清除验证环境」**。

| 步骤 | 执行内容 | 预期结果 | 是否符合预期 |
|------|----------|----------|----------------|
| 1 | 在 diting-infra 执行：`test -d charts/dependencies/timescaledb && grep -E '^version:' charts/dependencies/timescaledb/Chart.yaml`，对 redis、postgresql 同理；确认 charts/values/*.yaml 存在且镜像 tag 已固定 | 三份 Chart 目录存在，Chart.yaml 中 version 与 dna_stage2_01 一致；values 中无 latest | 是 / 否 |
| 2 | 设置 KUBECONFIG，按 diting-infra/docs/Stage2-01-部署与验证.md 部署 TimescaleDB、Redis、PostgreSQL（helm upgrade --install …） | 对应 Pod 为 Running；可 psql / redis-cli 连接 | 是 / 否 |
| 3 | 创建 Secret diting-db-connection（TIMESCALE_DSN、PG_L2_DSN）；按 jobs/README.md 创建 ConfigMap 并 apply schema-init-job.yaml | Job diting-schema-init 完成；psql 可见 ohlcv、data_versions 表 | 是 / 否 |
| 4 | 确认 Sealed-Secrets 控制器 Running；可选：部署示例 SealedSecret 并检查 Secret 已解密 | 控制器 Running；Secret 可解密 | 是 / 否 |
| 5 | 在 diting-core 复制 .env.template 为 .env，填写 TIMESCALE_DSN 等；执行 `make verify-db-connection` | 退出码 0；输出含 verify-db-connection OK | 是 / 否 |
| 6 | **清除验证环境**：在 diting-infra 先执行 `make stage2-01-down`（清 K3s 上本步中间件、Job、ConfigMap），再执行 `make down`（回收 ECS/K3s）；或直接 `make stage2-01-full-down` | 无报错；K3s 与 ECS 均无残留，无继续计费 | 是 / 否 |

**说明**：步骤 2～5 依赖集群与密钥，若仅做仓内产出可只完成步骤 1 与 6（未部署则步骤 6 无需执行）。**只要起过 ECS/K3s 做验证，步骤 6 必须执行且须包含 ECS 回收（make down）**。准出须步骤 1～5 均为「是」，且步骤 6 已执行。

**与 Stage2-02 联动**：下游 [02_采集逻辑与Dockerfile](02_采集逻辑与Dockerfile.md#l4-stage2-02-deploy-deps-and-cleanup) 的步骤 2～5 均依赖本步集群与 L1/L2；实测前若无现成集群会先按本步部署依赖，再执行全部验证。**正常情况下等所有步骤验证完成后再回收**；中途失败或意外退出时也须执行同一套回收（`make stage2-01-down` + `make down`），避免 ECS 残留与计费。

---

## 本步骤失败时

- **回退目标**：上一阶段最后一步（Stage1-04 准出）。
- **重试**：建议重试上限 3 次。
- **临时跳过**：须架构师或项目负责人审批；具体回退操作见 [03_ 工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
