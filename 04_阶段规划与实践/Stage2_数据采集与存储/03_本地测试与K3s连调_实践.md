# Stage2-03 本地测试与 K3s 连调

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **原子规约**: [_共享规约/11_数据采集与输入层规约](../../03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md)
> - **DNA stage_id**: `stage2_03`
> - **本步设计文档**: [03_本地测试与K3s连调_设计](../../03_原子目标与规约/Stage2_数据采集与存储/03_本地测试与K3s连调_设计.md#design-stage2-03-exit)
> - **本步 DNA 文件**: [03_dna_本地测试与K3s连调.yaml](../../03_原子目标与规约/_System_DNA/Stage2_数据采集与存储/03_dna_本地测试与K3s连调.yaml)

<a id="l4-step-nav"></a>
## 步骤导航
- **上一步**：[02_采集逻辑与Dockerfile_实践](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-goal)
- **下一步**：[04_镜像打包与ACR推送_实践](04_镜像打包与ACR推送_实践.md#l4-stage2-04-goal)

> [!IMPORTANT] **实践测试方式约定**
> 本步以**本地 Docker Compose**为**主要（默认）**实践测试方式，可选远程 K3s；无云凭证或无需真实集群时**优先**使用本地 Compose 完成验收。见 [00_系统规则_通用项目协议](../../00_系统规则_通用项目协议.md)、[02_三位一体仓库规约](../../03_原子目标与规约/_共享规约/02_三位一体仓库规约.md)#本地开发与部署文件。

## 工作目录

**diting-core**（与 DNA work_dir / repo_i 一致）

<a id="l4-stage2-03-goal"></a>
## 本步目标

本地测试 + K3s 连调；本地进程连 K3s DB（NodePort）；MarketDataFeed 可读取 L1。交付范围见 DNA `delivery_scope`。

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[stage2_03]` | delivery_scope、exit_criteria、work_dir、verification_commands、l5_stage_anchor |
| `03_dna_本地测试与K3s连调.yaml` | work_dir、verification_commands、exit_criteria、consumes、artifacts |

## 核心指令（动作唯一对齐本小节）

**工作目录**：diting-core 根目录。以下动作为本步骤唯一对齐目标，diting-core 的 Makefile 与本小节一致。

### 必读规约与设计

- 03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md
- 03_原子目标与规约/_共享规约/05_接口抽象层规约.md（MarketDataFeed）
- 本步设计：[03_本地测试与K3s连调_设计](../../03_原子目标与规约/Stage2_数据采集与存储/03_本地测试与K3s连调_设计.md#design-stage2-03-exit)
- 本步 DNA：[03_dna_本地测试与K3s连调.yaml](../../03_原子目标与规约/_System_DNA/Stage2_数据采集与存储/03_dna_本地测试与K3s连调.yaml)

### 任务

1. 本地采集进程连接 K3s 内 TimescaleDB/Redis（NodePort），或本地 Docker Compose 提供的 L1/L2。
2. 验证至少一种数据源可写入 L1，MarketDataFeed 可读取。
3. `make ingest-test` 通过（与 DNA verification_commands 一致）。

---

<a id="l4-stage2-03-local-docker-compose"></a>
## 最佳实践一：本地 Docker Compose 手动步骤（无 K3s）

适用于日常开发、CI、无云凭证或无需真实集群；L1/L2 由本机 Docker Compose 提供，**无需** K3s。**部署与编排归属 diting-infra**，业务连接与验证在 diting-core（见 [02_三位一体仓库规约](../../03_原子目标与规约/_共享规约/02_三位一体仓库规约.md)#本地开发与部署文件）。

| 顺序 | 执行位置 | 操作内容 | 预期结果 |
|------|----------|----------|----------|
| 1 | **diting-infra** 根目录 | 启动本地 L1/L2 容器：`make local-deps-up`（使用 `compose/docker-compose.ingest.yaml`） | 容器 Running；端口 15432（L1）、15433（L2）映射到本机 |
| 2 | **diting-infra** 根目录 | 执行建表/初始化：`make local-deps-init` | 对 L1/L2 执行 `scripts/local/init_l1_ohlcv_local.sql`、`init_l2_data_versions_local.sql`；输出含「local-deps-init OK」 |
| 3 | **diting-core** 根目录 | 准备连接配置：复制 `.env.template` 为 `.env`；填写 `TIMESCALE_DSN=postgresql://postgres:postgres@localhost:15432/postgres`、`PG_L2_DSN=postgresql://postgres:postgres@localhost:15433/diting_l2` | `.env` 存在且 DSN 指向 infra 已启动的 L1/L2 |
| 4 | **diting-core** 根目录 | 验证数据库连接：`make verify-db-connection` | 退出码 0；输出含「verify-db-connection OK」 |
| 5 | **diting-core** 根目录 | 运行采集测试：`make ingest-test` | 退出码 0；L1 写入 ohlcv、L2 写入 data_versions（如 industry_revenue、news） |
| 6 | **diting-core** 根目录 | **（必做）** 验证 MarketDataFeed 读 L1：运行使用 MarketDataFeed 的脚本或单测（见 05_接口抽象层规约）。有 TimescaleDBFeed 时从 L1 读 OHLCV；**当前仓内暂无该实现时**：执行 `python3 -m pytest tests/unit/test_abstraction.py -v -k MarketDataFeed` 或等价单测并记录「MarketDataFeed 读 L1 待 TimescaleDBFeed 就绪后补验」 | 能从 L1 读取 OHLCV 数据，或单测通过且已记录待补验 |
| 7 | **diting-core** 根目录 | **（必做）** 按 [02_采集逻辑与Dockerfile_实践#目标数据约定与真实结果](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-target-data) 执行 5 条 psql 验证查询，确认 symbol、period、L2 data_type 与约定一致 | 与 docs/ingest-test-target.md 约定一致 |
| 8 | **diting-infra** 根目录 | **回收环境（必做）**：验证通过后执行 `make local-deps-down` | 本地 L1/L2 容器停止并移除；输出含「local-deps-down OK」 |

**说明**：步骤 6、7、8 为实践必做。步骤 6 在 TimescaleDBFeed 未就绪时以单测 + 记录替代；步骤 7 须执行 5 条 psql 并核对结果；步骤 8 准出前执行回收。

**仓库分工**：`docker-compose.ingest.yaml` 与 `local-deps-up/down/init` 归属 **diting-infra**；**diting-core** 仅负责 `.env` 配置与 `make verify-db-connection`、`make ingest-test`，不包含编排与建表。

---

<a id="l4-stage2-03-remote-k3s"></a>
## 最佳实践二：手动远程 K3s 实践步骤（本地进程连远程集群）

适用于需要验证与**真实 K3s 集群、NodePort、Sealed-Secrets** 一致时；L1/L2 在 **diting-infra** 部署的 K3s 上，**diting-core** 在本地通过 NodePort/节点 IP 连接。前置条件： [01_基础设施与依赖_实践](01_基础设施与依赖_实践.md) 已准出（V1～V7），或已按该文档在 diting-infra 完成部署。

| 顺序 | 执行位置 | 操作内容 | 预期结果 |
|------|----------|----------|----------|
| 1 | **diting-infra** | 确认 K3s 已就绪、TimescaleDB/Redis/PostgreSQL Pod 为 Running；Schema init Job 已完成；获取 NodePort 与节点 IP（或 LoadBalancer/Ingress 地址） | 可从集群外访问 L1/L2 端口（如 30432、30433 等，见 values） |
| 2 | **diting-infra** | 获取连接串：从 Secret `diting-db-connection` 或部署文档中取得 `TIMESCALE_DSN`、`PG_L2_DSN`、可选 `REDIS_URL`；host 填 **K3s 节点 IP**（或可访问的 LB 地址），port 填 **NodePort** | 得到完整 DSN，格式如 `postgresql://user:****@<节点IP>:<NodePort>/dbname` |
| 3 | **diting-core** 根目录 | 复制 `.env.template` 为 `.env`；将上步 DSN 填入 `TIMESCALE_DSN`、`PG_L2_DSN`、`REDIS_URL` | `.env` 中 host 为远程节点 IP，port 为 NodePort |
| 4 | **diting-core** 根目录 | 验证连接：`make verify-db-connection` | 退出码 0；能连接远程 L1/L2 并对 init 所建表查询 |
| 5 | **diting-core** 根目录 | 运行采集：`make ingest-test` | 退出码 0；数据写入**远程** L1/L2 |
| 6 | **diting-core** 根目录 | **（必做）** 验证 MarketDataFeed 读 L1：有 TimescaleDBFeed 时从远程 L1 读 OHLCV；**当前仓内暂无该实现时**：执行 MarketDataFeed 相关单测并记录「读 L1 待 TimescaleDBFeed 就绪后补验」 | 能从远程 L1 读取数据，或单测通过且已记录待补验 |
| 7 | **diting-infra** / **diting-core** | **（必做）** 验证数据落库：在集群内 `kubectl exec` 执行 psql，或在 diting-core 用 `psql $TIMESCALE_DSN -c "SELECT count(*) FROM ohlcv"` 等；并按 [02_采集逻辑与Dockerfile_实践#目标数据约定与真实结果](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-target-data) 执行 5 条 psql 验证 | 能查到本次 ingest-test 写入的数据，且 symbol/period/L2 data_type 与约定一致 |
| 8 | **diting-infra** | **回收**（若为临时验证环境）：按 [01_基础设施与依赖_实践#本步实践总结](01_基础设施与依赖_实践.md#l4-stage2-01-summary) 执行 `make stage2-01-down` 与 `make down`（或 `make stage2-01-full-down`） | 无 ECS/K3s 残留，避免继续计费 |

**注意**：远程 K3s 时，节点 IP 需为执行 `make verify-db-connection` / `make ingest-test` 的本机可访问地址（同一 VPC 或已放通安全组/防火墙）；若 K3s 在公网，须使用安全组/白名单并避免在 DSN 中写明文密码到版本库。

---

<a id="l4-stage2-03-exit"></a>
## 验证与准出

验证项与上文「核心指令」及两种最佳实践一致；命令以本实践文档为准，diting-core 实现与之对齐。

| 检查 | 工作目录 | 命令/期望结果 |
|------|----------|----------------|
| 数据库连接可用 | diting-core | `make verify-db-connection` 退出码 0；输出含「verify-db-connection OK」或等价 |
| 采集可写 L1 | diting-core | `make ingest-test` 退出码 0；L1 写入 ohlcv、L2 写入 data_versions |
| MarketDataFeed 可读 L1 | diting-core | **必做**：使用 MarketDataFeed 的脚本或单测从 L1 读取 OHLCV；当前无 TimescaleDBFeed 时执行相关单测并记录「待 TimescaleDBFeed 就绪后补验」 |
| 5 条 psql 数据验证 | diting-core | **必做**：按 [02_采集逻辑与Dockerfile_实践#目标数据约定与真实结果](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-target-data) 执行 5 条 psql，symbol、period、L2 data_type 与 docs/ingest-test-target.md 一致 |
| **本地 Docker Compose** | — | 完成「最佳实践一」步骤 1～8（含步骤 6、7、8）；步骤 6、7、8 为必做 |
| **远程 K3s** | — | 完成「最佳实践二」步骤 1～8（含步骤 6、7、8）；临时验证环境须执行步骤 8 回收 |

**准出**：任一路线完成上表对应检查（含步骤 6、7、8）；**已更新 L5 [02_验收标准 对应行](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage2_03)**。

### 准出后自检（执行方完成，无需读者再执行）

| 自检项 | 说明 |
|--------|------|
| 验证路线已注明 | 在实践总结或备注中注明本次采用的路线（「最佳实践一」或「最佳实践二」），便于追溯。 |
| 步骤 6、7 已执行 | 步骤 6：MarketDataFeed 读 L1 或单测+记录待补验；步骤 7：5 条 psql 已执行且结果与约定一致。 |
| L5 与 06_ 已同步 | 已更新 [02_验收标准](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage2_03) 中 stage2_03 行；若项目有 [02_战略追溯矩阵](../../06_追溯与审计/02_战略追溯矩阵.md)，可标明本阶段已准出。 |
| 环境回收（本地 Compose） | 已按「最佳实践一」步骤 8 在 diting-infra 执行 `make local-deps-down`。 |
| 环境回收（远程 K3s） | 若为临时验证环境，已按「最佳实践二」步骤 8 执行回收，避免继续计费。 |

**本次实践已同步完成上述 L5 更新，无需再执行。**

## 本步骤失败时

- **回退目标**：回退到上一阶段最后一步（Stage2-02 准出）；即 diting-core 采集逻辑与 Dockerfile 已就绪、`make ingest-test` 在本地或镜像内可运行。
- **重试**：建议重试上限 3 次；仍失败则按回退目标处理（修复环境或配置后重试）。
- **临时跳过**：须架构师或项目负责人审批；具体回退操作见 [03_ 工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md#八失败与回退策略)。
