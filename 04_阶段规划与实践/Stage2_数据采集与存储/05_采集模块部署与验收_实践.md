# Stage2-05 采集模块部署与验收

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **原子规约**: [_共享规约/11_数据采集与输入层规约](../../03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md)
> - **DNA stage_id**: `stage2_05`
> - **本步设计文档**: [05_采集模块部署与验收设计](../../03_原子目标与规约/Stage2_数据采集与存储/05_采集模块部署与验收_设计.md#design-stage2-05-exit)
> - **本步 DNA 文件**: [dna_stage2_05_采集模块部署与验收.yaml](../../03_原子目标与规约/_System_DNA/Stage2_数据采集与存储/dna_stage2_05_采集模块部署与验收.yaml)

<a id="l4-step-nav"></a>
## 步骤导航
- **上一步**：[04_镜像打包与ACR推送_实践](04_镜像打包与ACR推送_实践.md#l4-stage2-04-goal)
- **下一步**：[01_语义分类器_实践](../Stage3_模块实践/01_语义分类器_实践.md#l4-stage3-01-goal)

> [!IMPORTANT] **实践测试方式约定**
> 本步以**本地 Docker Compose**为**主要（默认）**实践测试方式，可选 K3s/实盘；无云凭证或无需真实集群时**优先**使用本地 Compose 完成验收。见 [00_系统规则_通用项目协议](../../../00_系统规则_通用项目协议.md)、[02_三位一体仓库规约](../../03_原子目标与规约/_共享规约/02_三位一体仓库规约.md)#本地开发与部署文件。

## 上下游关系总览

本步**消耗**：Stage2-04 准出（采集镜像已构建、本地或 ACR 可用）；**默认路线**下由 diting-infra 的 `compose/docker-compose.ingest.yaml` 提供 L1/L2，**可选路线**下 Stage2-01 在 K3s 的部署、Stage1-03（K3s 就绪）。**产出**：采集模块验收通过（默认路线为本地 Compose + diting-core 内 `make ingest-test` 与 5 条 psql；可选为 K3s 内部署）；真实数据可写入 L1/L2 且可被 Module A/B/C 消费；Stage2 准出。

<a id="l4-stage2-05-verify-routes"></a>
## 验证路线说明（必读）

本步支持两种验证路线，执行前须明确选用哪一种；**默认、推荐**为本地 Docker Compose。

| 路线 | 说明 | 适用场景 |
|------|------|----------|
| **默认：本地 Docker Compose** | 在 **diting-infra** 使用 `compose/docker-compose.ingest.yaml` 启动本地 L1/L2（`make local-deps-up` → `make local-deps-init`）；在 **diting-core** 配置 `.env` 指向 localhost:15432/15433，执行 `make ingest-test` 及 5 条 psql 验证；可选在本地构建采集镜像并用 `docker run` 连宿主机 L1/L2 执行 `make ingest-test`。无需 K3s、无云凭证。 | 日常开发、CI、无云凭证或无需真实集群时；**推荐作为默认验收路径**。 |
| **可选：K3s** | 在 **diting-infra** 部署采集镜像至 K3s（Job/CronJob 或 Deployment），集群内运行采集；或 diting-core 连 K3s 的 L1/L2（NodePort）执行 `make ingest-test` 与 5 条 psql。需 Stage2-01、Stage2-04 准出及 KUBECONFIG。 | 需验证与真实 K3s、NodePort、Sealed-Secrets 一致时。 |

**填写约定**：在验证结果或实践总结备注中注明本次采用的路线（如「默认 Docker Compose」或「可选 K3s」），便于追溯。

## 工作目录

**diting-infra**（Compose 编排、可选 K3s 部署）；**diting-core**（验证命令 `make ingest-test`、5 条 psql、可选镜像内验证）。

<a id="l4-stage2-05-local-compose"></a>
## 最佳实践一：本地 Docker Compose 手动步骤（默认，无 K3s）

适用于日常开发、CI、无云凭证或无需真实集群；L1/L2 由本机 Docker Compose 提供，**无需** K3s。**部署与编排归属 diting-infra**，业务连接与验证在 diting-core（见 [02_三位一体仓库规约](../../03_原子目标与规约/_共享规约/02_三位一体仓库规约.md)#本地开发与部署文件）。

| 顺序 | 执行位置 | 操作内容 | 预期结果 |
|------|----------|----------|----------|
| 1 | **diting-infra** 根目录 | 启动本地 L1/L2：`make local-deps-up`（使用 `compose/docker-compose.ingest.yaml`） | 容器 Running；端口 15432（L1）、15433（L2）映射到本机 |
| 2 | **diting-infra** 根目录 | 建表/初始化：`make local-deps-init` | 对 L1/L2 执行 init 脚本；输出含「local-deps-init OK」 |
| 3 | **diting-core** 根目录 | 复制 `.env.template` 为 `.env`；填写 `TIMESCALE_DSN=postgresql://postgres:postgres@localhost:15432/postgres`、`PG_L2_DSN=postgresql://postgres:postgres@localhost:15433/diting_l2` | `.env` 存在且 DSN 指向 infra 已启动的 L1/L2 |
| 4 | **diting-core** 根目录 | 验证连接：`make verify-db-connection` | 退出码 0 |
| 5 | **diting-core** 根目录 | 运行采集测试：`make ingest-test` | 退出码 0；L1 写入 ohlcv、L2 写入 data_versions（如 industry_revenue、news） |
| 6 | **diting-core** 根目录 | **（必做）** 按 [02_采集逻辑与Dockerfile_实践#目标数据约定与真实结果](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-target-data) 执行 5 条 psql 验证查询 | symbol、period、L2 data_type 与 docs/ingest-test-target.md 约定一致 |
| 7 | **diting-core**（可选） | 构建采集镜像并在**容器内**执行 `make ingest-test`（`docker run` 挂 env 或 `-e TIMESCALE_DSN=...` 连 host.docker.internal:15432/15433） | 退出码 0；证明镜像内采集链完整 |
| 8 | **diting-infra** 根目录 | **回收环境（必做）**：`make local-deps-down` | 本地 L1/L2 容器停止并移除 |

**说明**：步骤 5、6、8 为必做；步骤 7 可选，用于验证镜像内采集。**仓库分工**：Compose 与 local-deps-* 归属 **diting-infra**；**diting-core** 仅负责 `.env` 与 `make verify-db-connection`、`make ingest-test`。

---

<a id="l4-stage2-05-deps-check"></a>
## 本步依赖检查

执行本步前须按所选路线确认下列项。

| 检查项 | 说明 | 默认路线（Docker Compose） | 可选路线（K3s） |
|--------|------|----------------------------|------------------|
| L1/L2 可用 | 数据库与表就绪 | diting-infra 已执行 `make local-deps-up`、`make local-deps-init` | Stage2-01 已准出；Pod Running |
| 采集镜像/代码 | 可执行采集任务 | diting-core 已具备 `make ingest-test`（Stage2-02/03 准出）；可选本地构建镜像 | Stage2-04 镜像可用（ACR 或本地 tag） |
| 连接信息 | DSN 等 | .env 指向 localhost:15432/15433 | .env 或 Secret 指向 K3s NodePort/节点 IP |
| K3s（仅可选路线） | 集群可用 | 不需要 | `kubectl get nodes` 退出码 0；KUBECONFIG 已设置 |

**结论**：**默认路线**下无需 K3s，在 diting-infra 启动 Compose 后在 diting-core 完成验证即可准出；**可选路线**下须 Stage2-04 与 Stage2-01 准出且 K3s 可访问。

<a id="l4-stage2-05-goal"></a>
## 本步目标

采集模块验收通过；真实数据可写入 L1/L2 且可被 Module A/B/C 消费。**默认**在本地 Docker Compose 环境下完成验收（diting-core 内 `make ingest-test` + 5 条 psql）；**可选**在 K3s 内部署采集并验证。验收标准：`make ingest-test` 或 DNA 约定命令退出码 0；写入与读取验证通过；**Stage2 准出**。

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[stage2_05]` | delivery_scope、exit_criteria、work_dir、verification_commands、l5_stage_anchor |
| `dna_stage2_05_采集模块部署与验收.yaml`（若存在） | work_dir、verification_commands、data_ingestion（schedule、timeout_minutes） |
| `global_const.deployable_units.ingestion` | 可部署单元「数据采集与存储」的镜像与部署约定 |

## 核心指令（动作唯一对齐本小节）

**工作目录**：部署在 **diting-infra** 根目录（或 Chart 所在目录）；验证命令在 **diting-core** 或集群内执行。以下动作为本步骤唯一对齐目标，与设计文档 [05_采集模块部署与验收设计](../../03_原子目标与规约/Stage2_数据采集与存储/05_采集模块部署与验收_设计.md#design-stage2-05-exit) 及 [11_ 数据采集与输入层规约](../../03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md) 一致。

### 必读规约与设计

- 03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md
- 本步设计：[05_采集模块部署与验收_设计](../../03_原子目标与规约/Stage2_数据采集与存储/05_采集模块部署与验收_设计.md)
- 数据写入与读取约定：[02_采集逻辑与Dockerfile_实践#目标数据约定与真实结果](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-target-data)

### 每次执行本步骤时的动作顺序

**默认路线（本地 Docker Compose）**：按 [最佳实践一：本地 Docker Compose](#l4-stage2-05-local-compose) 步骤 1～8 执行；准出前必做步骤 5、6、8（及 5 条 psql 验证），并更新 L5。

**可选路线（K3s）**：

| 顺序 | 执行位置 | 动作 | 命令/操作 | 说明 |
|------|----------|------|------------|------|
| 0 | **diting-infra** | 确认 K3s 与依赖 | `kubectl get nodes` 退出码 0；Stage2-01 的 L1/L2 Pod 正常、Stage2-04 镜像可用 | 未通过则本步不继续 |
| 1 | **diting-infra** | 部署采集模块 | Helm/kubectl 部署采集镜像；环境变量/Secret 注入 TIMESCALE_DSN、PG_L2_DSN 等 | 与 [01_基础设施与依赖_实践](01_基础设施与依赖_实践.md) 一致 |
| 2 | **diting-infra** / **diting-core** | 触发并等待采集完成 | Job 完成或 Pod 内 `make ingest-test` 退出码 0 | 采集写入 L1/L2 |
| 3 | **diting-core** | 验证写入与读取 | .env 指向 K3s L1/L2；执行 `make ingest-test` 及 5 条 psql（见 [02_采集逻辑与Dockerfile_实践#目标数据约定与真实结果](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-target-data)） | L1 有 OHLCV、L2 有 industry_revenue 与 news |
| 4 | **diting-core** / 文档 | 准出与 L5 更新 | 确认「数据已就绪、接口/表可被下游访问」；更新 L5 [02_验收标准](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage2_05) 对应行 | Stage2 准出 |

**任务与规约引用**：调度频率与超时须与 [11_ 数据采集与输入层规约](../../03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md) 及 DNA `data_ingestion` 一致；cron/Job 在部署侧（diting-infra）配置。

<a id="l4-stage2-05-exit"></a>
## 验证与准出

验证项与所选路线一致；命令以本实践文档为准。

| 检查 | 默认路线（Docker Compose） | 可选路线（K3s） |
|------|----------------------------|------------------|
| L1/L2 可用 | diting-infra 已 `make local-deps-up`、`make local-deps-init`；diting-core `make verify-db-connection` 退出码 0 | diting-infra `kubectl get nodes` 退出码 0；TimescaleDB/PostgreSQL Pod Running |
| 采集执行成功 | diting-core `make ingest-test` 退出码 0 | 集群内或 diting-core 连 K3s 执行 `make ingest-test` 退出码 0 |
| 写入与读取验证 | diting-core 按 [02_采集逻辑与Dockerfile_实践#目标数据约定与真实结果](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-target-data) 执行 5 条 psql；L1 有 OHLCV、L2 有 `industry_revenue` 与 `news` | 同上 |
| 环境回收（默认路线） | 准出前在 diting-infra 执行 `make local-deps-down` | — |

**准出**：采集验收通过（默认路线完成最佳实践一步骤 5、6、8 并回收；可选路线完成上表）；**Stage2 准出**；**已更新 L5 [02_验收标准 对应行](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage2_05)**。

### 与系统数据需求的闭环（可被 Module A/B/C 消费）

- **本阶段验收**：确认 L1 有 OHLCV、L2 有 `industry_revenue` 与 `news`（及约定 data_type），写入与读取验证通过；下游 Stage3 可通过 MarketDataFeed、约定表或缓存读取上述数据。
- **消费方验证**：Module A 读取申万/营收（及基本面）、Module B 通过 MarketDataFeed 读 L1、Module C 读知识库，在 [Stage3 各步](../../04_阶段规划与实践/Stage3_模块实践/) 与 L5 功能验收（l5-func-00）中验证；本步准出时确认「数据已就绪、接口/表可被下游访问」即可。
- **生产部署**：调度频率与超时须与 [11_ 数据采集与输入层规约](../../03_原子目标与规约/_共享规约/11_数据采集与输入层规约.md) 及 DNA `data_ingestion`（如 `schedule: daily/hourly`、`timeout_minutes`）一致；cron/Job 配置在部署侧完成。数据量与范围：生产/扩展时须满足全市场扫描所需标的数与历史深度（见 [Stage2 README#数据采集规划与实践步骤对照](README.md#stage2-data-plan-vs-steps)）。

### 准出后自检（执行方完成）

| 自检项 | 说明 |
|--------|------|
| L5 与 06_ 已同步 | 已更新 [02_验收标准](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage2_05) 中 stage2_05 行及 [02_战略追溯矩阵](../../06_追溯与审计/02_战略追溯矩阵.md) 可交付性/Stage2 相关行，标明本阶段已准出。 |
| 调度与超时（生产） | 若为本阶段生产部署，cron/Job 的 schedule 与 timeout 已与 11_ 规约及 DNA 一致。 |

## 本步骤失败时

- **回退目标**：采集模块部署失败或验证不通过时，回退到 Stage2-04 准出状态（镜像可用、未部署或部署可回滚）。
- **重试**：建议重试上限 3 次（如镜像拉取失败、Pod 未就绪）；仍失败则按回退目标处理，并检查 L1/L2 连接与 Secret 配置。
- **临时跳过**：须架构师或项目负责人审批；具体回退操作见 [03_ 工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md)。

## 本步实践总结

**默认路线（推荐）**：按 [最佳实践一：本地 Docker Compose](#l4-stage2-05-local-compose) 步骤 1～8 执行；步骤 5、6、8 必做，步骤 7 可选（镜像内验证）。完成后更新 L5 与 02_战略追溯矩阵。

| 步骤 | 执行内容（默认路线） | 预期结果 | 是否符合预期 |
|------|----------------------|----------|----------------|
| 1 | [本步依赖检查](#l4-stage2-05-deps-check)（默认：diting-infra 已 local-deps-up/init） | 依赖就绪 | ✅ |
| 2 | diting-infra `make local-deps-up`、`make local-deps-init`；diting-core 配置 .env 并 `make verify-db-connection` | 退出码 0 | ✅ |
| 3 | diting-core `make ingest-test` | 退出码 0；L1/L2 写入 | ✅ |
| 4 | diting-core 执行 5 条 psql 验证（见 [02_实践#目标数据约定与真实结果](02_采集逻辑与Dockerfile_实践.md#l4-stage2-02-target-data)） | 与约定一致 | ✅ |
| 5 | diting-infra `make local-deps-down`；更新 L5、02_战略追溯矩阵 | Stage2 准出 | ✅ |

**本次实践备注**：采用**默认路线 Docker Compose**；环境为 podman-compose（网络名 `compose_default`，init 时使用 `make local-deps-init COMPOSE_NETWORK=compose_default`）；因本机无 akshare 依赖，使用 `DITING_INGEST_MOCK=1 make ingest-test` 写入 mock 数据完成验收。5 条 psql 结果：L1 为 000001.SZ/600000.SH daily、30 行；L2 为 industry_revenue 1 条、news 2 条。

**可选路线（K3s）**：确认 [本步依赖检查](#l4-stage2-05-deps-check) 可选列满足后，按「每次执行本步骤时的动作顺序」可选路线表执行；验证结果以 [验证与准出](#l4-stage2-05-exit) 表为准。
