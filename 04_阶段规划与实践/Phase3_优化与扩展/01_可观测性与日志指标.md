# Phase3 · 01 · 可观测性与日志指标

> [!NOTE] **[TRACEBACK] 战略追溯锚点**
> - **顶层概念**: [一句话定义与核心价值](../../01_顶层概念/01_一句话定义与核心价值.md)
> - **战略维度**: [04_生产保障与可观测性维度](../../02_战略维度/产品设计/04_生产保障与可观测性维度.md)
> - **原子能力**: [08_心跳协议与健康检查规约](../../03_原子目标与规约/08_心跳协议与健康检查规约.md)、[09_核心模块架构规约](../../03_原子目标与规约/09_核心模块架构规约.md)（指标与日志）
> - **阶段**: [Phase3_优化与扩展](README.md)
> - **本步骤**: 日志/指标/健康检查满足 L3 production_requirements.observability

## 步骤目标

- **L3 阶段目标**：优化与扩展阶段满足生产级可观测性；日志、指标与健康检查与 [08_心跳协议与健康检查规约](../../03_原子目标与规约/08_心跳协议与健康检查规约.md) 及 `global_const.production_requirements.observability` 一致。
- **本步目标**：落地 observability 配置或实现：结构化日志、关键指标（Prometheus）、健康检查/心跳端点；满足 L3 对可观测性的验收要求。

## 关键产出物

1. 结构化日志可输出；log_level 可配置
2. 至少关键指标（DNA key_metrics）可被 Prometheus 采集或等价暴露
3. 健康检查或心跳端点可用，与 08_ 规约一致（或占位可扩展）
4. 与 global_const.production_requirements.observability 约定项对齐
5. L5 功能验收表本步对应行已更新

## 本步骤可开始条件（Definition of Ready）

1. Phase1、Phase2 核心链路与 MoE/执行网关已就绪；核心服务可在 Docker/K3s 中运行。
2. 工作目录 **diting-core**（埋点）、**diting-infra**（若涉及 Prometheus）可编辑。
3. [08_心跳协议与健康检查规约](../../03_原子目标与规约/08_心跳协议与健康检查规约.md)、DNA observability 已定稿。

## 推荐模型（可选）

由执行方自选；可引用 [Phase3 README](README.md)。

## 核心指令（The Prompt）

请先阅读 [08_心跳协议与健康检查规约](../../03_原子目标与规约/08_心跳协议与健康检查规约.md)、global_const.production_requirements.observability、本步骤「实施内容」。任务：1. 落地结构化日志与 log_level；2. 暴露关键指标（Prometheus 或等价）；3. 实现 /health 或心跳端点；4. 可验证（curl /health、Prometheus 抓取）。工作目录 diting-core / diting-infra。请输出：变更列表、关键配置摘录、验证命令与结果摘要。

## Prompt 使用说明

将核心指令与 08_、DNA observability 一起喂给 AI；执行后用「验收与测试」中的可复制命令自检。

## 技术约束（DO / DON'T / 边界）

| 类型 | 内容 |
|------|------|
| **DO** | 与 08_ 及 DNA observability 一致；工作目录 diting-core、diting-infra 按步骤标注 |
| **DON'T** | 不要暴露敏感信息（如密钥）于日志或指标 |
| **边界** | Tracing 可选；占位可扩展 |

## 必读顺序

1. [08_心跳协议与健康检查规约](../../03_原子目标与规约/08_心跳协议与健康检查规约.md)
2. DNA production_requirements.observability；本步骤「实施内容」「验收与测试」

## 依赖的 Stage

- 依赖 [Stage2_Docker统一环境期](../00_交付流程步骤/Stage2_Docker统一环境期/README.md)、[Stage3_K3s测试开发期](../00_交付流程步骤/Stage3_K3s测试开发期/README.md) 进行中或准出。
- **前置 Phase**：Phase1、Phase2 核心链路与 MoE/执行网关已就绪。

## 前置条件

- 核心服务可在 Docker/K3s 中运行。
- 工作目录：**diting-core**（埋点与日志）、**diting-infra**（若涉及 Prometheus/采集配置）。

## 实施内容

**工作目录**：`diting-core`（主）、`diting-infra`（可选）

1. **日志**
   - 按 `production_requirements.observability.logging`：结构化日志、log_level、log_retention_days；与 09_ 各模块日志约定一致（如 classifier、scanner、verdict、execution）。

2. **指标**
   - 按 `production_requirements.observability.metrics`：Prometheus 启用、关键指标暴露（如 diting_classifier_latency_seconds、diting_scanner_duration_seconds、diting_verdict_win_rate、diting_execution_success_rate 等，见 global_const）。

3. **健康检查与心跳**
   - 按 [08_心跳协议与健康检查规约](../../03_原子目标与规约/08_心跳协议与健康检查规约.md)：关键组件心跳上报或 /health 端点；超时熔断策略可配置或占位。

4. **可选**：Tracing（OpenTelemetry）按 observability.tracing 配置；采样率与 L3 一致。

## 验收与测试

本节即本步骤验收标准。

**验收检查项**

- [ ] 结构化日志可输出；log_level 可配置。
- [ ] 至少关键指标（见 DNA key_metrics）可被 Prometheus 采集或等价暴露。
- [ ] 健康检查或心跳端点可用；与 08_ 规约一致（或占位可扩展）。
- [ ] 与 global_const.production_requirements.observability 约定项对齐。

**可复制测试命令**（工作目录：`diting-core` 或服务地址）

```bash
curl -s http://localhost:8080/health
# Prometheus 抓取或等价验证
```

**成功标准**：/health 返回 200；指标可采集。**失败时**：见「本步骤失败时」。**与 DoD 分工**：上列为功能/产物验收；DoD 负责提交、验证、Review、L5 更新。

## 本步骤准出（DoD）

- [ ] 代码/配置已提交至约定分支（工作目录 diting-core / diting-infra）
- [ ] 结构化日志、关键指标、健康检查/心跳按 L3 与 DNA 约定落地，可验证（如 curl /health、Prometheus 抓取）
- [ ] Code Review 通过（或标注豁免）
- [ ] 已更新 L5 [02_验收标准](../../05_成功标识与验证/02_验收标准.md) 中**功能验收表**本步对应行（状态与验证方式）

## 输出格式 / 期望交付形态

1. 变更/配置列表；2. 关键指标与端点说明；3. 验证命令与结果摘要

## 下一步

完成本步且通过验收、DoD 全勾后，进入 [02_成本治理与Token熔断](02_成本治理与Token熔断.md)。**重要**：可观测性未就绪会影响 Stage3/Stage4 环境观测与灰度验收。

## 产出物

| 产出 | 说明 |
|------|------|
| 日志配置与埋点 | 结构化日志、log_level、与 09_ 各模块约定一致 |
| 指标暴露（Prometheus 或等价） | key_metrics 清单中至少关键项可采集 |
| 健康检查/心跳端点 | 与 08_ 规约一致或占位可扩展 |

## 本步骤失败时

- **指标或日志与 L3 不一致**：对照 `production_requirements.observability` 与 08_ 修正字段与端点。
- **健康检查不可用**：检查端点路径与超时配置，与 08_ 心跳协议一致。
- **依赖未就绪**：确认 Phase2 与 Stage2/Stage3 环境可运行；否则先完成前置阶段。

回退与失败分级见 [03_项目全功能开发测试实践工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md)。

## Phase–Stage 接口

- **本步准出即 Stage s3 准出条件之一**；本步验收命令纳入 [Stage3_K3s测试开发期 01_](../00_交付流程步骤/Stage3_K3s测试开发期/01_本阶段实践与验证.md)、[Stage4_与流水线衔接 01_](../00_交付流程步骤/Stage4_与流水线衔接/01_本阶段实践与验证.md) 可执行验证清单。
- **本步产出**：供 Stage3/Stage4 01_ 可观测性验收使用；环境观测/灰度/回滚依赖本步指标与健康检查。
- **本步依赖**：依赖 [Stage2](../00_交付流程步骤/Stage2_Docker统一环境期/README.md)、[Stage3](../00_交付流程步骤/Stage3_K3s测试开发期/README.md) 进行中或准出；依赖 Phase1、Phase2 核心链路就绪。

## 本步骤涉及的 DNA 键

| DNA 键 | 用途 |
|--------|------|
| `production_requirements.observability` | metrics、logging、tracing、健康检查 |
| `production_requirements.observability.metrics.key_metrics` | 关键指标清单 |
| `dna_08_heartbeat_and_healthcheck`（若存在） | 心跳与健康检查规约 |

## 逻辑密集说明

本步骤以配置与埋点为主，**不强制 5D**。代码注释可标注 `[Ref: 01_可观测性与日志指标]`。
