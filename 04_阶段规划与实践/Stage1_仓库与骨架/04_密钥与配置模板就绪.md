# Stage1-04 密钥与配置模板就绪

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **原子规约**: [_共享规约/02_三位一体仓库规约](../../03_原子目标与规约/_共享规约/02_三位一体仓库规约.md)、[02_基础设施与部署规约](../../03_原子目标与规约/开发与交付/02_基础设施与部署规约.md)
> - **DNA stage_id**: `stage1_04`
> - **本步设计文档**: [04_密钥与配置模板设计](../../03_原子目标与规约/Stage1_仓库与骨架/04_密钥与配置模板设计.md#design-stage1-04-exit)
> - **本步 DNA 文件**: [dna_stage1_04.yaml](../../03_原子目标与规约/_System_DNA/Stage1_仓库与骨架/dna_stage1_04.yaml)

<a id="l4-step-nav"></a>
## 步骤导航
- **上一步**：[03_基础设施ECS与K3s就绪](03_基础设施ECS与K3s就绪.md#l4-stage1-03-goal)
- **下一步**：[01_基础设施与依赖部署](../Stage2_数据采集与存储/01_基础设施与依赖部署.md#l4-stage2-01-goal)

## 工作目录

- **主工作目录**：**diting-infra** 根目录（repo_a）。
- **跨仓**：.env.template 须同时存在于 **diting-core** 根目录；实践文档同步、L1 脚本执行涉及 **diting-doc** 与 diting-infra。

<a id="l4-stage1-04-inputs"></a>
## 本步输入（执行前必须提供，禁止臆造）

| 变量/输入 | 说明 | 来源 |
|-----------|------|------|
| **REPO_A_ROOT**（或 diting-infra 根路径） | diting-infra 仓库的绝对或相对路径；用于 L1 脚本 `INFRA_DIR`、任务 0～4 的工作目录 | 执行环境或用户提供；**缺则不得臆造，应报错中止** |
| **REPO_I_ROOT**（或 diting-core 根路径） | diting-core 仓库路径；用于 .env.template 放置 | 执行环境或用户提供；缺则报错 |
| **DOC_REPO_ROOT**（或 diting-doc 根路径） | 文档仓路径；用于读取附件、执行 verify_stage1_04.sh | 执行环境或用户提供；缺则报错 |
| **KUBECONFIG**（可选） | 若已有 03 步集群则需指向该集群；若由本步**按下方动作顺序先部署集群**则无需预先提供 | 执行环境 |

**04 独立实现**：按下方「每次执行本步骤时的动作顺序」执行即可在无现成集群时独立完成。

**执行顺序强制约定（AI 与人工均须遵守）**：
- **等待步骤 0 完成再继续**：若执行步骤 0（部署集群），**必须等待步骤 0 命令执行完成后**再执行步骤 1；不得在步骤 0 未完成时进入步骤 1～6。
- **顺序执行 1～6，全部完成再退出**：步骤 0 完成后，依次执行步骤 1、2、3、4、5、6；**所有步骤（0～6）执行完成后方可退出程序**。
- **中途失败且无法修复时**：若步骤 1～4 中某步执行失败且无法修复，则**执行步骤 5（make down）回收步骤 0 所创建资源**，**等待回收完成后再退出程序**（以失败结束）；不得在未执行步骤 5 的情况下直接退出。
- **两点强制要求**：1）**明确显示验证结果**——每步（0～6）执行后须明确输出或记录「通过/失败/未执行」及关键命令输出，全流程结束前输出 **=== 验证结果 ===** 汇总表（见下方格式）；2）**等待资源回收完成再退出**——执行 `make down` 后须**等待命令执行完成**再结束；若 `make down` 失败则**输出报错与说明**（如建议手动 `make down` 或 `FULL_DESTROY=1 make down`），**以失败结束**。

**AI 执行约束**：所有路径、release 名、Secret 名、namespace、Chart 路径**仅使用本文档、[dna_stage1_04.yaml](../../03_原子目标与规约/_System_DNA/Stage1_仓库与骨架/dna_stage1_04.yaml) 或 [04_密钥与配置模板设计](../../03_原子目标与规约/Stage1_仓库与骨架/04_密钥与配置模板设计.md) 中已写明的值**；不得臆造；本步输入缺失时中止并明确报错。**config 仅使用根目录**：部署配置单一 YAML 为 `config/deploy.yaml`，**禁止创建或使用 `config/environments/dev/` 目录**。

<a id="l4-stage1-04-goal"></a>
## 本步骤目标

引入 Sealed-Secrets（官方最新稳定版 Chart **须下载到本地**，放置于 diting-infra 约定路径如 `charts/dependencies/sealed-secrets`，**不引用远程 Helm 仓库**）；diting-infra secrets/ 含模板或说明；.env.template **双仓**占位（diting-core + diting-infra，不含真实 Key）；config 为**单一 YAML**（`config/deploy.yaml`，**禁止创建 `config/environments/dev/` 目录**）模板符合 deploy-engine DeploymentConfig。

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[stage1_04]` | delivery_scope、exit_criteria、verification_commands、l5_stage_anchor |
| `dna_stage1_04.sealed_secrets` | chart_version、kubeseal_cli_version、public_key_path |
| `dna_stage1_04.practice_doc_template`、`dna_stage1_04.verify_script` | 实践文档模板与 L1 验证脚本（1:1:1 落地） |
| `global_const.trinity_repos.repo_a` | config 结构、deploy-engine 引用 |

## 核心指令

```
你是在 diting-infra 中执行 Stage1-04（密钥与配置模板就绪）的实践者。

执行前必读：① 本文档「本步输入」：REPO_A_ROOT、REPO_I_ROOT、DOC_REPO_ROOT 必须已提供，缺则报错中止，不得臆造路径。② 03_原子目标与规约/_共享规约/02_三位一体仓库规约.md、03_原子目标与规约/开发与交付/02_基础设施与部署规约.md。
禁止写明文密钥。所有路径、release 名、Secret 名、namespace 仅使用本文档、dna_stage1_04.yaml 或 04_密钥与配置模板设计 中已写明的值，不得臆造。

公钥存放于 secrets/certs/（方案 A 进 Git）；加密时使用 kubeseal --cert=secrets/certs/sealed-secrets-public.pem（或 -dev/-prod）指定。

任务：
0. **实践文档落地**：将文档仓 [附件_secrets_加密流程与案例.md](附件_secrets_加密流程与案例.md) 内容同步至 diting-infra 的 `secrets/README.md` 或 `secrets/01_加密流程与案例.md`（设计→DNA→L4 1:1:1 引用，本步必须落地）。
1. 在 secrets/ 下建立 Sealed-Secrets 模板或 README 说明（如何生成加密 YAML）；Sealed-Secrets Chart **须下载到本地**（如 helm pull 后解压或 git clone 对应 chart），放入 charts/dependencies/sealed-secrets 或约定路径，**不引用远程库**；公钥置于 secrets/certs/ 下约定文件名。
2. 在 diting-core 根目录与 diting-infra 根目录均添加 .env.template，仅含占位符（如 API_KEY=xxx、DB_URL=xxx）；应用相关以 diting-core 为权威，diting-infra 可多出 infra 专用项。
3. 确保 config/deploy.yaml（单一 YAML，**不要创建 config/environments/dev/ 目录**）符合 deploy-engine DeploymentConfig；diting-infra 通过 Git 引用 deploy-engine。
4. **L2/L3 在 04 步内完成**：在 K3s 上部署 Sealed-Secrets 控制器、示例 SealedSecret，并部署一测试 Pod 挂载该 Secret，验证 Pod 内可读取（不拖到 Stage2）。集群由本步**按下方动作顺序先部署**（`make deploy-dev`），验证完成后**按顺序执行 `make down` 并等待完成**；验证结果须**明确显示**，资源回收须**等待完成**，回收失败须**报错并说明**。
```

<a id="l4-stage1-04-exit"></a>
## 验证与准出

### 每次执行本步骤时的动作顺序

**执行原则**：① **先等待步骤 0 完成**——若执行步骤 0，必须等待其命令执行完成后，再执行步骤 1；② **再顺序执行 1～6**——步骤 0 完成后依次执行步骤 1、2、3、4、5（资源回收）、6（验证结果汇总）；③ **全部步骤执行完毕后再退出**——所有步骤（0～6）执行完成后方可退出程序；④ **中途失败且无法修复时**——若步骤 1～4 中某步失败且无法修复，则执行步骤 5（make down）回收步骤 0 所创建资源，**等待回收完成后再退出**（以失败结束）。每步执行后**明确输出或记录验证结果**；步骤 5 执行后须**等待命令执行完成**再执行步骤 6，回收失败则**输出报错与说明并以失败结束**。

| 顺序 | 动作 | 命令/操作（工作目录见列说明） | 说明 |
|------|------|-------------------------------|------|
| 0 | 部署集群（或确认已有集群） | 若已有可用集群且 KUBECONFIG 可用，**可跳过**；否则在 **diting-infra 根目录**执行 `make deploy-dev`（同 [03_基础设施ECS与K3s就绪](03_基础设施ECS与K3s就绪.md)） | **必须等待本步命令执行完成后**再执行步骤 1；若本步失败则执行步骤 5 回收已创建资源后退出 |
| 1 | 导出 KUBECONFIG 并确认集群 | `export KUBECONFIG=~/.kube/config-diting-dev`（或终端提示路径），再 `kubectl get nodes` | **明确输出**：节点列表可见即通过；失败且无法修复则执行步骤 5 后退出 |
| 2 | L1 验证 | 在 **diting-doc 根目录**：`INFRA_DIR="$REPO_A_ROOT" bash scripts/verify_stage1_04.sh` | **明确输出**：退出码 0 即「L1 验证：通过」；失败且无法修复则执行步骤 5 后退出 |
| 3 | L2 验证 | 在 **diting-infra 根目录**（已 export KUBECONFIG）：① helm install sealed-secrets；② kubectl apply secrets/ 下示例 SealedSecret；③ 检查控制器 Pod Running、Secret 存在 | **明确输出**：控制器 Running、Secret 存在即「L2 验证：通过」；失败且无法修复则执行步骤 5 后退出 |
| 4 | L3 验证 | 在 **diting-infra 根目录**：部署测试 Pod envFrom secret，`kubectl exec … env` 检查 API_KEY 等；完成后删除测试 Pod | **明确输出**：env 中可见非占位符即「L3 验证：通过」；失败且无法修复则执行步骤 5 后退出 |
| 5 | **资源回收** | 在 **diting-infra 根目录**执行 `make down`，**等待命令执行完成** | **两种情形**：(1) 步骤 0～4 全部成功后执行（正常回收）；(2) 步骤 1～4 中某步失败且无法修复时执行（回收步骤 0 资源后退出）。执行后须等待完成再执行步骤 6；失败则输出报错与说明，以失败结束 |
| 6 | **验证结果汇总** | 输出 **=== 验证结果 ===** 表（见下方格式），逐项填写步骤 0～6 的 通过/失败/未执行 及简短说明 | **必须输出**，便于人工与 CI 判定；全流程结束前输出 |

**=== 验证结果 === 汇总表格式（全流程结束前必须输出）**

| 步骤 | 名称 | 结果 | 说明（一行） |
|------|------|------|--------------|
| 0 | 部署集群 / 确认集群 | 通过 / 失败 / 跳过 | 如：kubectl get nodes 可见节点；或 make deploy-dev 失败原因 |
| 1 | 导出 KUBECONFIG 并确认 | 通过 / 失败 | 如：节点列表可见 |
| 2 | L1 验证 | 通过 / 失败 | 如：verify_stage1_04.sh 退出码 0 |
| 3 | L2 验证 | 通过 / 失败 | 如：Sealed-Secrets 控制器 Running，Secret 存在 |
| 4 | L3 验证 | 通过 / 失败 | 如：kubectl exec … env 可见 API_KEY |
| 5 | 资源回收 make down | 通过 / 失败 / 未执行 | 正常：步骤 0～4 全部完成后执行；中途失败：步骤 1～4 某步无法修复时执行回收后退出。未执行：仅当步骤 0 未创建任何资源且未执行步骤 0 时 |
| 6 | 验证结果汇总 | — | 本表即汇总 |

### 验证表（与上表对应，可复制命令逐项核对）

| 要求 | 验证步骤（可复制执行，路径/名称以 DNA 与下表为准） | 目标结果 |
|------|-----------------------------------------------|----------|
| **L1 验证** | 在 diting-doc 根目录执行：`INFRA_DIR="$REPO_A_ROOT" ./scripts/verify_stage1_04.sh`；或按下表 L1 相关行逐项执行 | 脚本退出码 0 或逐项通过 |
| Chart 模板参数生效 | 在 diting-infra 根目录：`helm template sealed-secrets charts/dependencies/sealed-secrets -f charts/dependencies/sealed-secrets/values.yaml`（若无 values.yaml 可省略 `-f` 段），检查输出含 replicaCount、namespace 等 | 渲染结果与 values 一致 |
| 符合 deploy-engine | 在 diting-infra 根目录：`deploy-engine -config=config/deploy.yaml -dry-run`（或 diting-infra Makefile 约定命令），退出码 0 | 配置可被 deploy-engine 加载 |
| diting-infra Git 引用 deploy-engine | 在 diting-infra 根目录：`test -d deploy-engine`；或 `git submodule status` | 目录存在或 submodule 已配置 |
| secrets 与 config | 在 diting-infra 根目录：`test -d secrets && test -f config/deploy.yaml`（**仅使用 config 根目录，不创建 config/environments/dev/**） | 退出码 0 |
| 公钥文件存在 | 在 diting-infra 根目录：`test -f secrets/certs/sealed-secrets-public.pem || test -f secrets/certs/sealed-secrets-public-dev.pem` | 退出码 0 |
| .env.template 双仓无真实 Key | 人工或脚本检查 REPO_I_ROOT 与 REPO_A_ROOT 下的 .env.template，确认无真实密钥 | 仅占位符 |
| **L2 集群内（04 步内完成）** | 在 diting-infra 根目录、KUBECONFIG 指向 03 步集群：① `helm install sealed-secrets charts/dependencies/sealed-secrets -n kube-system`（或 diting-infra 约定命令）；② 部署 secrets/ 下任一 SealedSecret YAML（如已存在的示例）；③ `kubectl get pods -n kube-system -l app.kubernetes.io/name=sealed-secrets` 为 Running；`kubectl get secret -A` 可见解密出的 Secret | 控制器 Running；SealedSecret 解密成功 |
| **L3 端到端（04 步内完成）** | 部署一 Pod 使用 `envFrom` 引用 L2 中解密得到的 Secret（Secret 名以设计文档「组件引用契约」为准，如 diting-akshare-secrets）；然后 `kubectl exec <pod_name> -n <namespace> -- env` 检查环境变量非占位符 | Pod 内可读取非占位符密钥 |
| **验证结果显式输出** | 每步（L1/L2/L3）执行后**明确打印**通过/失败及关键输出（如 L2 的 `kubectl get pods`、L3 的 `kubectl exec … env`）；全流程结束前打印 **=== 验证结果 ===** 汇总 | 便于人工与 CI 判定 |
| **资源回收（必等完成）** | 在 diting-infra 根目录执行 `make down`，**必须等待命令执行完成**（Terraform destroy 可能需数分钟）；若步骤 1～4 中某步失败且无法修复，**须先执行本步（步骤 5 资源回收）回收步骤 0 资源再退出**；若 `make down` 失败则**返回非零退出码**并**输出报错与说明**（如残留资源、建议手动 `make down` 或 `FULL_DESTROY=1 make down`），不得静默忽略 | 回收完成后再退出；失败时退出码 1 + 说明 |

### 准出与验证结果同步

**准出条件**：实践文档已同步至 diting-infra secrets/；secrets/ 含 Sealed-Secrets 模板或说明；config 单一 YAML 模板可用；公钥按约定存放；**L1/L2/L3 均在 04 步内完成**；.env.template 双仓就绪。

**验证结果去向（必须执行，不得遗漏）**：

1. **本文档「准出检查清单」**：勾选下方清单并填写验证方式摘要。
2. **L5 对应行**：[02_验收标准](../../05_成功标识与验证/02_验收标准.md) 的 workflow_stages 表行为 [#l5-stage-stage1_04](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage1_04)；该表无「状态」列，准出即视为该行已验收。若 02_验收标准 或项目约定允许在该行补充验证方式/链接，则在此注明。
3. **06_ 追溯矩阵**：更新 [06_追溯与审计/02_战略追溯矩阵.md](../../06_追溯与审计/02_战略追溯矩阵.md) 中与 **Stage1_仓库与骨架**、**安全与机密治理** 相关的行（表「追溯矩阵」中 L4 列为 Stage1 或密钥相关的行）：将「状态」由 ⏳ 改为 ✅，并在「备注」中注明「stage1_04 准出，验证方式：<简述>」。

**AI 执行约束（再次强调）**：仅使用本文档与 DNA、设计文档中已出现的路径、名称与命令；不得臆造；本步输入缺失时中止并报错。

---

### 本次执行验证结果汇总（2026-02-23 按文档顺序执行，步骤 0～6 全部完成）

**=== 验证结果 ===**（全流程结束前必须输出下表，每步一行）

| 步骤 | 名称 | 结果 | 说明（一行） |
|------|------|------|--------------|
| 0 | 部署集群 / 确认集群 | **通过** | 无现有集群，在 diting-infra 执行 make deploy-dev，等待完成（约 3.7 分钟），kubectl get nodes 可见节点 Ready |
| 1 | 导出 KUBECONFIG 并确认 | **通过** | export KUBECONFIG=~/.kube/config-diting-dev 后 kubectl get nodes 可见 control-plane Ready |
| 2 | L1 验证 | **通过** | INFRA_DIR 指向 diting-infra 执行 verify_stage1_04.sh，退出码 0 |
| 3 | L2 验证 | **通过** | helm install sealed-secrets -n kube-system 成功；等待 controller 就绪后用当前集群证书生成 SealedSecret 并 apply；控制器 Running，Secret diting-akshare-secrets 存在 |
| 4 | L3 验证 | **通过** | 部署测试 Pod envFrom diting-akshare-secrets，kubectl exec … env 可见 API_KEY=test-value-placeholder；已删除测试 Pod |
| 5 | 资源回收 make down | **通过** | 步骤 0～4 全部成功后执行 make down，Terraform destroy 完成，3 个资源已销毁 |
| 6 | 验证结果汇总 | — | 本表即汇总 |

**约定说明**：本次按文档先等待步骤 0 完成、再顺序执行 1～6（步骤 5 资源回收、步骤 6 验证结果汇总）；全部步骤执行完毕后再退出。

### 准出检查清单（准出时勾选并填写）

- [ ] 任务 0：实践文档已同步至 diting-infra 的 secrets/README.md 或 secrets/01_加密流程与案例.md
- [ ] 任务 1～4 已完成（Sealed-Secrets 本地 Chart、.env.template 双仓、config、L2/L3 在 04 步内完成）
- [ ] L1 验证：已执行 `INFRA_DIR="$REPO_A_ROOT" ./scripts/verify_stage1_04.sh` 且退出码 0，或按验证表 L1 行逐项通过
- [ ] L2 验证：Sealed-Secrets 控制器 Running；示例 SealedSecret 已解密为 Secret
- [ ] L3 验证：测试 Pod 已挂载 Secret 且 `kubectl exec … env` 可读取非占位符
- [ ] 已输出 **=== 验证结果 ===** 汇总表（步骤 0～6 每步 通过/失败/未执行 + 说明）
- [ ] 步骤 5 资源回收：步骤 0～4 全部成功后执行 make down，或步骤 1～4 中某步失败且无法修复时执行 make down 回收后退出；**须等待 make down 完成后再执行步骤 6**
- [ ] 已更新 06_追溯与审计/02_战略追溯矩阵.md 中 Stage1/密钥相关行状态与备注
- [ ] 已按项目约定更新 L5 02_验收标准 对应行（若可补充验证方式）

**验证方式摘要（必填）**：_____________________（例：步骤 0 集群就绪；L1 脚本通过；L2 helm install + 示例 SealedSecret；L3 busybox Pod envFrom 验证通过；步骤 5 make down 完成；步骤 6 输出汇总表）

## 本步骤失败时

- **回退目标**：上一阶段最后一步（Stage1-03 准出）。
- **重试**：建议重试上限 3 次。
- **临时跳过**：须架构师或项目负责人审批；具体回退操作见 [03_ 工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md)。
