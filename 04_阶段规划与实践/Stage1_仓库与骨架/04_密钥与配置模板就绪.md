# Stage1-04 密钥与配置模板就绪

> [!NOTE] **[TRACEBACK] 步骤锚点**
> - **原子规约**: [_共享规约/02_三位一体仓库规约](../../03_原子目标与规约/_共享规约/02_三位一体仓库规约.md)、[02_基础设施与部署规约](../../03_原子目标与规约/开发与交付/02_基础设施与部署规约.md)
> - **DNA stage_id**: `stage1_04`
> - **本步设计文档**: [04_密钥与配置模板设计](../../03_原子目标与规约/Stage1_仓库与骨架/04_密钥与配置模板设计.md#design-stage1-04-exit)
> - **本步 DNA 文件**: [dna_stage1_04.yaml](../../03_原子目标与规约/_System_DNA/Stage1_仓库与骨架/dna_stage1_04.yaml)

<a id="l4-step-nav"></a>
## 步骤导航
- **上一步**：[03_基础设施ECS与K3s就绪](03_基础设施ECS与K3s就绪.md#l4-stage1-03-goal)
- **下一步**：[01_基础设施与依赖部署](../Stage2_数据采集与存储/01_基础设施与依赖部署.md#l4-stage2-01-goal)

## 工作目录

**diting-infra** 根目录（.env.template 同时存在于 **diting-core** 根目录）

<a id="l4-stage1-04-goal"></a>
## 本步骤目标

引入 Sealed-Secrets（官方最新稳定版 Chart，放置于 diting-infra 约定路径如 `charts/dependencies/sealed-secrets`）；diting-infra secrets/ 含模板或说明；.env.template **双仓**占位（diting-core + diting-infra，不含真实 Key）；config 为**单一 YAML**（如 `config/environments/dev/deploy.yaml`）模板符合 deploy-engine DeploymentConfig。

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `dna_dev_workflow.workflow_stages[stage1_04]` | delivery_scope、exit_criteria、verification_commands、l5_stage_anchor |
| `global_const.trinity_repos.repo_a` | config 结构、deploy-engine 引用 |

## 核心指令

```
你是在 diting-infra 中执行 Stage1-04（密钥与配置模板就绪）的实践者。必读：03_原子目标与规约/_共享规约/02_三位一体仓库规约.md、03_原子目标与规约/开发与交付/02_基础设施与部署规约.md。
禁止写明文密钥。

任务：
1. 在 secrets/ 下建立 Sealed-Secrets 模板或 README 说明（如何生成加密 YAML）；Sealed-Secrets 使用官方最新稳定版 Chart，放入 charts/dependencies/sealed-secrets 或约定路径。
2. 在 diting-core 根目录与 diting-infra 根目录均添加 .env.template，仅含占位符（如 API_KEY=xxx、DB_URL=xxx）；应用相关以 diting-core 为权威，diting-infra 可多出 infra 专用项。
3. 确保 config/environments/dev/deploy.yaml（单一 YAML）符合 deploy-engine DeploymentConfig；diting-infra 通过 Git 引用 deploy-engine。
```

<a id="l4-stage1-04-exit"></a>
## 验证与准出

| 要求 | 验证步骤 | 目标结果 |
|------|----------|----------|
| Chart 模板参数生效 | `helm template <release> <chart_path> -f <values>`，检查渲染结果中关键 values（如 replicaCount、namespace） | 渲染结果与 values 一致 |
| 符合 deploy-engine | 使用 diting-infra 的 config 路径执行 deploy-engine 解析（或 -dry-run/等价），退出码 0 | 配置可被 deploy-engine 加载 |
| diting-infra Git 引用 deploy-engine | `git submodule status` 或 `test -d deploy-engine`；README 或 DNA 写明引用方式 | submodule 存在或路径存在且约定明确 |
| secrets 与 config | `test -d secrets`；`test -f config/environments/dev/deploy.yaml` | 目录与 YAML 存在 |
| .env.template 双仓无真实 Key | 检查 diting-core 与 diting-infra 根目录 .env.template | 仅占位符，无真实密钥 |

**准出**：secrets/ 含 Sealed-Secrets 模板或说明；config 单一 YAML 模板可用；三项验证（Chart 参数、deploy-engine、Git 引用）通过；.env.template 双仓就绪；**已更新 L5 [02_验收标准 对应行](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage1_04)**。

## 本步骤失败时

- **回退目标**：上一阶段最后一步（Stage1-03 准出）。
- **重试**：建议重试上限 3 次。
- **临时跳过**：须架构师或项目负责人审批；具体回退操作见 [03_ 工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md)。
