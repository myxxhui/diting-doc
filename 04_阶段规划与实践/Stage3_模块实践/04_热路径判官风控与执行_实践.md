# Stage3-04 热路径判官风控与执行

> [!NOTE] **[TRACEBACK] 战略追溯锚点**
> - **顶层概念**: [一句话定义与核心价值](../../01_顶层概念/01_一句话定义与核心价值.md)
> - **战略维度**: [01_产品设计维度](../../02_战略维度/产品设计/01_产品设计维度.md)
> - **原子能力**: [09_核心模块架构规约](../../03_原子目标与规约/_共享规约/09_核心模块架构规约.md)（热路径 D+E+F）、[01_核心公式与MoE架构规约](../../03_原子目标与规约/_共享规约/01_核心公式与MoE架构规约.md)、[05_接口抽象层规约](../../03_原子目标与规约/_共享规约/05_接口抽象层规约.md)
> - **DNA stage_id**: `stage3_04`
> - **本步设计文档**: [04_热路径判官风控与执行_设计](../../03_原子目标与规约/Stage3_模块实践/04_热路径判官风控与执行_设计.md#design-stage3-04-exit)
> - **本步 DNA 文件**: [04_dna_热路径判官风控与执行](../../03_原子目标与规约/_System_DNA/Stage3_模块实践/04_dna_热路径判官风控与执行.yaml)、[dna_module_d](../../03_原子目标与规约/_System_DNA/core_modules/dna_module_d.yaml)、[dna_module_e](../../03_原子目标与规约/_System_DNA/core_modules/dna_module_e.yaml)、[dna_module_f](../../03_原子目标与规约/_System_DNA/core_modules/dna_module_f.yaml)
> - **阶段**: [Stage3_模块实践](README.md)

**逻辑填充期接入点**：PyPortfolioOpt（判官）、Vn.py（执行），见设计文档 [design-stage3-04-integration-pfo](../../03_原子目标与规约/Stage3_模块实践/04_热路径判官风控与执行_设计.md#design-stage3-04-integration-pfo)、[design-stage3-04-integration-vnpy](../../03_原子目标与规约/Stage3_模块实践/04_热路径判官风控与执行_设计.md#design-stage3-04-integration-vnpy)。

<a id="l4-step-nav"></a>
## 步骤导航
- **上一步**：[03_MoE议会](03_MoE议会_实践.md#l4-stage3-03-goal)
- **下一步**：[05_全链路验证](05_全链路验证_实践.md#l4-stage3-05-goal)

> [!IMPORTANT] **实践测试方式约定**
> 本步以**本地 Docker Compose**（或等价本地环境）为**主要（默认）**实践测试方式，可选 K3s/实盘；无云凭证或无需真实集群时**优先**使用本地 Compose 完成验收。见 [00_系统规则_通用项目协议](../../00_系统规则_通用项目协议.md)、[02_三位一体仓库规约](../../03_原子目标与规约/_共享规约/02_三位一体仓库规约.md)#本地开发与部署文件。

<a id="l4-stage3-04-goal"></a>
## 步骤目标

在一个实践步骤内实现**热路径**可部署单元：Module D 判官 + Module E 风控盾 + Module F 执行网关（同进程、同镜像）；完成 D/E/F **四项 100% 验证**及全链路 A→F 验证。

## 本步骤落实的 DNA 键

- `core_modules/dna_module_d.yaml`：投票、凯利、Cash Drag、Defensive、PyPortfolioOpt
- `core_modules/dna_module_e.yaml`：硬止损、盈亏比、相关性
- `core_modules/dna_module_f.yaml`：Broker 抽象、Gateway、Vn.py

## 实现部分

**工作目录**：`diting-core`

1. **判官（D）**：建立 `diting/gavel`（或约定包）；投票+Kelly+Cash Drag+Defensive；公式与阈值写 YAML；双轨分流按 09_；PyPortfolioOpt 组合优化与仓位闭环。
2. **风控（E）**：建立 `diting/risk`，RiskShield；硬止损 2%、盈亏比≥1.5、组合相关性；规则写 YAML。
3. **执行（F）**：建立 `diting/execution` 或 `diting/drivers`；BrokerDriver 与占位/仿真；Redis Streams、OMS Lite、Human-in-the-Loop；Vn.py Gateway 式接口。
4. **同镜像**：热路径 D+E+F 同进程构建，Dockerfile/requirements 含上述依赖；镜像内判官、风控、place_order 单测通过。

## 验证部分

### 四项 100%（D、E、F 各维度）

| 维度 | 验收标准 | 验证方法 |
|------|----------|----------|
| **接口/结构/逻辑/测试** | D/E/F 分别满足 09_ 与设计文档 | 契约单测、Table-Driven、make test |
| **全链路** | A→F 可跑通 | 全链路测试或主路径执行 |

### 三层验证

- **单模块**：判官、风控、Broker 占位各自单测
- **联动**：D→E→F 联调
- **全链路**：A→F 验证在本步准出时执行

## 核心指令（The Prompt）

```
你是在 diting-core 中实现热路径（判官+风控+执行）的开发者。必读：09_核心模块架构规约（Module D/E/F）、01_核心公式与MoE架构规约、05_接口抽象层规约、core_modules/dna_module_d/e/f.yaml、04_热路径判官风控与执行_设计.md。

任务：1. 实现判官（投票+Kelly+Cash Drag+Defensive+PyPortfolioOpt）；2. 实现风控 RiskShield（硬止损/盈亏比/相关性）；3. 实现执行 Broker 抽象与占位（Vn.py Gateway 式）；4. 公式与规则写 YAML；5. 同镜像内 D+E+F 单测与全链路 A→F 验证通过。

工作目录：diting-core。代码含 [Ref: 04_热路径判官风控与执行]。
```

<a id="l4-stage3-04-exit"></a>
## 验收与测试、DoD、本步骤失败时

L3 逻辑填充期接入点（PyPortfolioOpt、Vn.py）按设计文档达标；L5 [l5-mod-D](../../05_成功标识与验证/02_验收标准.md#l5-mod-D)、[l5-mod-E](../../05_成功标识与验证/02_验收标准.md#l5-mod-E)、[l5-mod-F](../../05_成功标识与验证/02_验收标准.md#l5-mod-F)、[l5-stage-stage3_04](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage3_04) 已更新；**全链路 A→F 验证**在本步准出时执行。
