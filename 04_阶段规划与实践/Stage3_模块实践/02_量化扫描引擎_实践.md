# Stage3-02 Module B 量化扫描引擎

> [!NOTE] **[TRACEBACK] 战略追溯锚点**
> - **顶层概念**: [一句话定义与核心价值](../../01_顶层概念/01_一句话定义与核心价值.md)
> - **战略维度**: [01_产品设计维度](../../02_战略维度/产品设计/01_产品设计维度.md)
> - **原子能力**: [09_核心模块架构规约](../../03_原子目标与规约/_共享规约/09_核心模块架构规约.md)（Module B）、[QuantSignal Proto](../../03_原子目标与规约/_Design_Artifacts/protocols/quant/quant_signal.proto)
> - **DNA stage_id**: `stage3_02`
> - **本步设计文档**: [02_量化扫描引擎_设计](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-exit)
> - **本步 DNA 文件**: [02_dna_量化扫描引擎](../../03_原子目标与规约/_System_DNA/Stage3_模块实践/02_dna_量化扫描引擎.yaml)、[dna_module_b.yaml](../../03_原子目标与规约/_System_DNA/core_modules/dna_module_b.yaml)
> - **阶段**: [Stage3_模块实践](README.md)

**逻辑填充期接入点**：本步须按设计文档中「逻辑填充期开源接入点」小节实现并达标：[TA-Lib](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-talib)、[Qlib](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-qlib)、[VectorBT](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-vectorbt)、[Alphalens](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-alphalens)。

<a id="l4-step-nav"></a>
## 步骤导航
- **上一步**：[01_语义分类器_实践](01_语义分类器_实践.md#l4-stage3-01-goal)
- **下一步**：[03_MoE议会_实践](03_MoE议会_实践.md#l4-stage3-03-goal)

> [!IMPORTANT] **实践测试方式约定**
> 本步以**本地 Docker Compose**（或等价本地环境）为**主要（默认）**实践测试方式，可选 K3s/实盘；无云凭证或无需真实集群时**优先**使用本地 Compose 完成验收。见 [00_系统规则_通用项目协议](../../00_系统规则_通用项目协议.md)、[02_三位一体仓库规约](../../03_原子目标与规约/_共享规约/02_三位一体仓库规约.md)#本地开发与部署文件。

---

## 上下游关系总览

本步**消耗** Stage3-01 准出（语义分类器、Domain Tag 可产出）、Stage2-05 准出（L1 OHLCV 可写入并可被读取）；**产出** Module B 量化扫描引擎实现（`diting/scanner` 或 `diting/strategy` 包、策略池 YAML 配置、QuantScanner、单测与四项 100% 验证），供 Stage3-03（MoE 议会）、Module D 及热路径 A→F 全链路使用。

---

## 关键下游依赖（来自 Stage3-01 / Stage2）

| 依赖项 | 说明 | 本步用法 |
|--------|------|----------|
| **Stage3-01 准出** | Module A 语义分类器可产出 Domain Tag | Module B 输入：标的池 + Domain Tag（可选按板块过滤）；A+B 联调时 B 消费 A 输出 |
| **L1 OHLCV** | Stage2 采集写入 L1 表 `ohlcv`；MarketDataFeed 或等价可读 | 扫描引擎输入：标的池、OHLCV 序列；s0_data 准出后用真实数据，否则可 Mock 验证接口与结构 |
| **配置与 Proto** | QuantSignal.proto、dna_module_b 的 strategy_pools / scanner 阈值 | 输出契约、YAML 策略池与阈值、technical_score_threshold、sector_strength_threshold 从 DNA/设计引用 |

---

<a id="l4-stage3-02-verify-routes"></a>
## 验证路线说明（必读）

| 路线 | 说明 | 适用场景 |
|------|------|----------|
| **默认：Docker Compose / 本地** | 在 **diting-core** 本地或 Compose 环境安装 TA-Lib（系统层 C 库 + Python 绑定）、Qlib、VectorBT、Alphalens；执行 `make test`、单测、扫描验证；**镜像内** `make test` 通过。 | 日常开发、CI、无云凭证时；**推荐作为默认验收路径**。 |
| **可选：K3s / 实盘** | 在已就绪的 K3s 或实盘环境中部署/运行扫描服务；B 输出作为 D 输入做 A+B 或 A→F 联调。 | 需要与真实集群、Module D 联调时。 |

**填写约定**：在 [验证项与结果清单](#l4-stage3-02-verify-checklist)、[本步实践总结](#l4-stage3-02-summary) 的备注或「是否符合预期」中注明本次采用的路线（如「默认本地/Compose」或「可选 K3s」），便于追溯。**真实数据不可用时**：可 Mock OHLCV 验证接口与结构、YAML 加载、四项 100% 中的接口/结构/代码测试；在文档中标注「待 s0_data 准出后补验真实市场扫描」。

---

<a id="l4-stage3-02-deps-check"></a>
## 本步依赖检查与关键参数获取

执行本步前，须按所选验证路线准备环境。

### 1. 上游准出检查清单

| 检查项 | 说明 | 本步用途 |
|--------|------|----------|
| **Stage3-01 准出** | Module A 实现存在；ClassifierOutput / Domain Tag 可被调用 | A+B 联调时 B 消费 A 输出；单模块验证可先不依赖 |
| **L1 OHLCV 可用** | Stage2-05 准出；`make ingest-test` 已写 L1；或本地/Compose 下 L1 可读 | 真实数据扫描；若不可用则 Mock 验证并标注待补验 |
| **Proto 与 DNA** | QuantSignal.proto、dna_module_b.yaml 路径与键存在 | 输出契约、strategy_pools、scanner 阈值、integration_packages |

### 2. 关键参数与配置来源

| 参数/配置 | 说明 | 获取方式 |
|-----------|------|----------|
| **策略池与阈值** | strategy_pools（Trend/Reversion/Breakout）、technical_score_threshold、sector_strength_threshold | 从 [dna_module_b.yaml](../../03_原子目标与规约/_System_DNA/core_modules/dna_module_b.yaml) 或本步 YAML 配置加载；禁止硬编码 |
| **OHLCV 数据源** | L1 表 `ohlcv` 或 MarketDataFeed | Stage2 部署后由 TIMESCALE_DSN / 约定 API 读取；Mock 时用固定序列 |
| **integration_packages** | TA-Lib、qlib、vectorbt、alphalens | DNA `core_modules/dna_module_b.yaml#integration_packages`；须在 Dockerfile/requirements 显式安装 |

### 3. 依赖与构建（与设计一致）

- **TA-Lib**：需先安装系统层 ta-lib C 库，再 pip install TA-Lib；Dockerfile 中需显式步骤。
- **Qlib / VectorBT / Alphalens**：Python 包，在 requirements 中列出并在 Dockerfile 中安装。
- 构建后 **镜像内** `make test` 及本步单测须可运行（见 [设计-依赖与构建](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-deps)）。

---

## 工作目录

**diting-core**（与 DNA `work_dir` / `repo_i` 一致）

---

<a id="l4-stage3-02-goal"></a>
## 本步骤目标

实现 Module B 量化扫描引擎，满足 09_ 规约的三大策略池、technical_score > 70、sector_strength > 1.1；完成 **四项 100% 验证**（接口、结构、逻辑功能、代码测试）；逻辑填充期接入点 TA-Lib、Qlib、VectorBT、Alphalens 按设计文档对应小节达标。

**执行指引**（三者关系）：
- **功能实践项清单**（F1～F10）= 本步交付项；执行时勾选「已实现 / 未实现」及代码位置。
- **验证项与结果清单**（V-IFACE / V-STRUCT / V-LOGIC / V-TEST / V-IMAGE）= 本步**唯一**测试结果填写处；按 [本步实践总结](#l4-stage3-02-summary) 步骤表顺序执行，每完成一步即在验证清单填写对应行。
- **本步实践总结步骤表** = 推荐执行顺序；步骤与验证项一一对应。

---

## 本步骤落实的 _System_DNA 键

| DNA 键 | 用途 |
|--------|------|
| `02_dna_量化扫描引擎.yaml` | stage_id、work_dir、delivery_scope、exit_criteria、l5_stage_anchor、logic_fill_design_refs、integration_packages_ref |
| `core_modules/dna_module_b.yaml` | `module_b_quant_engine.strategy_pools`（三大策略池）、`scanner.technical_score_threshold`、`scanner.sector_strength_threshold`、`integration_packages`（TA-Lib、qlib、vectorbt、alphalens） |

---

<a id="l4-stage3-02-impl"></a>
## 实现要求与逻辑细节

### 1. 目录与包结构

| 要求 | 说明 | 与 DNA/规约一致性 |
|------|------|-------------------|
| 包路径 | 在 diting-core 下建立 `diting/scanner` 或 `diting/strategy` 包 | 与 09_ Module B、DNA delivery_scope 一致 |
| 配置路径 | 策略池与阈值使用 YAML 配置（路径与设计/DNA 约定一致） | 阈值与条件不硬编码，由 YAML 驱动 |

### 2. 接口与契约

| 项目 | 要求 | 规约与设计引用 |
|------|------|----------------|
| 输入 | 标的池、OHLCV（L1 或 MarketDataFeed）；可选 Module A 的 Domain Tag | [09_ Module B](../../03_原子目标与规约/_共享规约/09_核心模块架构规约.md)、[dna_module_b](../../03_原子目标与规约/_System_DNA/core_modules/dna_module_b.yaml) |
| 输出 | `QuantSignal` 列表：technical_score、strategy_source、sector_strength 等，符合 QuantSignal.proto | [QuantSignal.proto](../../03_原子目标与规约/_Design_Artifacts/protocols/quant/quant_signal.proto)；可被 Module C/D 消费 |
| 实现类 | `QuantScanner`，提供扫描接口，输入标的池与 OHLCV，输出 QuantSignal 列表 | 09_ 规约、设计文档 [设计要点](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-points) |

### 3. 策略池与 YAML 配置

三大策略池（Trend / Reversion / Breakout）及阈值须由 **YAML 配置** 驱动，与 `dna_module_b.strategy_pools`、`scanner` 语义一致：

| 策略池 | 条件描述（DNA） | 实现要点 |
|--------|-----------------|----------|
| **趋势** | 均线多头排列、MACD 水上金叉等 | 指标用 TA-Lib；条件与 score_range 写 YAML |
| **反转** | RSI&lt;20、价格触及 Bollinger 下轨等 | 同上 |
| **突破** | 价格突破 N 日高点、成交量&gt;2x 均量等 | 同上 |

- technical_score_threshold（如 70）、sector_strength_threshold（如 1.1）从配置或 DNA 引用，禁止硬编码。
- 配置变更后，扫描结果或过滤结果应随之变化（**逻辑功能 100%** 验证项之一）。

### 4. 依赖与构建（部署配套）

- 在 **Dockerfile / requirements** 中显式安装：**TA-Lib**（系统层 C 库 + Python 绑定）、**Qlib**、**VectorBT**、**Alphalens**（见 [设计-依赖与构建](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-deps) 与 dna_module_b.integration_packages）。
- 镜像构建后，**镜像内** `make test` 及本步单测须可运行。

### 5. 逻辑填充期开源接入点（必读设计文档小节）

| 接入点 | 实践重点 | 验收要点 |
|--------|----------|----------|
| **TA-Lib** | 全部技术指标（MACD、RSI、Bollinger 等）统一基于 TA-Lib；策略池与 TA-Lib API 映射明确 | 至少一策略池指标 100% 来自 TA-Lib；单测固定 OHLCV 与已知结果对比 |
| **VectorBT** | 全市场粗筛、向量化；technical_score_threshold、sector_strength_threshold 对应 | 给定规模跑通粗筛，输出候选池格式符合下游契约；性能可约定（如 &lt;30 分钟） |
| **Qlib** | YAML 配置驱动、数据/因子管道、回测流程（Phase2 扩展） | 修改 YAML 可重放回测；数据/因子管道有单测或小规模集成测 |
| **Alphalens** | 策略池/因子上线前质检：IC、分层收益、换手率、tear sheet（Phase2 扩展） | 至少一策略池走通「因子→Alphalens→tear sheet→准出判断」 |

详细需求与验收见设计文档 [TA-Lib](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-talib)、[Qlib](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-qlib)、[VectorBT](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-vectorbt)、[Alphalens](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-alphalens)。

<a id="l4-stage3-02-deploy-chain"></a>
### 6. 单独运行、Dockerfile、镜像与版本管理、一键构建、一键部署

Module B 为**独立可部署单元**（见 [09_ 可部署单元清单](../../03_原子目标与规约/_共享规约/09_核心模块架构规约.md#可部署单元清单)、[global_const.deployable_units.module_b](../../03_原子目标与规约/_System_DNA/global_const.yaml)），须支持**单独运行**、镜像构建与部署链，与 [01_语义分类器_实践](01_语义分类器_实践.md)、Stage2 采集模块实践方式对齐。

| 实践项 | 要求 | 与 DNA/规约一致 |
|--------|------|-----------------|
| **单独运行** | Module B 可作为独立服务运行：提供 CLI 或 HTTP/gRPC 入口（如 `python -m diting.scanner.run` 或等价）；本地或镜像内执行同一入口即可跑扫描服务；可消费 L1 OHLCV（TIMESCALE_DSN 等由环境变量或 Secret 注入） | 09_ Module B 独立服务、镜像与验证链独立 |
| **Dockerfile** | 路径：`diting-core/docker/module_b`（与 `global_const.deployable_units.module_b.dockerfile_path` 一致）；多阶段构建、**先安装系统层 ta-lib C 库再** pip install TA-Lib、qlib、vectorbt、alphalens，COPY 代码与策略池 YAML、设置 ENTRYPOINT/CMD；不硬编码业务密钥 | DNA dockerfile_path、[设计-依赖与构建](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-deps) |
| **镜像与版本管理** | 镜像名：`diting-module-b`（可加 registry 前缀）；Tag 策略：dev 用 git-sha 或 latest、prod 用 SemVer；与 [dna_dev_workflow.release_bundle](../../03_原子目标与规约/_System_DNA/dna_dev_workflow.yaml)（tag_strategy: git_sha_or_semver）一致；同一 Release 内与其它可部署单元同 tag | global_const.deployable_units.module_b、release_bundle |
| **一键构建** | Makefile 提供 `make build-module-b`（或 `make build-images` 含 module_b）；在 **diting-core** 执行，产出可运行镜像；构建后可在**镜像内**执行 `make test` 或等价验证（V-IMAGE） | 与 Stage2-02 V-BUILD-ALL、01_语义分类器 一键构建对齐 |
| **一键部署** | **diting-infra** 侧 Chart：`diting-infra/charts/module_b`（与 `global_const.deployable_units.module_b.chart_path` 一致）；提供 `make deploy-module-b` 或等价 Helm 部署命令；依赖 K3s 与 Stage2-05 准出后可部署；本地开发期可用 Compose 或单容器 run 验证 | DNA chart_path；部署为可选路线，与 Stage2-05 后 K3s 部署一致 |

**说明**：镜像内须能执行扫描逻辑（含加载策略池 YAML、TA-Lib/VectorBT 等）；若需连 L1，通过环境变量（如 `TIMESCALE_DSN`）或 Secret 注入，不写死镜像内。

---

## 核心指令（The Prompt）

```
你是在 diting-core 中实现 Module B 量化扫描引擎的开发者。必读：03_原子目标与规约/_共享规约/09_核心模块架构规约.md（Module B 小节）、03_原子目标与规约/_System_DNA/core_modules/dna_module_b.yaml、QuantSignal.proto（或 diting-core 内等价路径）。

任务：1. 实现 QuantScanner，输入标的池与 OHLCV，输出 QuantSignal 列表（technical_score、strategy_source、sector_strength）；2. 按设计文档「逻辑填充期开源接入点：TA-Lib、Qlib、VectorBT、Alphalens」小节实现并达标（实践重点、详细需求、验收要点见该设计文档）；3. 三大策略池与阈值写 YAML，禁止硬编码；4. 单测覆盖 TREND/REVERSION/BREAKOUT 及过滤逻辑；5. 用真实 OHLCV 验证（若 s0_data 已准出），否则 Mock 验证接口与结构；6. 在 Dockerfile/requirements 中按 design 与 DNA 安装 TA-Lib（含系统层 C 库）、Qlib、VectorBT、Alphalens；镜像内 make test 及本步单测通过。

工作目录：diting-core。约束：阈值与策略条件不硬编码；代码含 [Ref: 02_量化扫描引擎]。
```

---

<a id="l4-stage3-02-feature-checklist"></a>
## 功能实践项清单（执行时勾选）

下表为本步**全部功能/交付项**；执行者须逐项标注「实践状态」与「说明」，与设计文档、DNA 一致。

| 功能项 ID | 功能描述 | 对应设计/DNA | 实践状态 | 说明/代码位置 |
|-----------|----------|--------------|----------|----------------|
| F1 | 建立 diting/scanner 或 diting/strategy 包，实现 QuantScanner | 09_ Module B、design 设计要点 | 待实现 | |
| F2 | 接口：输入标的池、OHLCV；输出 QuantSignal 列表（technical_score、strategy_source、sector_strength） | QuantSignal.proto、dna_module_b.scanner | 待实现 | |
| F3 | 三大策略池（Trend/Reversion/Breakout）与阈值由 YAML 配置驱动 | dna_module_b.strategy_pools、scanner 阈值 | 待实现 | |
| F4 | 技术指标统一基于 TA-Lib（MACD、RSI、Bollinger 等） | [设计-TA-Lib](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-talib) | 待实现 | |
| F5 | VectorBT 用于全市场粗筛（或等价向量化）；输出候选池符合下游契约 | [设计-VectorBT](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-vectorbt) | 待实现 | |
| F6 | Qlib 配置驱动/回测（Phase2 扩展；本阶段可占位或最小实现） | [设计-Qlib](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-qlib) | 待实现 | |
| F7 | Alphalens 策略池/因子上线前质检（Phase2 扩展；本阶段可占位或最小实现） | [设计-Alphalens](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-integration-alphalens) | 待实现 | |
| F8 | Dockerfile/requirements 显式 TA-Lib、qlib、vectorbt、alphalens；镜像内 make test 通过 | dna_module_b.integration_packages、[设计-依赖与构建](../../03_原子目标与规约/Stage3_模块实践/02_量化扫描引擎_设计.md#design-stage3-02-deps) | 待实现 | |
| F9 | 单测覆盖三策略池与过滤逻辑；make test 覆盖率达标 | 四项 100% 之代码测试 100% | 待实现 | |
| F10 | 单独运行、Dockerfile、镜像与版本管理、一键构建、一键部署（与 [§6 单独运行…](#l4-stage3-02-deploy-chain) 及 deployable_units.module_b 一致） | 09_ Module B 可部署单元、global_const.deployable_units.module_b | 待实现 | |

**填写约定**：实践状态三选一（待实现 / 已实现 / 不适用）；说明/代码位置填仓库路径或简短结论。准出时 F1～F10 须均为「✅ 已实现」（F6/F7 若为 Phase2 占位可按项目约定标为「已占位」并说明）。

---

<a id="l4-stage3-02-verify-checklist"></a>
<a id="l4-stage3-02-exit"></a>
## 验证项与结果清单（本步唯一测试结果填写处）

下表为本步**全部验证项**：命令、工作目录、期望结果与**结果填写**合一。执行顺序按 [本步实践总结](#l4-stage3-02-summary) 步骤表；每完成一步即在对应行填写「测试结果」与「实际输出或备注」。

| 验证项 ID | 验证内容 | 命令/方式 | 工作目录 | 期望结果 | 测试结果 | 实际输出或备注 |
|-----------|----------|-----------|----------|----------|----------|----------------|
| V-IFACE | 接口 100%：输出符合 QuantSignal.proto；可被 D/C 消费 | Proto 契约单测；或集成测输出 schema 校验 | diting-core | 单测/集成测通过；输出字段与 Proto 一致 | 待测 | |
| V-STRUCT | 结构 100%：目录、配置与 DNA 一致 | 目录存在、config 可加载；YAML 与 dna_module_b 键对应 | diting-core | 包与配置路径存在；加载无报错 | 待测 | |
| V-LOGIC | 逻辑功能 100%：策略池与阈值由 YAML 驱动；真实数据扫描或 Mock 扫描 | 配置变更验证；真实/Mock 市场扫描结果 | diting-core | 改 YAML 后结果变化；technical_score、sector_strength 符合阈值逻辑 | 待测 | |
| V-TEST | 代码测试 100%：单测覆盖三策略池、过滤逻辑 | `make test` | diting-core | 退出码 0；覆盖率达标（或项目约定） | 待测 | |
| V-IMAGE | 镜像内可运行单测与 make test | 构建镜像后，在**容器内**执行 `make test` | — | 退出码 0；依赖链在镜像内完整 | 待测 | |

**准出**：① F1～F10 均为「✅ 已实现」（或 F6/F7 已占位）；② 上表五行测试结果均为「通过」；③ 已更新 L5 [l5-mod-B](../../05_成功标识与验证/02_验收标准.md#l5-mod-B)、[l5-stage-stage3_02](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage3_02)。

### 三层验证（单模块 → 联动 → 全链路）

- **单模块**：全市场或子集真实/Mock 数据扫描，输出 technical_score > 70 的候选。
- **联动**：B 输出作为 D 输入，A+B 联调。
- **全链路**：参与 A→F 全链路验证。

---

<a id="l4-stage3-02-summary"></a>
## 本步实践总结

按下列步骤表顺序执行；**步骤 2～6 分别对应验证项 V-IFACE、V-STRUCT、V-LOGIC、V-TEST、V-IMAGE**。每完成一步请在 [验证项与结果清单](#l4-stage3-02-verify-checklist) 填写对应行，**本表只填「是否符合预期」**，不必重复填写实践结果。

| 步骤 | 执行内容 | 预期结果 | 对应验证项 | 是否符合预期 |
|------|----------|----------|------------|----------------|
| 1 | 确认 Stage3-01、Stage2 L1 依赖（或 Mock 策略）；核对 [本步依赖检查与关键参数获取](#l4-stage3-02-deps-check) | 依赖与数据来源清晰 | — | |
| 2 | 实现 QuantScanner 与 QuantSignal 契约；Proto 单测或等价校验 | 输出符合 QuantSignal.proto；可被下游消费 | V-IFACE | |
| 3 | 建立包与 YAML 配置；策略池与阈值从配置加载；目录与 DNA 一致 | 配置可加载；无硬编码阈值 | V-STRUCT | |
| 4 | 实现三大策略池（TA-Lib 指标）+ VectorBT 粗筛；配置变更验证；真实/Mock 扫描 | 策略池与阈值由 YAML 驱动；扫描结果符合阈值逻辑 | V-LOGIC | |
| 5 | 单测覆盖 TREND/REVERSION/BREAKOUT 及过滤逻辑；执行 `make test` | 退出码 0；覆盖率达标 | V-TEST | |
| 6 | Dockerfile/requirements 安装 TA-Lib、Qlib、VectorBT、Alphalens；构建镜像并在**容器内**执行 `make test` | 退出码 0；镜像内依赖完整 | V-IMAGE | |
| 7 | 按 [§6 单独运行、Dockerfile、镜像与版本管理、一键构建、一键部署](#l4-stage3-02-deploy-chain)：提供 `make build-module-b`（或 build-images 含 module_b）；可选 diting-infra 侧 `make deploy-module-b` | 一键构建产出 diting-module-b 镜像；可选一键部署到 K3s | F10 | |

**说明**：步骤 2～5 可在本地 diting-core 完成；步骤 6～7 需构建镜像并可选部署。真实数据不可用时，步骤 4 可用 Mock OHLCV 验证逻辑并标注「待 s0_data 准出后补验」。

---

## 验收与准出

- [ ] 接口 100%、结构 100%、逻辑功能 100%、代码测试 100%
- [ ] `make test` 通过（含镜像内）
- [ ] L5 [l5-mod-B](../../05_成功标识与验证/02_验收标准.md#l5-mod-B)、[l5-stage-stage3_02](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage3_02) 已更新

<a id="l4-stage3-02-exit-dod"></a>
## 本步骤准出（DoD）

- 代码提交；单测全绿；L3 逻辑填充期接入点（TA-Lib、Qlib、VectorBT、Alphalens）按设计文档达标；L5 [l5-mod-B](../../05_成功标识与验证/02_验收标准.md#l5-mod-B)、[l5-stage-stage3_02](../../05_成功标识与验证/02_验收标准.md#l5-stage-stage3_02) 已更新；[02_战略追溯矩阵](../../06_追溯与审计/02_战略追溯矩阵.md) 可交付性等行已同步（若适用）。

### 准出后自检（执行方完成，无需读者再执行）

| 自检项 | 说明 |
|--------|------|
| 四项 100% 与 V-IFACE～V-IMAGE | 验证项与结果清单中五行均为「通过」 |
| L5 与 06_ 已同步 | 已更新 02_验收标准 中 l5-mod-B、l5-stage-stage3_02 行及 02_战略追溯矩阵 对应备注 |
| 镜像内 make test | 已在构建后的镜像内执行 `make test` 且退出码 0 |

---

## 本步骤失败时

- **扫描超时**：分批扫描或缩小 universe；或约定超时与降级策略（见 09_ 或设计文档）。
- **真实数据不可用**：用 Mock OHLCV 验证接口与结构、YAML 加载、单测；在文档中标注「待 s0_data 准出后补验真实市场扫描」。
- **依赖安装失败（如 TA-Lib）**：确认系统层 ta-lib C 库已安装，再 pip install；Dockerfile 中分步安装并验证。
- **回退目标**：回退到 Stage3-01 准出；具体回退操作见 [03_ 工作流详细规划 八、失败与回退策略](../../03_原子目标与规约/开发与交付/03_项目全功能开发测试实践工作流详细规划.md)。

---

> [!NOTE] **一致性检查表（§7.5 / §8.8）**
> - [ ] 本步骤明确工作目录（diting-core）
> - [ ] 关键节含 [TRACEBACK] 及 l4-stage3-02-goal / l4-stage3-02-exit 锚点；步骤导航带 #
> - [ ] 「本步骤落实的 _System_DNA 键」已列出且与 DNA 一致
> - [ ] 可执行验证清单（V-IFACE～V-IMAGE）与 Makefile/镜像内 make test 一致
> - [ ] 核心指令内对 03_/DNA/Proto 引用为完整路径或键路径，AI 可读
> - [ ] 本步设计文档 / DNA 引用带 # 深链（design-stage3-02-*、l5-mod-B、l5-stage-stage3_02）
